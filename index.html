<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<!-- CRITICAL: Load state before any rendering -->
<script src="js/instantHydration.js"></script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>Task Monsters v3.31</title>
<!-- PWA Manifest -->
<link href="manifest.json?v=1757559779" rel="manifest"/>
<!-- PWA Meta Tags -->
<meta content="#111111" name="theme-color"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="default" name="apple-mobile-web-app-status-bar-style"/>
<meta content="Task Monsters" name="apple-mobile-web-app-title"/>
<meta content="Task Monsters" name="application-name"/>
<meta content="#9AE34A" name="msapplication-TileColor"/>
<!-- Icons for Browser Tabs and Mobile -->
<link href="assets/logo/favicon.png" rel="icon" sizes="16x16" type="image/png"/>
<link href="assets/logo/favicon.png" rel="icon" sizes="32x32" type="image/png"/>
<link href="assets/logo/favicon.png" rel="icon" sizes="48x48" type="image/png"/>
<link href="assets/logo/favicon.png" rel="icon" sizes="96x96" type="image/png"/>
<link href="assets/logo/favicon.png" rel="icon" sizes="192x192" type="image/png"/>
<link href="assets/logo/favicon.png" rel="apple-touch-icon" sizes="180x180"/>
<link href="assets/logo/favicon.png" rel="shortcut icon"/>
<!-- SEO Meta Tags -->
<meta content="Task Monsters - An RPG productivity game with your virtual monster companion" name="description"/>
<meta content="task manager, productivity, monsters, tasks, todo, rpg" name="keywords"/>
<meta content="Task Monsters" name="author"/>
<!-- Open Graph Meta Tags -->
<meta content="Task Monsters - RPG Productivity Game" property="og:title"/>
<meta content="A fun task management app with your virtual monster companion" property="og:description"/>
<meta content="assets/images/icon-512x512.png" property="og:image"/>
<meta content="https://storygrid00.github.io/Task_Rock" property="og:url"/>
<meta content="website" property="og:type"/>
<!-- Twitter Card Meta Tags -->
<meta content="summary_large_image" name="twitter:card"/>
<meta content="Task Monsters - RPG Productivity Game" name="twitter:title"/>
<meta content="A fun task management app with your virtual monster companion" name="twitter:description"/>
<meta content="assets/images/icon-512x512.png" name="twitter:image"/>
    <link href="assets/css/special-attacks.css" rel="stylesheet"/>

<style>
        :root {
    /* Daily Challenge complete color */
    --challenge-complete: #ccff00; /* neon green-yellow */

            /* Quick Task action button background token */
            --quick-action-bg: #ffffff;
            /* Daily Challenge (scoped) */
            --daily-card-purple: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --daily-card-green:  linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            --daily-card-orange-gradient: linear-gradient(135deg, #ea580c 0%, #f59e0b 100%);
            --daily-card-pink: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            --daily-card-blue: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            --daily-card-teal: linear-gradient(135deg, #14b8a6 0%, #2dd4bf 100%);
            --daily-card-red: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            --daily-card-yellow: linear-gradient(135deg, #eab308 0%, #facc15 100%);
        
            /* Dark theme colors (default and only) */
            --bg-primary: #f8f9fa;
            --bg-secondary: white;
            --bg-tertiary: #e0e0e0;
            --text-primary: #333;
            --text-secondary: #666;
            --text-tertiary: #999;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --modal-overlay: rgba(0, 0, 0, 0.5);
            --scrollbar-track: #f9fafb;
            --scrollbar-thumb: #d1d5db;
            --scrollbar-thumb-hover: #9ca3af;
            --health-bar-bg: #e0e0e0;
            --section-bg: white;
            --task-item-bg: white;
            --button-hover-bg: #f0f0f0;
            --congrats-bg: white;
            --achievement-locked-bg: #f5f5f5;
            --achievement-locked-text: #999;
            
            /* Modern additions */
            --accent-primary: #6366f1;
            --accent-secondary: #7c3aed;
            --accent-tertiary: #8b5cf6;
            --border-light: #e8eaed;
            --border-medium: #dadce0;
            --border-dark: #c4c7cc;
            --success: #34d399;
            --warning: #fbbf24;
            --error: #f87171;
            --info: #60a5fa;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 9999px;
            --transition-fast: 0.15s ease-out;
            --transition-normal: 0.25s ease-out;
            --transition-slow: 0.35s ease-out;
        }

        [data-theme="dark"] {
            --quick-action-bg: #0f1611;
            /* Dark theme colors (Task Rock dark per screenshot) */
            --bg-primary: #101712;
            --bg-secondary: #101712;
            --bg-tertiary: #101712;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-tertiary: #999999;
            --border-color: #404040;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --accent-primary: #6366f1;
            --accent-secondary: #7c3aed;
            --accent-tertiary: #8b5cf6;
            --border-light: #223127;
            --border-medium: #1b271f;
            --border-dark: #132018;
            --scrollbar-track: #2d2d2d;
            --scrollbar-thumb: #555555;
            --scrollbar-thumb-hover: #777777;
            --health-bar-bg: #404040;
            --section-bg: #101712;
            --task-item-bg: #101712;
            --button-hover-bg: #1a241d;
            --congrats-bg: #101712;
            --achievement-locked-bg: #333333;
            --achievement-locked-text: #666666;
            --border-light: #374151;
            --border-medium: #4b5563;
            --border-dark: #6b7280;
            --shadow-sm: 0 1px 2px 0 rgba(255, 255, 255, 0.03);
            --shadow-md: 0 4px 6px -1px rgba(255, 255, 255, 0.06), 0 2px 4px -1px rgba(255, 255, 255, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(255, 255, 255, 0.06), 0 4px 6px -2px rgba(255, 255, 255, 0.03);
            --shadow-xl: 0 20px 25px -5px rgba(255, 255, 255, 0.06), 0 10px 10px -5px rgba(255, 255, 255, 0.03);
        }

        /* Speech bubble removed - replaced with tooltip system */
        


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Rounded', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 420px;
            margin: 0 auto;
            background: var(--bg-secondary);
            min-height: 100vh;
            position: relative;
            box-shadow: var(--shadow-xl);
        }

        /* Pet Rock Header with Theme Background */
        .pet-rock-header {
            background: var(--bg-secondary);
            padding: 24px 20px;
            text-align: center;
            position: relative;
            border-bottom: 1px solid var(--border-light);
        }

        /* Brand logo styling */
        .app-title {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 0 16px;
        }

        .brand-logo {
            height: 60px;
            width: auto;
            display: block;
            margin: 0 auto;
        }

        .brand-logo.dark {
            display: none;
        }

        @media (min-width: 640px) {
            .brand-logo {
                height: 80px;
            }
        }

        [data-theme="dark"] .brand-logo.light {
            display: none;
        }

        [data-theme="dark"] .brand-logo.dark {
            display: block;
        }

        .creature-container {
            position: relative;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Task Pal Tooltip */
        .task-pal-tooltip {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.98);
            color: #ffffff;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 10px 30px;
            border-radius: 12px;
            text-align: center;
            white-space: normal;
            /* Horizontal landscape format: width is 2.5x height */
            min-width: 300px;
            max-width: 500px;
            max-height: 80px;
            width: auto;
            pointer-events: auto;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            display: none;
            z-index: 200;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5), 0 0 0 2px rgba(255, 255, 255, 0.1);
            line-height: 1.4;
            margin-top: 8px;
            /* Ensure text wraps into multiple short lines */
            word-wrap: break-word;
            overflow-wrap: break-word;
            /* Speech banner / caption bar style */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .task-pal-tooltip.visible {
            display: flex;
            opacity: 1;
        }

        .creature-image {
            width: 200px;
            height: 200px;
            margin: 0 auto 12px;
            display: block;
            border-radius: 20px;
            object-fit: contain;
            background: transparent;
            transition: transform var(--transition-normal);
        }

        .creature-image:hover {
            transform: scale(1.05);
        }

        .name-edit-wrap {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .creature-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            cursor: pointer;
            transition: color 0.2s ease;
            color: var(--text-primary);
            text-align: center;
        }

        .creature-name:hover {
            color: #007AFF;
        }

        .edit-name-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            padding: 0;
            margin: 0;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            opacity: 0.8;
            transition: opacity var(--transition-fast);
        }

        .edit-name-btn:hover {
            opacity: 1;
        }

        .creature-name-input {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            border: none;
            background: transparent;
            text-align: center;
            outline: none;
            border-bottom: 2px solid #007AFF;
            font-family: 'SF Pro Rounded', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: var(--text-primary);
        }

        .health-bar-container {
            margin-bottom: 15px;
            width: 100%;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .health-bar {
            width: 100%;
            height: 20px;
            background: var(--health-bar-bg);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 5px;
            transition: background-color 0.3s ease;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444 0%, #ffaa00 50%, #44ff44 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .health-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .task-points {
            background: #007AFF;
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 400;
            display: inline-block;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.8s ease-out;
            visibility: visible;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.8s ease-out, visibility 0s 0.8s;
        }

        .loading-brand {
            height: 80px;
            margin-bottom: 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-light);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Success Message */
        .success-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2d2d2d;
            color: white;
            padding: 16px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 16px;
            z-index: 3000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            white-space: pre-line;
            text-align: left;
            max-width: calc(100vw - 40px);
            word-wrap: break-word;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .success-message-emoji {
            font-size: 40px;
            flex-shrink: 0;
        }
        
        .success-message-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }
        
        .success-message-title {
            font-size: 18px;
            font-weight: 700;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .success-message-subtitle {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Responsive adjustments for small screens */
        @media (max-width: 480px) {
            .success-message {
                padding: 14px 16px;
                gap: 10px;
                max-width: calc(100vw - 24px); /* Wider on mobile */
                min-width: calc(100vw - 24px); /* Force wider */
                bottom: 16px;
            }
            
            .success-message-emoji {
                font-size: 36px;
            }
            
            .success-message-title {
                font-size: 16px;
            }
            
            .success-message-subtitle {
                font-size: 13px;
            }
        }
        
        @media (max-width: 360px) {
            .success-message {
                padding: 12px 14px;
                gap: 8px;
                max-width: calc(100vw - 20px); /* Even wider on very small screens */
                min-width: calc(100vw - 20px); /* Force wider */
            }
            
            .success-message-emoji {
                font-size: 32px;
            }
            
            .success-message-title {
                font-size: 15px;
            }
            
            .success-message-subtitle {
                font-size: 12px;
            }
        }

        /* Task Rock: Budget-look reskin (scoped) */
        #plannerSection {
            margin-top: 12px;
            padding-bottom: 100px; /* Space for FAB */
        }

        /* Expandable Stats Section */
        #plannerSection .stats-section {
            margin: 0 16px 16px;
            background: var(--section-bg);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        #plannerSection .stats-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid var(--border-light);
        }

        #plannerSection .stats-header:hover {
            background: var(--button-hover-bg);
        }

        #plannerSection .stats-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        #plannerSection .stats-toggle {
            font-size: 14px;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
        }

        #plannerSection .stats-toggle.expanded {
            transform: rotate(180deg);
        }

        /* Daily Challenge Expandable Section */
        #plannerSection .daily-challenge-section {
            margin: 0 16px 16px;
            background: var(--section-bg);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        #plannerSection .daily-challenge-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid var(--border-light);
        }

        #plannerSection .daily-challenge-header:hover {
            background: var(--button-hover-bg);
        }

        #plannerSection .daily-challenge-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        #plannerSection .daily-challenge-toggle {
            font-size: 14px;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
        }

        #plannerSection .daily-challenge-toggle.expanded {
            transform: rotate(180deg);
        }

        #plannerSection .daily-challenge-content {
            padding: 16px 20px;
        }

        /* Daily Challenge Card Styling */
        .daily-challenge-card {
            background: var(--daily-card-purple);
            border-radius: 16px;
            padding: 20px;
            color: white;
            text-align: center;
            transition: all 0.4s ease;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .challenge-empty-state {
            background: var(--daily-card-purple);
            background-blend-mode: overlay;
            border-radius: 16px;
            padding: 40px 24px;
            color: white;
            text-align: center;
            animation: fadeIn 0.4s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .challenge-empty-icon {
            font-size: 32px;
            margin-bottom: 8px;
            line-height: 1;
        }
        
        .challenge-empty-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .challenge-empty-desc {
            font-size: 15px;
            opacity: 0.95;
            font-weight: 400;
            line-height: 1.4;
        }

        .challenge-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .challenge-desc {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 16px;
        }

        .challenge-progress-container {
            margin-bottom: 12px;
        }

        .challenge-progress-label {
            font-size: 12px;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .challenge-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .challenge-progress-fill {
            height: 100%;
            background: var(--accent-tertiary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .challenge-reward {
            font-size: 12px;
            opacity: 0.8;
        }

        .challenge-completed {
            background: var(--daily-card-green) !important;
        }

        /* Collapsed stats: 3 cards in a row */
        #plannerSection .stats-row {
            display: grid;
            gap: 8px;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            padding: 12px 16px;
        }

        @media (max-width: 900px) {
            #plannerSection .stats-row {
                grid-template-columns: repeat(3, minmax(0, 1fr));
                gap: 6px;
            }
        }

        @media (max-width: 320px) {
            #plannerSection .stats-row {
                grid-template-columns: repeat(3, minmax(0, 1fr));
                gap: 4px;
                padding: 8px 12px;
            }
        }

        /* Expanded stats: Grid layout like the screenshot */
        #plannerSection .stats-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            padding: 16px;
        }

        @media (max-width: 900px) {
            #plannerSection .stats-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr)); /* Maintain 3 columns */
                gap: 8px;
                padding: 12px;
            }
        }

        @media (max-width: 520px) {
            #plannerSection .stats-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr)); /* Maintain 3 columns */
                gap: 6px;
                padding: 10px;
            }
        }

        @media (max-width: 400px) {
            #plannerSection .stats-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr)); /* Maintain 3 columns */
                gap: 4px;
                padding: 8px;
            }
            #plannerSection .stat-tile {
                padding: 6px 3px; /* Reduced padding for stat tiles */
                border-radius: 8px;
                gap: 1px;
            }
            #plannerSection .stat-icon {
                font-size: 9px; /* Reduced icon size */
            }
            #plannerSection .stat-value {
                font-size: 9px; /* Reduced value font size */
            }
            #plannerSection .stat-label {
                font-size: 5px; /* Reduced label font size */
                min-height: 9px;
            }
        }

        #plannerSection .stat-tile {
            background: var(--bg-secondary);
            border: none; /* Remove border in light mode */
            border-radius: 12px;
            padding: 16px 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 4px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            aspect-ratio: 1;
            justify-content: center;
            min-height: 0;
            overflow: hidden;
        }

        @media (max-width: 400px) {
            #plannerSection .stat-tile {
                padding: 10px 6px; /* Reduced padding */
                border-radius: 10px;
                gap: 2px;
            }
            #plannerSection .stat-icon {
                font-size: 12px; /* Reduced icon size */
            }
            #plannerSection .stat-value {
                font-size: 11px; /* Reduced value font size */
            }
            #plannerSection .stat-label {
                font-size: 7px; /* Reduced label font size */
                min-height: 12px;
            }
        }

        @media (max-width: 320px) {
            #plannerSection .stat-tile {
                padding: 6px 3px; /* Further reduced padding */
                border-radius: 8px;
                gap: 1px;
            }
            #plannerSection .stat-icon {
                font-size: 9px; /* Further reduced icon size */
            }
            #plannerSection .stat-value {
                font-size: 9px; /* Further reduced value font size */
            }
            #plannerSection .stat-label {
                font-size: 5px; /* Further reduced label font size */
                min-height: 9px;
            }
        }

        /* Dark mode enhanced borders */
        [data-theme="dark"] #plannerSection .stat-tile {
            border: 1px solid rgba(255, 255, 255, 0.1); /* Keep border in dark mode */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        /* Low completion rate warning */
        #plannerSection .stat-tile.low-completion {
            border-color: #ff4444;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3), 0 2px 8px rgba(0, 0, 0, 0.08);
            animation: pulse-red 2s infinite;
        }

        [data-theme="dark"] #plannerSection .stat-tile.low-completion {
            border-color: #ff6666;
            box-shadow: 0 0 25px rgba(255, 102, 102, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        @keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 68, 68, 0.3), 0 2px 8px rgba(0, 0, 0, 0.08);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 68, 68, 0.5), 0 2px 8px rgba(0, 0, 0, 0.08);
            }
        }

        [data-theme="dark"] @keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 0 25px rgba(255, 102, 102, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3);
            }
            50% {
                box-shadow: 0 0 35px rgba(255, 102, 102, 0.6), 0 2px 8px rgba(0, 0, 0, 0.3);
            }
        }
        
        /* Glowing green dots animation for recurring task completion streak */
        @keyframes glow-pulse {
            0%, 100% {
                box-shadow: 0 0 6px #10b981, 0 0 12px #10b981;
                opacity: 1;
            }
            50% {
                box-shadow: 0 0 10px #10b981, 0 0 20px #10b981, 0 0 30px #10b981;
                opacity: 0.8;
            }
        }

        #plannerSection .stat-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12), 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        #plannerSection .stat-icon {
            font-size: 16px;
            margin-bottom: 0;
            flex-shrink: 0;
        }

        #plannerSection .stat-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0;
            line-height: 1.1;
        }

        #plannerSection .stat-label {
            font-size: 9px;
            color: var(--text-secondary);
            font-weight: 500;
            text-align: center;
            line-height: 1.1;
            padding: 0 1px;
            white-space: nowrap;
            word-break: keep-all;
            overflow-wrap: break-word;
            hyphens: none;
            max-width: 100%;
            min-height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 400px) {
            #plannerSection .stat-icon {
                font-size: 14px;
            }
            
            #plannerSection .stat-value {
                font-size: 12px;
            }
            
            #plannerSection .stat-label {
                font-size: 8px;
                min-height: 14px;
            }
        }

        @media (max-width: 320px) {
            #plannerSection .stat-icon {
                font-size: 12px;
            }
            
            #plannerSection .stat-value {
                font-size: 11px;
            }
            
            #plannerSection .stat-label {
                font-size: 7px;
                min-height: 12px;
                padding: 0;
            }
        }

        /* Improved Pill Tab Navigation CSS */
        /* Pill tab bar - Enhanced container with horizontal scrolling */
        #plannerSection .pill-tabs {
            display: flex;
            gap: 6px;
            margin: 0 16px 16px;
            padding: 6px;
            border-radius: 20px;
            background: var(--section-bg);
            box-shadow: var(--shadow-sm);
            align-items: center;
            position: relative;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) var(--bg-secondary);
        }
        
        /* Hide scrollbar for cleaner look */
        #plannerSection .pill-tabs::-webkit-scrollbar {
            height: 4px;
        }
        
        #plannerSection .pill-tabs::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 2px;
        }
        
        #plannerSection .pill-tabs::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 2px;
        }

        /* Individual pill tab buttons - Improved spacing and alignment */
        #plannerSection .pill-tab {
            padding: 12px 16px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 14px;
            border: 0;
            background: transparent;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            flex: 0 0 auto;
            text-align: center;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: fit-content;
            line-height: 1.2;
            position: relative;
        }

        /* Selected tab state - Enhanced visual prominence */
        #plannerSection .pill-tab[aria-selected="true"] {
            background: var(--accent-primary);
            color: #000000;
            font-weight: 700;
            padding: 12px 18px;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(208, 255, 0, 0.3);
        }

        /* Hover state for unselected tabs */
        #plannerSection .pill-tab:hover:not([aria-selected="true"]) {
            background: var(--button-hover-bg);
            color: var(--text-primary);
        }

        /* Generic card shell */
        #plannerSection .card {
            background: var(--section-bg);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            padding: 20px;
            margin: 0 16px 16px;
            box-shadow: var(--shadow-sm);
        }

        #plannerSection .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        /* Collapsible section styles */
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }
        
        .collapsible-header:hover {
            opacity: 0.8;
        }
        
        .collapse-toggle {
            font-size: 14px;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
        }
        
        .collapsible-content {
            transition: max-height 0.3s ease;
            overflow: hidden;
        }

        #plannerSection .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Tab content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Centered FAB (create task) */
        #plannerSection .fab-center {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            z-index: 500;
            background: var(--accent-primary);
            color: #000000;
            border: none;
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #plannerSection .fab-center:hover {
            transform: translateX(-50%) scale(1.1);
        }

        /* Task Cards */
        .task-card {
            /* Apply Quest Card styling structure with current colors */
            background: linear-gradient(135deg, #0a0f0d 0%, #101712 100%);
            border: 2px solid #374151;
            border-radius: 16px;
            padding: 20px;
            padding-bottom: 80px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(55, 65, 81, 0.25);
            transition: all 0.3s ease;
            position: relative;
            overflow: visible;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(55, 65, 81, 0.4);
            border-color: #4b5563;
        }

        .task-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            position: relative;
        }

        .task-emoji {
            font-size: 28px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: 12px;
            flex-shrink: 0;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.3;
        }

        .task-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .task-due-date {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            color: #fff;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        .task-due-date.warning {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: #fff;
            border: none;
            animation: flash-glow-red 1.5s ease-in-out infinite;
        }
        
        @keyframes flash-glow-red {
            0%, 100% {
                box-shadow: 0 0 10px rgba(220, 38, 38, 0.8), 0 0 20px rgba(220, 38, 38, 0.6);
                opacity: 1;
            }
            50% {
                box-shadow: 0 0 20px rgba(220, 38, 38, 1), 0 0 40px rgba(220, 38, 38, 0.8);
                opacity: 0.9;
            }
        }

        .task-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .task-badge.priority-high {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: #fff;
        }

        .task-badge.priority-medium {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: #1a1410;
        }

        .task-badge.priority-low {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: #fff;
        }

        .task-badge.difficulty-hard {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: #fff;
        }

        .task-badge.difficulty-medium {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: #1a1410;
        }

        .task-badge.difficulty-easy {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: #fff;
        }

        .task-actions {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Edit Button - Just the pencil emoji in Top-Right Corner */
        .task-edit-button {
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
            font-size: 20px;
        }

        .task-edit-button:hover {
            transform: scale(1.1);
        }

        .task-edit-button::before {
            content: '‚úèÔ∏è';
        }

        /* Delete Button - Style like "Abandon Quest" */
        .task-delete-button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .task-delete-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);
        }

        .task-delete-button::before {
            content: 'üóëÔ∏è';
        }

        /* Complete Button - Keep at Bottom with Gradient */
        .task-complete-button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #4c1d95 0%, #6366f1 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        .task-complete-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
        }

        .btn-primary {
            background: var(--accent-primary);
            color: #000000;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
        }

        .btn-secondary:hover {
            background: var(--button-hover-bg);
            transform: translateY(-1px);
        }

        /* Quick Tasks */
        .quick-task-item {
            background: var(--task-item-bg);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .quick-task-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .quick-task-emoji {
            font-size: 20px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .quick-task-content {
            flex: 1;
            min-width: 0;
        }

        .quick-task-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .quick-task-category {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .quick-task-points {
            font-size: 10px;
            font-weight: 600;
            color: white;
            background: #007AFF;
            padding: 3px 6px;
            border-radius: 6px;
            margin-right: 8px;
            white-space: nowrap;
        }

        .quick-task-actions {
            display: flex;
            gap: 4px;
        }

        .action-btn {
            min-width: 44px;
            height: 44px;
            border: none;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            padding: 8px 12px;
            gap: 6px;
            white-space: nowrap;
            overflow: hidden;
            flex-shrink: 0;
        }

        .action-complete {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            min-width: 44px;
            width: 44px;
            font-size: 20px;
            font-weight: bold;
        }

        .action-complete:hover {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            transform: scale(1.05);
        }

        .action-remove {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
            min-width: 44px;
            width: 44px;
            font-size: 20px;
            font-weight: bold;
        }

        .action-remove:hover {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            transform: scale(1.05);
        }

        /* Recurring Task Buttons */
        .recurring-btn {
            min-width: auto !important;
            width: auto !important;
            padding: 10px 16px !important;
            font-size: 14px !important;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .recurring-btn:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .recurring-btn:active {
            transform: scale(0.98);
        }

        /* Daily Challenge */
        .daily-challenge-card {
            background: var(--daily-card-purple);
            border-radius: 16px;
            padding: 20px;
            color: white;
            text-align: center;
            transition: all 0.4s ease;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .challenge-empty-state {
            background: var(--daily-card-purple);
            background-blend-mode: overlay;
            border-radius: 16px;
            padding: 40px 24px;
            color: white;
            text-align: center;
            animation: fadeIn 0.4s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .challenge-empty-icon {
            font-size: 32px;
            margin-bottom: 8px;
            line-height: 1;
        }
        
        .challenge-empty-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .challenge-empty-desc {
            font-size: 15px;
            opacity: 0.95;
            font-weight: 400;
            line-height: 1.4;
        }

        .challenge-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .challenge-desc {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 16px;
        }

        .challenge-progress-container {
            margin-bottom: 12px;
        }

        .challenge-progress-label {
            font-size: 12px;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .challenge-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .challenge-progress-fill {
            height: 100%;
            background: var(--accent-tertiary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .challenge-reward {
            font-size: 12px;
            opacity: 0.8;
        }

        .challenge-completed {
            background: var(--daily-card-green) !important;
        }

        /* Achievements */
        .achievement-card {
            background: var(--task-item-bg);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .achievement-card.unlocked {
            border-color: var(--success);
            background: rgba(52, 211, 153, 0.05);
        }

        .achievement-card.locked {
            opacity: 0.6;
        }

        .achievement-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }

        .achievement-content {
            flex: 1;
            min-width: 0;
        }

        .achievement-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .achievement-desc {
            font-size: 12px;
            color: var(--text-secondary);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .achievement-status {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 8px;
        }

        .achievement-status.unlocked {
            background: var(--success);
            color: white;
        }

        .achievement-status.locked {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        /* Achievement Filter Tabs */
        .achievement-filter-tabs {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .achievement-filter-btn {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: var(--radius-md);
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .achievement-filter-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .achievement-filter-btn.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Achievement Stats Summary */
        .achievement-stats-summary {
            padding: 12px 16px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-light);
        }

        .achievement-progress-bar {
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .achievement-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #10b981);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Achievement card hidden state for filtering */
        .achievement-card.filtered-out {
            display: none !important;
        }

        /* Empty state message */
        .achievement-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .achievement-empty-state .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .achievement-empty-state .empty-text {
            font-size: 14px;
        }

        /* Shop Items */
        .owned-badge {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 4px;
            text-align: center;
        }
        
        .shop-item-desc {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            line-height: 1.3;
        }
        
        .shop-grid {
            display: flex;
            overflow-x: auto;
            gap: 16px;
            margin-top: 16px;
            margin-bottom: 24px;
            padding-bottom: 8px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .shop-grid::-webkit-scrollbar {
            height: 6px;
        }

        .shop-grid::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 3px;
        }

        .shop-grid::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }

        .shop-grid::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        .shop-item {
            background: var(--task-item-bg);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            min-height: 140px;
            min-width: 120px;
            flex-shrink: 0;
        }

        .shop-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .shop-item.equipped {
            border: 2px solid #A5F247;
            box-shadow: 0 0 0 2px rgba(165, 242, 71, 0.35), 0 6px 18px rgba(165, 242, 71, 0.20);
        }

        .shop-item.owned {
            /* No special border for owned but unequipped items */
        }

        .shop-item.expensive {
            opacity: 0.6;
        }

        .shop-item-emoji {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .shop-item-image {
            max-width: 60px;
            height: auto;
            margin-bottom: 8px;
        }

        .shop-item-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .shop-item-price {
            font-size: 12px;
            color: var(--text-secondary);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Settings */
        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .settings-toggle {
            width: 50px;
            height: 28px;
            background: var(--bg-tertiary);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .settings-toggle.active {
            background: var(--accent-primary);
        }

        .settings-toggle-slider {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .settings-toggle.active .settings-toggle-slider {
            transform: translateX(22px);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 85vh;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            overflow-x: hidden; /* Explicitly lock horizontal scroll */
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px 0;
            margin-bottom: 12px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--button-hover-bg);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px 24px 0; /* Add top padding to prevent cropping */
            overflow-y: auto;
            overflow-x: hidden; /* Lock horizontal scroll */
            flex: 1;
            /* Ensure scrollable area has enough space */
            min-height: 0;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .modal-footer {
            padding: 16px 24px 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-light);
            position: sticky;
            bottom: 0;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            max-width: 100%; /* CRITICAL FIX: Prevent overflow on mobile */
            box-sizing: border-box; /* CRITICAL FIX: Include padding and border in width calculation */
            padding: 12px 16px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent-tertiary);
            box-shadow: 0 0 0 3px rgba(160, 204, 0, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Dark mode datetime-local calendar icon fix */
        [data-theme="dark"] input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        [data-theme="dark"] .form-input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        [data-theme="dark"] #taskDueDate::-webkit-calendar-picker-indicator {
            filter: invert(1) !important;
            cursor: pointer;
            opacity: 1 !important;
        }

        /* Light mode - ensure icon is black */
        [data-theme="light"] input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        [data-theme="light"] .form-input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        [data-theme="light"] #taskDueDate::-webkit-calendar-picker-indicator,
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: none !important;
            cursor: pointer;
            opacity: 1 !important;
        }

        /* For Firefox */
        [data-theme="dark"] input[type="datetime-local"],
        [data-theme="dark"] .form-input[type="datetime-local"],
        [data-theme="dark"] #taskDueDate {
            color-scheme: dark;
        }

        [data-theme="light"] input[type="datetime-local"],
        [data-theme="light"] .form-input[type="datetime-local"],
        [data-theme="light"] #taskDueDate {
            color-scheme: light;
        }
        
        /* CRITICAL FIX: Prevent datetime-local overflow on mobile */
        input[type="datetime-local"],
        .form-input[type="datetime-local"],
        #taskDueDate {
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            overflow: hidden;
            text-overflow: ellipsis;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        /* Ensure form-group constrains its children */
        .form-group {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        @media (max-width: 420px) {
            .selection-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Mobile responsiveness for iPhone 12 mini (375px) and smaller */
        @media (max-width: 390px) {
            .modal-content {
                max-width: 95vw;
                max-height: 90vh;
                border-radius: 16px;
            }
            
            .modal-header {
                padding: 16px 16px 0;
                margin-bottom: 12px;
            }
            
            .modal-title {
                font-size: 18px;
            }
            
            .modal-body {
                padding: 12px 16px 0; /* Add top padding to prevent cropping on mobile */
                overflow-x: hidden; /* Lock horizontal scroll on mobile */
            }
            
            .modal-footer {
                padding: 12px 16px 16px;
                display: flex;
                gap: 8px;
            }
            
            .form-group {
                margin-bottom: 16px;
            }
            
            .form-input,
            .form-select,
            .form-textarea {
                padding: 10px 12px;
                font-size: 16px;
                max-width: 100%; /* CRITICAL FIX: Prevent overflow on mobile */
                box-sizing: border-box; /* CRITICAL FIX: Ensure proper width calculation */
                overflow: hidden; /* CRITICAL FIX: Clip any overflowing content */
            }
            
            .form-label {
                font-size: 13px;
                margin-bottom: 6px;
            }
            
            .selection-item {
                padding: 10px 6px;
                min-height: 70px;
            }
            
            .selection-item-emoji {
                font-size: 20px;
            }
            
            .selection-item-text {
                font-size: 11px;
            }
            
            #recurringOptions {
                padding: 12px !important;
            }
            
            .day-checkbox {
                font-size: 12px;
                padding: 6px 8px;
            }
        }

        .selection-item {
            background: var(--bg-secondary);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .selection-item:hover {
            border-color: var(--accent-tertiary);
            background: rgba(160, 204, 0, 0.05);
        }

        .selection-item.selected {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: #000000;
            font-weight: 600;
        }

        .selection-item-emoji {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .selection-item-text {
            font-size: 12px;
            font-weight: 500;
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: center;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state-subtext {
            font-size: 14px;
            opacity: 0.8;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
            }

            #plannerSection .card {
                margin: 0 12px 12px;
                padding: 16px;
            }

            #plannerSection .stats-row {
                margin: 0 12px 12px;
            }

            #plannerSection .pill-tabs {
                margin: 0 12px 12px;
                padding: 5px;
                gap: 4px;
            }
            
            #plannerSection .pill-tab {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            #plannerSection .pill-tab[aria-selected="true"] {
                padding: 12px 14px;
            }

            .task-title,
            .quick-task-title,
            .achievement-name {
                font-size: 15px;
            }

            .shop-grid {
                gap: 12px;
            }
        }

        /* Ensure text never overflows containers */
        .task-title,
        .quick-task-title,
        .achievement-name,
        .shop-item-name,
        .challenge-title,
        .challenge-desc {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            max-width: 100%;
        }

        /* Prevent horizontal scroll */
        body,
        html {
            overflow-x: hidden;
        }

        .app-container {
            overflow-x: hidden;
        }

    /* Hero sprite sheet animations REMOVED - Using GIF animations instead for fluid playback */
    
    /* Imp sprite sheet animation - 8 columns √ó 12 rows, animate row 9 (idle) */
    @keyframes imp-idle-anim {
      from { object-position: 0 -256px; }  /* Row 9 starts at 8 * 32px = 256px */
      to { object-position: -256px -256px; }  /* 8 frames √ó 32px = 256px */
    }
    
    /* Hero walk and flicker animations REMOVED - Using GIF animations instead */
    
    /* Low HP flickering effect for main hero sprite */
    .low-hp-flicker {
      opacity: 0.6 !important; /* Static opacity instead of animation */
    }

    /* Native datetime-local input styling is handled by browser */

    .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    .modal-footer {
        display: flex;
        gap: 12px;
        justify-content: space-between;
    }
    
    /* Shop Sub-Tabs */
    .shop-sub-tabs {
        display: flex;
        gap: 8px;
        padding: 16px 20px;
        background: var(--card-bg);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
    }
    
    .shop-sub-tabs::-webkit-scrollbar {
        height: 6px;
    }
    
    .shop-sub-tabs::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .shop-sub-tabs::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
    }
    
    .shop-sub-tabs::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
    }

    .pill-tab-shop {
        padding: 8px 20px;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: transparent;
        color: #999;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
        white-space: nowrap;
    }

    .pill-tab-shop.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .pill-tab-shop:hover:not(.active) {
        background: rgba(255, 255, 255, 0.05);
        color: #ccc;
    }

    /* Shop Sub-Tab Content */
    .shop-sub-content {
        display: none;
    }

    .shop-sub-content.active {
        display: block;
        padding-top: 16px; /* Match the vertical spacing from pill buttons to divider */
    }

    /* Shop Items Grid - MOVED TO shop-refactored.css */
    /* .shop-items-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr)); /* Always 2 columns with equal width */
        gap: 16px;
    }

    .shop-item-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
        transition: all 0.2s;
        height: 280px;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .shop-item-card:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }
    
    /* Skins Shop Styling - Matching Reference Design */
    .skin-card {
        background: rgba(20, 30, 20, 0.8);
        border: 2px solid rgba(76, 175, 80, 0.3);
        border-radius: 12px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .skin-card:hover {
        border-color: rgba(76, 175, 80, 0.6);
        background: rgba(20, 30, 20, 0.95);
        transform: translateY(-2px);
    }
    
    .skin-card.equipped {
        border-color: rgba(76, 175, 80, 1);
        background: rgba(30, 50, 30, 0.9);
    }
    
    .skin-card.locked {
        opacity: 0.7;
    }
    
    /* Skin Thumbnail Container */
    .skin-thumbnail {
        width: 100px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }
    
    .skin-thumbnail img.skin-img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        object-position: center;
        image-rendering: pixelated;
    }
    
    .locked-thumbnail {
        background: rgba(50, 50, 50, 0.5);
    }
    
    .locked-icon {
        font-size: 48px;
        color: #10b981 !important;
        text-shadow: 0 0 15px #10b981, 0 0 30px rgba(16, 185, 129, 0.5), 0 0 45px rgba(16, 185, 129, 0.3) !important;
        filter: drop-shadow(0 0 8px #10b981) !important;
        opacity: 1;
        -webkit-text-fill-color: #10b981 !important;
    }
    
    /* Skin Name */
    .skin-name-new {
        font-size: 14px;
        font-weight: 600;
        color: white;
        text-align: center;
    }
    
    /* Skin Price */
    .skin-price {
        font-size: 13px;
        font-weight: 600;
        color: #4CAF50;
        text-align: center;
        margin-top: 4px;
    }
    
    /* Skin Buttons */
    .skin-btn-new {
        width: 100%;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
        border: 2px solid;
    }
    
    .skin-btn-new.equip {
        background: transparent;
        color: #4CAF50;
        border-color: #4CAF50;
    }
    
    .skin-btn-new.equip:hover {
        background: rgba(76, 175, 80, 0.1);
    }
    
    .skin-btn-new.equipped {
        background: rgba(76, 175, 80, 0.2);
        color: #4CAF50;
        border-color: #4CAF50;
        cursor: default;
    }
    
    .skin-btn-new.buy {
        background: transparent;
        color: #4CAF50;
        border-color: #4CAF50;
    }
    
    .skin-btn-new.buy:hover {
        background: rgba(76, 175, 80, 0.2);
    }
    
    .skin-btn-new.locked {
        background: rgba(100, 100, 100, 0.2);
        color: #666;
        border-color: #444;
        cursor: not-allowed;
    }
    
    .skin-locked-text {
        font-size: 12px;
        color: #999;
        text-align: center;
        padding: 8px;
    }

    .shop-item-emoji {
        font-size: 36px;
        margin-bottom: 12px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .shop-item-emoji img {
        max-width: 60px;
        max-height: 60px;
        object-fit: contain;
    }

    .shop-item-name {
        font-size: 16px;
        font-weight: 600;
        color: white;
        margin-bottom: 8px;
    }

    .shop-item-description {
        font-size: 12px;
        color: #999;
        margin-bottom: 12px;
        line-height: 1.4;
    }

    .shop-item-cost {
        font-size: 14px;
        font-weight: 600;
        color: #FFD700;
        margin-bottom: 12px;
    }

    .buy-now-btn {
        width: 100%;
        padding: 8px 16px;
        background: #1a1a1a;
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .buy-now-btn:hover {
        background: #2a2a2a;
        border-color: rgba(255, 255, 255, 0.3);
    } */

        /* Owned Items Grid */
        .owned-item-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .owned-item-emoji {
            font-size: 32px;
            flex-shrink: 0;
        }
        
        .owned-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .owned-item-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .owned-item-quantity {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .use-item-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .use-item-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .use-item-btn.equipped {
            background: #4CAF50;
        }
        
        .owned-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            padding: 20px;
            justify-items: center;
            justify-content: center;
        }

    .owned-item-card {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 16px;
        text-align: center;
        transition: all 0.2s;
        position: relative;
        width: 100%;
        max-width: 280px;
    }

    .owned-item-card:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    .owned-item-card.equipped {
        border-color: #00ff88;
        background: rgba(0, 255, 136, 0.1);
    }

    .owned-item-header {
        position: relative;
        margin-bottom: 12px;
    }

    .owned-item-emoji {
        font-size: 40px;
        margin-bottom: 8px;
    }

    .owned-item-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ff4444;
        color: white;
        font-size: 12px;
        font-weight: 700;
        padding: 4px 8px;
        border-radius: 12px;
        min-width: 24px;
    }

    .owned-item-name {
        font-size: 16px;
        font-weight: 600;
        color: white;
        margin-bottom: 8px;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .status-badge.equipped {
        background: rgba(0, 255, 136, 0.2);
        color: #00ff88;
        border: 1px solid #00ff88;
    }

    .status-badge.ready {
        background: rgba(99, 102, 241, 0.2);
        color: #818cf8;
        border: 1px solid #818cf8;
    }

    .owned-item-effect {
        font-size: 13px;
        color: #999;
        margin-bottom: 12px;
    }

    .use-now-btn {
        width: 100%;
        padding: 10px 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .use-now-btn:hover {
        background: #5a5fd8;
        transform: scale(1.02);
    }

    .item-count-badge {
        background: rgba(255, 255, 255, 0.1);
        color: #999;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }


/* ========================================
   ONBOARDING SYSTEM STYLES
   ======================================== */

.onboarding-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow-y: auto;
    padding: 20px;
}

.onboarding-overlay.hidden {
    display: none;
}

.onboarding-content {
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
    padding: 20px 0;
    max-height: 100vh;
    overflow-y: auto;
}

.step-header {
    text-align: center;
    margin-bottom: 20px;
    margin-top: 0;
    padding-top: 0;
    position: relative;
}

/* Fix Step 3 header alignment to match step 2 */
#step3 .step-header {
    margin-top: 0;
    padding-top: 0;
}

.step-title {
    font-size: 28px;
    font-weight: bold;
    color: #fff;
    margin-top: 0;
    margin-bottom: 8px;
    padding: 0;
}

.step-subtitle {
    font-size: 16px;
    color: #aaa;
    margin-bottom: 20px;
}

.step-indicators {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 0;
    margin-bottom: 10px;
    padding: 0;
}

.step-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #333;
    transition: all 0.3s ease;
}

.step-dot.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    width: 30px;
    border-radius: 6px;
}

.step-count {
    font-size: 14px;
    color: #888;
    margin: 0;
    padding: 0;
}

.onboarding-step {
    display: none;
}

.onboarding-step.active {
    display: block;
}

.monster-cards {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 80px;
}

.monster-card {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.monster-card:hover {
    transform: translateY(-4px);
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.monster-card.selected {
    border-color: #667eea;
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
}

.monster-card-content {
    display: flex;
    gap: 20px;
    align-items: center;
}

.monster-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.monster-avatar.luna {
    background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
}

.monster-avatar.benny {
    background: linear-gradient(135deg, #ffa751 0%, #ffe259 100%);
}

.monster-avatar.nova {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.monster-sprite {
    width: 32px;
    height: 32px;
    object-fit: none;
    object-position: 0 0;
    image-rendering: pixelated;
    transform: scale(2.5);
}

/* Egg sprite overrides - for animated GIFs */
.egg-sprite {
    object-fit: contain !important;
    object-position: center !important;
    animation: none !important;
    width: 64px !important;
    height: 64px !important;
    max-width: 64px !important;
    max-height: 64px !important;
    transform: none !important;
    display: block !important;
    margin: 0 auto !important;
}

/* Egg sprite wrapper - scales the egg */
.egg-sprite-wrapper {
    width: 64px !important;
    height: 64px !important;
    overflow: visible !important;
    transform: scale(1.3) !important;
}

/* Human skins - scaled to 85% for slightly smaller appearance */
.monster-sprite.human-knight-skin,
.monster-sprite.human-ranger-skin {
    transform: scale(2.125) !important;  /* 2.5 * 0.85 = 2.125 */
}

.monster-info {
    flex: 1;
}

.monster-name {
    font-size: 24px;
    font-weight: bold;
    color: #fff;
    margin-bottom: 5px;
}

.monster-title {
    font-size: 16px;
    color: #aaa;
    margin-bottom: 10px;
}

.monster-description {
    font-size: 13px;
    color: #ccc;
    line-height: 1.4;
    margin-bottom: 8px;
}

.monster-tags {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
    justify-content: center;
}

.monster-tag {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.monster-tag.luna {
    background: rgba(161, 140, 209, 0.3);
    color: #d4c5f9;
}

.monster-tag.benny {
    background: rgba(255, 167, 81, 0.3);
    color: #ffd4a3;
}

.monster-tag.nova {
    background: rgba(240, 147, 251, 0.3);
    color: #f5b3fb;
}

.onboarding-button {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    padding: 16px 48px;
    background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
    z-index: 10001;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
}

.onboarding-button:hover {
    transform: translateX(-50%) translateY(-2px);
    box-shadow: 0 6px 20px rgba(79, 70, 229, 0.6);
}

.onboarding-button:disabled {
    background: #555;
    cursor: not-allowed;
    box-shadow: none;
}

.name-input-container {
    max-width: 500px;
    margin: 0 auto 30px;
}

.name-input {
    width: 100%;
    padding: 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: white;
    font-size: 18px;
    text-align: center;
    margin-bottom: 10px;
}

.name-input:focus {
    outline: none;
    border-color: #667eea;
}

.name-hint {
    text-align: center;
    font-size: 14px;
    color: #888;
    margin-bottom: 20px;
}

.quick-suggestions {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}

.suggestion-chip {
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: white;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.suggestion-chip:hover {
    border-color: rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.1);
}

.suggestion-chip.selected {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.2);
}

.selected-monster-display {
    text-align: center;
    margin-bottom: 30px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.selected-monster-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    margin: 0 auto 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.selected-monster-sprite {
    width: 32px;
    height: 32px;
    object-fit: none;
    object-position: 0 0;
    image-rendering: pixelated;
    transform: scale(3.5);
}

.confirmation-message {
    text-align: center;
    font-size: 18px;
    color: #ccc;
    line-height: 1.6;
}

.confirmation-message strong {
    color: #667eea;
    font-size: 24px;
}

/* Egg Info Banner Styles */
.egg-info-banner {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(236, 72, 153, 0.15) 100%);
    border: 2px solid rgba(139, 92, 246, 0.3);
    border-radius: 16px;
    padding: 24px 20px;
    margin: 24px auto;
    max-width: 500px;
    text-align: center;
}

.egg-info-icon {
    font-size: 48px;
    line-height: 1;
    margin-bottom: 16px;
    display: block;
}

.egg-info-title {
    margin: 0 0 16px 0;
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.3;
}

.egg-info-description {
    margin: 0;
    font-size: 15px;
    line-height: 1.6;
    color: var(--text-secondary);
    padding: 0 8px;
}

.back-button {
    position: fixed;
    top: 30px;
    left: 30px;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
}

.back-button:hover {
    background: rgba(255, 255, 255, 0.2);
}

    /* Responsive padding for shop sub-content on mobile */
    @media (max-width: 480px) {
        .shop-sub-content.active {
            padding-top: 12px;
        }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
    .onboarding-content {
        padding-bottom: 120px;
    }
    
    .step-title {
        font-size: 24px;
    }
    
    .step-subtitle {
        font-size: 14px;
    }
    
    .monster-card-content {
        flex-direction: column;
        text-align: center;
    }
    
    .monster-avatar {
        margin: 0 auto;
    }
    
    .selected-monster-avatar {
        width: 100px;
        height: 100px;
    }
    
    .monster-name {
        font-size: 20px;
    }
    
    .monster-description {
        font-size: 13px;
    }
    
    .quick-suggestions {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }
    
    .suggestion-chip {
        padding: 10px;
        font-size: 13px;
    }
    
    .onboarding-button {
        bottom: 20px;
        padding: 14px 32px;
        font-size: 16px;
        width: calc(100% - 40px);
        max-width: 400px;
    }
    
    /* Egg Info Banner Mobile Styles */
    .egg-info-banner {
        padding: 20px 16px;
        margin: 20px 16px;
        border-radius: 12px;
    }
    
    .egg-info-icon {
        font-size: 40px;
        margin-bottom: 12px;
    }
    
    .egg-info-title {
        font-size: 17px;
        margin-bottom: 12px;
        padding: 0 4px;
    }
    
    .egg-info-description {
        font-size: 14px;
        line-height: 1.5;
        padding: 0 4px;
    }
    
    .name-input {
        font-size: 16px;
    }
}

    </style>

</head>
<body>

<!-- Quest Prompt Modal -->
<div id="questPromptModal" class="quest-prompt-modal hidden">
    <div class="quest-prompt-content">
        <div class="quest-prompt-icon">üßô‚Äç‚ôÇÔ∏è</div>
        <h2 class="quest-prompt-title">Merlin Approaches</h2>
        <p class="quest-prompt-message">Merlin has a quest for you. Would you like to hear it?</p>
        <div class="quest-prompt-buttons">
            <button id="questPromptYes" class="quest-prompt-btn quest-prompt-yes">‚ú® Yes</button>
            <button id="questPromptNo" class="quest-prompt-btn quest-prompt-no">‚ùå No</button>
        </div>
    </div>
</div>

<style>
.quest-prompt-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
    visibility: visible !important; /* Override document-level hiding */
}

.quest-prompt-modal.hidden {
    display: none;
}

.quest-prompt-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 40px 30px;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: scaleIn 0.3s ease;
}

.quest-prompt-icon {
    font-size: 64px;
    margin-bottom: 20px;
    animation: bounce 1s infinite;
}

.quest-prompt-title {
    color: white;
    font-size: 28px;
    margin-bottom: 15px;
    font-weight: bold;
}

.quest-prompt-message {
    color: rgba(255, 255, 255, 0.9);
    font-size: 18px;
    margin-bottom: 30px;
    line-height: 1.5;
}

.quest-prompt-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
}

.quest-prompt-btn {
    padding: 15px 30px;
    font-size: 18px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.quest-prompt-yes {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
}

.quest-prompt-yes:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(56, 239, 125, 0.4);
}

.quest-prompt-no {
    background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
    color: white;
}

.quest-prompt-no:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(235, 51, 73, 0.4);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

@keyframes scaleIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

@keyframes xpFloat {
    0% {
        opacity: 0;
        transform: translateX(-50%) translateY(0) scale(0.5);
    }
    20% {
        opacity: 1;
        transform: translateX(-50%) translateY(-10px) scale(1);
    }
    80% {
        opacity: 1;
        transform: translateX(-50%) translateY(-40px) scale(1);
    }
    100% {
        opacity: 0;
        transform: translateX(-50%) translateY(-60px) scale(0.8);
    }
}

@keyframes damageFloat {
    0% {
        opacity: 0;
        transform: translateX(-50%) translateY(0) scale(0.5);
    }
    20% {
        opacity: 1;
        transform: translateX(-50%) translateY(-10px) scale(1.2);
    }
    80% {
        opacity: 1;
        transform: translateX(-50%) translateY(-40px) scale(1);
    }
    100% {
        opacity: 0;
        transform: translateX(-50%) translateY(-60px) scale(0.8);
    }
}

/* Battle Container Positioning */
.battle-container {
    position: relative;
    width: 100%;
    height: 300px;  /* Fixed height for positioning */
    padding: 20px;
    margin-bottom: 20px;
}

/* Hero Container - Left Aligned */
#heroContainer {
    position: absolute;
    left: 10px;  /* Closer to left edge */
    top: 50%;
    transform: translateY(-50%);
    max-width: 35%;  /* Limit width to prevent expansion */
}

/* Enemy Container - Right Aligned */
#enemyContainer {
    position: absolute;
    right: 10px;  /* Closer to right edge */
    top: 50%;
    transform: translateY(-50%);
    max-width: 35%;  /* Limit width to prevent expansion */
}

/* FIX: Turn Timer System - HIDDEN (timer now in battle log) */
.turn-timer {
    display: none !important;  /* Completely hidden */
}

.turn-timer.hidden {
    display: none;
}

.turn-timer.warning {
    background: rgba(255, 107, 107, 0.9);
    animation: pulse-timer 0.5s ease-in-out infinite;
}

@keyframes pulse-timer {
    0%, 100% {
        transform: translateX(-50%) scale(1);
    }
    50% {
        transform: translateX(-50%) scale(1.05);
    }
}

.timer-label {
    display: none;  /* Hide label in compact mode */
}

.timer-bar-bg {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    height: 6px;
    width: 70px;
    overflow: hidden;
}

.timer-bar-fill {
    background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
    height: 100%;
    width: 100%;
    transition: width 0.05s linear;
    border-radius: 10px;
}

.turn-timer.warning .timer-bar-fill {
    background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
}

.timer-text {
    color: #fff;
    font-size: 18px;
    font-weight: 700;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

/* ========================================
   RECURRING TASKS & SUBTASKS STYLES
   ======================================== */

.form-checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 14px;
    color: var(--text-primary);
}

.form-checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-light);
    border-radius: 4px;
    position: relative;
    transition: all 0.2s ease;
}

.form-checkbox-label input[type="checkbox"]:hover {
    border-color: var(--accent-primary);
    background: var(--bg-secondary);
}

.form-checkbox-label input[type="checkbox"]:checked {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
}

.form-checkbox-label input[type="checkbox"]:checked::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.day-checkbox {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 10px;
    background: var(--bg-primary);
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.day-checkbox:hover {
    background: var(--accent-primary);
    color: white;
}

.day-checkbox input[type="checkbox"] {
    width: 14px;
    height: 14px;
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-light);
    border-radius: 3px;
    position: relative;
    transition: all 0.2s ease;
}

.day-checkbox input[type="checkbox"]:hover {
    border-color: var(--accent-primary);
    background: var(--bg-secondary);
}

.day-checkbox input[type="checkbox"]:checked {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
}

.day-checkbox input[type="checkbox"]:checked::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 10px;
    font-weight: bold;
}

/* Subtask styles for create task modal */
.subtask-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-light);
    border-radius: 10px;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}

.subtask-item:hover {
    background: var(--bg-primary);
    border-color: var(--accent-tertiary);
}

.subtask-item-text {
    flex: 1;
    color: var(--text-primary);
    font-size: 14px;
}

.subtask-item-remove {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 18px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: all 0.2s ease;
    line-height: 1;
}

.subtask-item-remove:hover {
    background: rgba(255, 59, 48, 0.1);
    color: #ff3b30;
}

.recurring-task-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
}

.recurring-task-card.inactive {
    opacity: 0.5;
}

.recurring-task-card:hover {
    border-color: var(--accent-primary);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.recurring-task-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.recurring-task-icon {
    font-size: 28px;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-tertiary);
    border-radius: 12px;
}

.recurring-task-info {
    flex: 1;
}

.recurring-task-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.recurring-task-recurrence {
    font-size: 13px;
    color: var(--text-secondary);
}

.recurring-task-toggle {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 26px;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 26px;
}

.recurring-task-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.3s;
    border-radius: 26px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: var(--accent-primary);
}

input:checked + .toggle-slider:before {
    transform: translateX(22px);
}

.recurring-task-details {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    flex-wrap: wrap;
}

.recurring-task-badge {
    padding: 4px 10px;
    background: var(--bg-tertiary);
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: capitalize;
}

.recurring-task-points {
    padding: 4px 10px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    color: white;
}

.recurring-task-next {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.recurring-task-stats {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 12px;
}

.recurring-task-actions {
    display: flex;
    gap: 8px;
}

.btn-icon {
    background: var(--bg-tertiary);
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
}
.subtask-add-btn:hover {
    background: var(--accent-primary);
    transform: translateY(-2px);
}

/* Finish Whole Task Button - Purple like primary buttons */
.finish-whole-task-btn {
    width: 100%;
    padding: 16px 20px;
    margin: 16px 0 12px 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2;
}

.finish-whole-task-btn:hover {
    background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

.finish-whole-task-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 10px rgba(102, 126, 234, 0.4);
}

/* Subtasks Styles */
.subtasks-container {
    margin-top: 12px;
    padding: 12px;
    background: var(--bg-tertiary);
    border-radius: 12px;
}

.subtasks-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.subtasks-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.subtasks-progress {
    font-size: 12px;
    font-weight: 600;
    color: var(--accent-primary);
}

.subtasks-progress-bar {
    height: 4px;
    background: var(--bg-primary);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 12px;
}

.subtasks-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transition: width 0.3s ease;
}

.subtasks-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 12px;
}

.subtask-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: var(--bg-secondary);
    border-radius: 8px;
    transition: all 0.2s ease;
}

.subtask-item:hover {
    background: var(--bg-primary);
}

.subtask-item.completed {
    opacity: 0.6;
}

.subtask-checkbox {
    position: relative;
    display: flex;
    align-items: center;
}

.subtask-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-light);
    border-radius: 4px;
    position: relative;
    transition: all 0.2s ease;
}

.subtask-checkbox input[type="checkbox"]:hover {
    border-color: var(--accent-primary);
    background: var(--bg-secondary);
}

.subtask-checkbox input[type="checkbox"]:checked {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
}

.subtask-checkbox input[type="checkbox"]:checked::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 12px;
    font-weight: bold;
}

/* Modern checkbox for inline subtasks */
.modern-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background: var(--bg-primary);
    border: 2px solid var(--border-light);
    border-radius: 4px;
    position: relative;
    transition: all 0.2s ease;
}

.modern-checkbox:hover {
    border-color: var(--accent-primary);
    background: var(--bg-secondary);
}

.modern-checkbox:checked {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
}

.modern-checkbox:checked::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.subtask-title {
    flex: 1;
    font-size: 14px;
    color: var(--text-primary);
}

.subtask-title.completed {
    text-decoration: line-through;
    color: var(--text-secondary);
}

.subtask-actions {
    display: flex;
    gap: 4px;
    opacity: 1;
    transition: opacity 0.2s ease;
}

.subtask-action-btn {
    background: var(--bg-secondary);
    border: none;
    font-size: 16px;
    cursor: pointer;
    padding: 6px 8px;
    border-radius: 6px;
    transition: all 0.2s ease;
    min-width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.subtask-action-btn:hover {
    background: var(--bg-tertiary);
    transform: scale(1.05);
}

.subtask-add-btn {
    width: 100%;
    padding: 10px;
    background: var(--bg-primary);
    border: 1px dashed var(--border-light);
    border-radius: 8px;
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.subtask-add-btn:hover {
    border-color: var(--accent-primary);
    color: var(--accent-primary);
    background: var(--bg-secondary);
}

</style>

<!-- Merlin Modal (triggered by quest giver only) -->
<div id="merlinModal" class="quest-prompt-modal hidden">
    <div class="quest-prompt-content">
        <div class="quest-prompt-icon">üßô‚Äç‚ôÇÔ∏è</div>
        <h2 class="quest-prompt-title">Merlin</h2>
        <p class="quest-prompt-message">Would you like a Quest or a Quiz today?</p>
        <div class="quest-prompt-buttons">
            <button id="merlinQuestBtn" class="quest-prompt-btn quest-prompt-yes">Quest</button>
            <button id="merlinQuizBtn" class="quest-prompt-btn quest-prompt-no">Quiz</button>
        </div>
    </div>
</div>
</style>

<!-- ========================================
     ONBOARDING SYSTEM
     ======================================== -->
<div class="onboarding-overlay hidden" id="onboardingOverlay">
    <div class="onboarding-content">
        
        <!-- Step 1: Choose Your Monster -->
        <div class="onboarding-step active" id="step1">
            <div class="step-header">
                <h1 class="step-title">Choose Your Task Monster</h1>
                <p class="step-subtitle">Pick your perfect productivity companion</p>
                <div class="step-indicators">
                    <div class="step-dot active"></div>
                    <div class="step-dot"></div>
                    <div class="step-dot"></div>
                </div>
                <p class="step-count">Step 1 of 3</p>
            </div>
            
            <div class="monster-cards">
                <!-- Luna Card -->
                <div class="monster-card" data-monster="luna" id="lunaCard">
                    <div class="monster-card-content">
                        <div class="monster-avatar luna">
                            <img src="assets/eggs/luna_egg.gif" alt="Luna Egg" class="monster-sprite egg-sprite" id="lunaSprite" style="animation: none; object-fit: contain; width: 70px; height: 70px; transform: none;">
                        </div>
                        <div class="monster-info">
                            <div class="monster-name">Luna</div>
                            <div class="monster-title">The Wise Night Owl</div>
                            <div class="monster-description">Perfect for night owls and deep thinkers. Luna helps you tackle complex tasks with wisdom and patience.</div>
                            <div class="monster-tags">
                                <span class="monster-tag luna">Calm</span>
                                <span class="monster-tag luna">Intelligent</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Benny Card -->
                <div class="monster-card" data-monster="benny" id="bennyCard">
                    <div class="monster-card-content">
                        <div class="monster-avatar benny">
                            <img src="assets/eggs/benny_egg.gif" alt="Benny Egg" class="monster-sprite egg-sprite" id="bennySprite" style="animation: none; object-fit: contain; width: 70px; height: 70px; transform: none;">
                        </div>
                        <div class="monster-info">
                            <div class="monster-name">Benny</div>
                            <div class="monster-title">The Gentle Giant</div>
                            <div class="monster-description">Strong and dependable. Benny helps you power through big projects with steady determination.</div>
                            <div class="monster-tags">
                                <span class="monster-tag benny">Energetic</span>
                                <span class="monster-tag benny">Loyal</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Nova Card -->
                <div class="monster-card" data-monster="nova" id="novaCard">
                    <div class="monster-card-content">
                        <div class="monster-avatar nova">
                            <img src="assets/eggs/nova_egg.gif" alt="Nova Egg" class="monster-sprite egg-sprite" id="novaSprite" style="animation: none; object-fit: contain; width: 70px; height: 70px; transform: none;">
                        </div>
                        <div class="monster-info">
                            <div class="monster-name">Nova</div>
                            <div class="monster-title">The Fiery Achiever</div>
                            <div class="monster-description">Energetic and ambitious. Nova motivates you to crush goals and achieve greatness at lightning speed.</div>
                            <div class="monster-tags">
                                <span class="monster-tag nova">Curious</span>
                                <span class="monster-tag nova">Optimistic</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step 2: Name Your Monster -->
        <div class="onboarding-step" id="step2">
            <button class="back-button" id="backToStep1">‚Üê</button>
            
            <div class="step-header">
                <h1 class="step-title">Name Your Monster</h1>
                <div class="step-indicators">
                    <div class="step-dot"></div>
                    <div class="step-dot active"></div>
                    <div class="step-dot"></div>
                </div>
                <p class="step-count">Step 2 of 3</p>
            </div>
            
            <div class="selected-monster-display">
                <div class="selected-monster-avatar" id="selectedAvatar">
                    <img src="" alt="Selected Monster" class="selected-monster-sprite" id="selectedSprite">
                </div>
                <div class="monster-name" id="selectedName"></div>
                <div class="monster-title" id="selectedTitle"></div>
                <div class="monster-description" id="selectedDescription"></div>
                <div class="monster-tags" id="selectedTags"></div>
            </div>
            
            <div class="name-input-container">
                <p class="step-subtitle">Give your monster a name</p>
                <input type="text" class="name-input" id="monsterNameInput" maxlength="15" placeholder="Enter a name">
                <p class="name-hint">Maximum 15 characters</p>
            </div>
        </div>
        
        <!-- Step 3: Confirmation -->
        <div class="onboarding-step" id="step3">
            <button class="back-button" id="backToStep2">‚Üê</button>
            
            <div class="step-header">
                <h1 class="step-title">Ready to Start!</h1>
                <div class="step-indicators">
                    <div class="step-dot"></div>
                    <div class="step-dot"></div>
                    <div class="step-dot active"></div>
                </div>
                <p class="step-count">Step 3 of 3</p>
            </div>
            
            <div class="selected-monster-display">
                <div class="selected-monster-avatar" id="confirmAvatar">
                    <img src="" alt="Your Monster" class="selected-monster-sprite" id="confirmSprite">
                </div>
            </div>
            
            <div class="confirmation-message">
                <p>Your monster will be called</p>
                <p><strong id="confirmName"></strong></p>
            </div>
            
            <!-- Egg System Info Banner -->
            <div class="egg-info-banner">
                <div class="egg-info-icon">ü•ö</div>
                <h3 class="egg-info-title">Your Monster Starts as an Egg!</h3>
                <p class="egg-info-description">
                    Complete tasks to level up! Your egg will hatch at Level 5!
                </p>
            </div>
        </div>
        
    </div>
    
    <!-- Continue Button (Sticky at bottom) -->
    <button class="onboarding-button" id="continueButton" disabled>Continue</button>
</div>

<!-- Confetti Canvas -->
<canvas id="confetti-canvas" style="position: fixed; inset: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 9999;"></canvas>

<!-- Battle Arena -->
<!-- BATTLE ARENA: Full-Screen Two-Part Layout -->
<div id="battleArena" class="battle-arena hidden">
    <div class="battle-container">
        <!-- Hero Side -->
        <div class="sprite-container" id="heroContainer">
            <div class="sprite-wrapper">
                <div id="heroSprite" class="sprite idle"></div>
            </div>
            <div class="hp-bar-container">
                <div class="hp-label">
                    <span>HP</span>
                    <span id="heroHPText">100/100</span>
                </div>
                <div class="hp-bar-bg">
                    <div id="heroHPBar" class="hp-bar-fill" style="width: 100%;"></div>
                </div>
            </div>
        </div>


        <!-- Enemy Side -->
        <div class="sprite-container" id="enemyContainer">
            <div class="sprite-wrapper">
                <div id="enemySprite" class="sprite"></div>
            </div>
            <div class="hp-bar-container">
                <div class="hp-label">
                    <span>HP</span>
                    <span id="enemyHPText">50/50</span>
                </div>
                <div class="hp-bar-bg">
                    <div id="enemyHPBar" class="hp-bar-fill" style="width: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- Turn Timer (between HP gauges) -->
        <div id="turnTimer" class="turn-timer hidden">
            <div class="timer-bar-bg">
                <div id="timerBar" class="timer-bar-fill"></div>
            </div>
            <div id="timerText" class="timer-text">5</div>
        </div>
    </div>

    <!-- Battle Log (moved inside battle scene) -->
    <div id="battleLog" class="battle-log"></div>

    <!-- Gauges -->
    <div class="gauge-container">
        <div class="gauge" id="specialAttackGaugeContainer">
            <div class="gauge-label">
                <span>‚ö° Special Attack</span>
                <span id="specialGaugeText">0/100</span>
            </div>
            <div class="gauge-bar-bg">
                <div id="specialGaugeBar" class="gauge-bar-fill" style="width: 0%; background: linear-gradient(90deg, #a855f7 0%, #ec4899 50%, #f59e0b 100%);"></div>
            </div>
        </div>
        <div class="gauge">
            <div class="gauge-label">
                <span>‚öîÔ∏è Attack Gauge</span>
                <span id="attackGaugeText">0/100</span>
            </div>
            <div class="gauge-bar-bg">
                <div id="attackGaugeBar" class="gauge-bar-fill attack-gauge-fill" style="width: 0%;"></div>
            </div>
        </div>
        <div class="gauge">
            <div class="gauge-label">
                <span>üõ°Ô∏è Defense Gauge</span>
                <span id="defenseGaugeText">0/100</span>
            </div>
            <div class="gauge-bar-bg">
                <div id="defenseGaugeBar" class="gauge-bar-fill defense-gauge-fill" style="width: 0%;"></div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button id="btnAttack" class="btn-action" onclick="battleManager.playerAttack()">
            ‚öîÔ∏è Attack
        </button>
        <button id="btnDefend" class="btn-action" onclick="battleManager.playerDefend()">
            ü™® Defend
        </button>
        <button id="btnSpecialAttack" class="btn-action" onclick="playerSpecialAttack()">
            ‚ö° Special Attack
        </button>
        <button id="btnFireball" class="btn-action" onclick="battleManager.playerFireball()">
            üî• Fireball <span class="item-count" id="fireballCount">(0)</span>
        </button>
        <button id="btnSpark" class="btn-action" onclick="battleManager.playerSpark()" style="display: none;">
            ‚ö° Spark <span class="item-count" id="sparkCount">(0)</span>
        </button>
        <button id="btnAsteroid" class="btn-action" onclick="battleManager.playerAsteroid()" style="display: none;">
            ü™® Asteroid Attack <span class="item-count" id="asteroidCount">(0)</span>
        </button>
        <button id="btnPrickler" class="btn-action" onclick="battleManager.playerPrickler()" style="display: none;">
            üí£ Prickler <span class="item-count" id="pricklerCount">(0)</span>
        </button>
        <button id="btnFreeze" class="btn-action" onclick="battleManager.playerFreeze()" style="display: none;">
            ‚ùÑÔ∏è Freeze <span class="item-count" id="freezeCount">(0)</span>
        </button>
        <button id="btnPotion" class="btn-action" onclick="battleManager.playerPotion()">
            üß™ Potion <span class="item-count" id="potionCount">(2)</span>
        </button>
        <button id="btnHyperPotion" class="btn-action" onclick="battleManager.playerHyperPotion()">
            ‚ù§Ô∏è‚Äçü©π Hyper Potion <span class="item-count" id="hyperPotionCount">(0)</span>
        </button>
        <button id="btnAttackRefill" class="btn-action" onclick="battleManager.playerAttackRefill()">
            ‚ö° Attack+ <span class="item-count" id="attackRefillCount">(0)</span>
        </button>
        <button id="btnDefenseRefill" class="btn-action" onclick="battleManager.playerDefenseRefill()">
            üõ°Ô∏è Defense+ <span class="item-count" id="defenseRefillCount">(0)</span>
        </button>
        <button id="btnInvisibilityCloak" class="btn-action" onclick="battleManager.playerInvisibilityCloak()">
            ü•∑üèº Cloak <span class="item-count" id="invisibilityCloakCount">(0)</span>
        </button>
        <button id="btnMirrorAttack" class="btn-action" onclick="battleManager.playerMirrorAttack()" style="display: none;">
            ü™û Mirror <span class="item-count" id="mirrorAttackCount">(0)</span>
        </button>
        <button id="btnBlueFlame" class="btn-action" onclick="battleManager.playerBlueFlame()" style="display: none;">
            <img src="assets/blue-flame-icon.png" alt="Blue Flame" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 4px;"> Blue Flame <span class="item-count" id="blueFlameCount">(0)</span>
        </button>
        <button id="btnProcrastinationGhost" class="btn-action" onclick="battleManager.playerProcrastinationGhost()" style="display: none;">
            üëª Ghost <span class="item-count" id="procrastinationGhostCount">(0)</span>
        </button>
        <button id="btnThrowingStar" class="btn-action" onclick="battleManager.playerThrowingStar()" style="display: none;">
            ‚≠ê Throwing Star <span class="item-count" id="throwingStarCount">(0)</span>
        </button>
        <button id="btnBattleGlove" class="btn-action" onclick="battleManager.playerBattleGlove()" style="display: none;">
            ü•ä Battle Glove <span class="item-count" id="battleGloveCount">(0)</span>
        </button>
        <button id="btnJadeDagger" class="btn-action" onclick="battleManager.playerJadeDagger()" style="display: none;">
            üó°Ô∏è Jade Dagger <span class="item-count" id="jadeDaggerCount">(0)</span>
        </button>
        <button id="btnWizardsWand" class="btn-action" onclick="battleManager.playerWizardsWand()" style="display: none;">
            ü™Ñ Wizard's Wand <span class="item-count" id="wizardsWandCount">(0)</span>
        </button>
        <button id="btnFlee" class="btn-flee" onclick="battleManager.playerFlee()">
            üèÉ Flee
        </button>
    </div>
</div>

<!-- Fireball Projectile -->
<div id="fireballProjectile" class="fireball-projectile hidden"></div>

<!-- Explosion Effect -->
<div id="explosionEffect" class="explosion-effect hidden"></div>

<!-- Quest Giver UI -->
<div id="questGiverUI" class="quest-giver-overlay hidden">
    <!-- Forest Scene with Bird -->
    <div class="quest-scene">
        <div id="questCrowSprite" class="quest-crow-sprite"></div>
    </div>
    
    <!-- Dialogue Container -->
    <div class="quest-dialogue-container">
        <div class="quest-dialogue-header">
            <span class="quest-dialogue-label">Merlin</span>
        </div>
        <div id="questDialogue" class="quest-dialogue-text">
            <!-- Wise dialogue will be inserted here -->
        </div>
    </div>
    
    <!-- Quest Actions (Accept/Decline) -->
    <div id="questActions" class="quest-actions hidden">
        <button class="quest-btn quest-btn-accept" onclick="questGiver.acceptQuest()">‚ú® Accept Quest</button>
        <button class="quest-btn quest-btn-decline" onclick="questGiver.declineQuest()">Pass</button>
    </div>
    
    <!-- Quiz Actions -->
    <div id="quizActions" class="quest-actions hidden">
        <div id="quizOptions">
            <!-- Quiz options will be inserted here -->
        </div>
    </div>
</div>

<!-- Loading Screen -->
<div class="loading-screen" id="loadingScreen">
    <img alt="Task Monsters" class="loading-brand" src="assets/logo/loading-screen.png"/>
    <div class="loading-spinner"></div>
    <div class="loading-text"></div>
</div>

<div class="app-container">
    <!-- Pet Rock Header -->
    <div class="pet-rock-header" style="position: relative; background-image: url('assets/backgrounds/default-bg.png'); background-size: cover; background-position: center; padding: 40px 20px 30px 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;">

        <div class="creature-container" style="position: relative; z-index: 100; display: flex; flex-direction: column; align-items: center; gap: 8px; margin-top: 40px;">
            <!-- BUG FIX: Outer container has overflow visible to prevent cropping scaled sprite -->
            <!-- Inner wrapper has overflow hidden to clip sprite sheet to single frame -->
            <div style="width: 180px; height: 280px; margin: 30px auto 10px; padding-top: 80px; overflow: visible; position: relative; display: flex; align-items: center; justify-content: center;">
                <!-- Task Pal Tooltip -->
                <div id="taskPalTooltip" class="task-pal-tooltip"></div>
                <!-- CRITICAL: Wrapper div to contain the scaled sprite, overflow hidden to show only 1 frame -->
                <div class="monster-container" style="width: 128px; height: 256px; overflow: visible; position: relative; display: flex; align-items: center; justify-content: center; z-index: 100;">
                    <img alt="Hero" id="mainHeroSprite" src="assets/heroes/Nova_idle.gif" style="width: 32px !important; height: 32px !important; image-rendering: pixelated; object-fit: contain !important; object-position: center; transform: scale(4); transform-origin: center center; opacity: 1; display: block; will-change: transform; backface-visibility: hidden;"/>
                </div>
            </div>
            
            <!-- RPG Stat Gauges -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 16px auto 0; max-width: 500px; padding: 0 10px;">
                <!-- Energy Gauge -->
                <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 16px 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2);">
                    <div style="font-size: 28px; text-align: center; margin-bottom: 8px;">‚ö°</div>
                    <div style="font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.7); text-align: center; margin-bottom: 8px; letter-spacing: 0.5px;">HP</div>
                    <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                        <div id="energyFill" style="height: 100%; background: linear-gradient(90deg, #10b981 0%, #3b82f6 100%); width: 75%; transition: width 0.3s ease-in-out;"></div>
                    </div>
                    <div id="energyText" style="font-size: 14px; font-weight: 700; color: #fff; text-align: center;">75/100</div>
                </div>
                
                <!-- Attack Gauge -->
                <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 16px 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2);">
                    <div style="font-size: 28px; text-align: center; margin-bottom: 8px;">‚öîÔ∏è</div>
                    <div style="font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.7); text-align: center; margin-bottom: 8px; letter-spacing: 0.5px;">ATTACK</div>
                    <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                        <div id="attackFill" style="height: 100%; background: linear-gradient(90deg, #ef4444 0%, #f97316 50%, #ec4899 100%); width: 60%; transition: width 0.3s ease-in-out;"></div>
                    </div>
                    <div id="attackText" style="font-size: 14px; font-weight: 700; color: #fff; text-align: center;">60/100</div>
                </div>
                
                <!-- Defense Gauge -->
                <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 16px 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2);">
                    <div style="font-size: 28px; text-align: center; margin-bottom: 8px;">üõ°Ô∏è</div>
                    <div style="font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.7); text-align: center; margin-bottom: 8px; letter-spacing: 0.5px;">DEFENSE</div>
                    <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                        <div id="defenseFill" style="height: 100%; background: linear-gradient(90deg, #8b5cf6 0%, #3b82f6 100%); width: 85%; transition: width 0.3s ease-in-out;"></div>
                    </div>
                    <div id="defenseText" style="font-size: 14px; font-weight: 700; color: #fff; text-align: center;">85/100</div>
                </div>
            </div>
            
            <!-- XP Bar -->
            <div style="margin: 16px auto 0; max-width: 500px; padding: 0 10px;">
                <div style="padding: 16px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2);">
                    <!-- Level | Name Header -->
                    <div id="levelLabel" style="text-align: center; font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.9); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); margin-bottom: 8px; letter-spacing: 0.3px;">Jerry | Level 1</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 16px;">
                        <div style="font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9); white-space: nowrap;">Experience Points</div>
                        <div id="xpText" style="font-size: 13px; font-weight: 700; color: #fff; white-space: nowrap;">0 / 1,000 XP</div>
                    </div>
                    <div style="width: 100%; height: 12px; background: rgba(0,0,0,0.3); border-radius: 6px; overflow: hidden;">
                        <div id="xpFill" style="height: 100%; background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%); width: 0%; transition: width 0.3s ease-in-out;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Battle system triggers automatically after completing tasks (40% chance) -->
        </div>
    </div>

    <!-- Planner Section with Budget-style design -->
    <section id="plannerSection">
        <!-- Expandable Stats Section -->
        <div class="stats-section">
            <div class="stats-header" onclick="toggleStatsExpansion()">
                <div class="stats-title">üîç Statistics</div>
                <div class="stats-toggle" id="statsToggle">‚ñº</div>
            </div>
            
            <!-- Collapsed view: 3 main stats -->
            <div class="stats-row stats-collapsed" id="statsCollapsed">
                <div class="stat-tile">
                    <div class="stat-icon">üöÄ</div>
                    <div class="stat-value" id="quickTasksDisplay">0</div>
                    <div class="stat-label">Pending Quick Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-value" id="pendingTasksDisplay">0</div>
                    <div class="stat-label">Pending Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value" id="completedTasksDisplay">0</div>
                    <div class="stat-label">Completed Tasks</div>
                </div>
            </div>
            
            <!-- Expanded view: All stats -->
            <div class="stats-grid stats-expanded" id="statsExpanded" style="display: none;">
                <div class="stat-tile">
                    <div class="stat-icon">üöÄ</div>
                    <div class="stat-value" id="quickTasksDisplayExp">0</div>
                    <div class="stat-label">Pending Quick Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-value" id="pendingTasksDisplayExp">0</div>
                    <div class="stat-label">Pending Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value" id="completedTasksDisplayExp">0</div>
                    <div class="stat-label">Completed Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">‚úîÔ∏è</div>
                    <div class="stat-value" id="completedQuickTasksDisplayExp">0</div>
                    <div class="stat-label">Completed Quick Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-value" id="completionRateDisplay">0%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value" id="totalTasksDisplay">0</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">üî•</div>
                    <div class="stat-value" id="currentStreakDisplay">0</div>
                    <div class="stat-label">Current Streak</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-value" id="bestStreakDisplay">0</div>
                    <div class="stat-label">Best Streak</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-value" id="rockLevelDisplay">1</div>
                    <div class="stat-label">Hero Level</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-value" id="experienceDisplay">0/100 XP</div>
                    <div class="stat-label">Experience</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">ü•á</div>
                    <div class="stat-value" id="achievementsDisplay">0/10</div>
                    <div class="stat-label">Achievements</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">‚öîÔ∏è</div>
                    <div class="stat-value" id="battlesWonDisplay">0</div>
                    <div class="stat-label">Battles Won</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">üí•</div>
                    <div class="stat-value" id="battlesLostDisplay">0</div>
                    <div class="stat-label">Battles Lost</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">üß†</div>
                    <div class="stat-value" id="quizPassedDisplay">0</div>
                    <div class="stat-label">Quizzes Passed</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-value" id="quizFailedDisplay">0</div>
                    <div class="stat-label">Quizzes Failed</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">üìù</div>
                    <div class="stat-value" id="questAcceptanceDisplay">0%</div>
                    <div class="stat-label">Quest Acceptance</div>
                </div>
            </div>
        </div>

        <!-- Pill tab bar -->
        <div class="pill-tabs">
            <button class="pill-tab" aria-selected="true" onclick="switchToTab('home')">Home</button>
            <button class="pill-tab" aria-selected="false" onclick="switchToTab('achievements')">Achievements</button>
            <button class="pill-tab" aria-selected="false" onclick="switchToTab('habits')">Habits</button>
            <button class="pill-tab" aria-selected="false" onclick="switchToTab('mood')">Mood Tracker</button>
            <button class="pill-tab" aria-selected="false" onclick="switchToTab('shop')">Shop</button>
            <button class="pill-tab" aria-selected="false" onclick="switchToTab('settings')">Settings</button>
        </div>

        <!-- Home tab content -->
        <div id="homeTab" class="tab-content active">
            

            <!-- Daily Challenge - Expandable Section -->
            <div class="daily-challenge-section">
                <div class="daily-challenge-header" onclick="toggleDailyChallengeExpansion()">
                    <div class="daily-challenge-title">üìÖ Daily Challenge</div>
                    <div class="daily-challenge-toggle" id="dailyChallengeToggle">‚ñº</div>
                </div>
                <div class="daily-challenge-content" id="dailyChallengeContent" style="display: block;">
                    <div id="dailyChallengeDisplay">
                        <!-- Daily challenge will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Focus Timer -->
            <div class="daily-challenge-section" id="focusTimerCard">
                <div class="daily-challenge-header" onclick="toggleFocusTimerExpansion()">
                    <div class="daily-challenge-title">‚è±Ô∏è Focus Timer</div>
                    <div class="daily-challenge-toggle" id="focusTimerToggle">‚ñº</div>
                </div>
                <div class="daily-challenge-content" id="focusTimerContent" style="display: none;">
                    <div style="padding: 16px 20px;">
                        <!-- Instructional text about attack bonus -->
                        <div id="focusTimerInfoBox" style="display: none; background: linear-gradient(135deg, rgba(255, 69, 0, 0.15) 0%, rgba(255, 140, 0, 0.15) 100%); border: 2px solid rgba(255, 69, 0, 0.4); border-radius: 8px; padding: 14px 50px 14px 14px; margin-bottom: 16px; text-align: center; box-shadow: 0 0 15px rgba(255, 69, 0, 0.2); position: relative;">
                            <button id="toggleFocusInfo" onclick="toggleFocusTimerInfo()" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255, 69, 0, 0.5); color: var(--text-primary); border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer; transition: all 0.2s; z-index: 10;" onmouseover="this.style.background='rgba(0,0,0,0.5)'" onmouseout="this.style.background='rgba(0,0,0,0.3)'">Hide</button>
                            <div style="font-size: 14px; color: var(--text-primary); line-height: 1.6; font-weight: 500;">
                                üî• <strong style="color: #ff6b35;">FOCUS POWER:</strong> Temporarily increases your monster's <strong style="color: #ff4500;">attack strength</strong> in battle!<br>
                                <span style="font-size: 12px; opacity: 0.9;">Using the Focus Timer builds up power that randomly triggers during battle for a devastating <strong>25-35 damage</strong> special attack (one-time use per battle)</span>
                            </div>
                        </div>
                        <button id="showFocusInfo" onclick="toggleFocusTimerInfo()" style="display: block; background: rgba(255, 69, 0, 0.2); border: 2px solid rgba(255, 69, 0, 0.4); color: var(--text-primary); border-radius: 8px; padding: 10px; margin-bottom: 16px; font-size: 13px; cursor: pointer; width: 100%; transition: all 0.2s;" onmouseover="this.style.background='rgba(255, 69, 0, 0.3)'" onmouseout="this.style.background='rgba(255, 69, 0, 0.2)'">‚ÑπÔ∏è Show Focus Power Info</button>
                        <label for="focusDuration" style="display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary);">Set Timer (minutes):</label>
                        <input type="number" id="focusDuration" min="1" max="180" value="25" class="form-input" style="margin-bottom: 16px;">
                        <!-- Focus Timer Monster Animation -->
                        <div id="focusTimerMonsterContainer" style="position: relative; width: 100%; max-width: 400px; height: 300px; margin: 0 auto 20px auto; display: none; align-items: center; justify-content: center; overflow: visible; padding: 30px;">
                            <div style="width: 64px; height: 128px; overflow: visible; display: flex; align-items: center; justify-content: center; transform: scale(1); transform-origin: center center;">
                                <img id="focusTimerMonsterSprite" src="assets/heroes/Nova_idle.gif" alt="Monster" style="width: 32px; height: 32px; max-width: 64px; max-height: 128px; image-rendering: pixelated; object-fit: none; object-position: 0 0; display: block; animation: none;">
                            </div>
                        </div>
                        <div id="focusTimerDisplay" style="font-size: 48px; font-weight: 700; text-align: center; margin: 20px 0; color: var(--text-primary);">25:00</div>
                        <div style="display: flex; gap: 12px;">
                            <button id="startFocusTimer" class="btn-primary" style="flex: 1;">Start</button>
                            <button id="pauseFocusTimer" class="btn-secondary" style="flex: 1; display: none;">Pause</button>
                            <button id="stopFocusTimer" class="btn-secondary" style="flex: 1;">Stop</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quest Tasks -->
            <div class="card quest-tasks-card" id="questTasksCard" style="display: none;">
                <div class="card-header quest-tasks-header">
                    <div class="card-title">üèÜ Quest Tasks</div>
                    <div class="quest-tasks-subtitle">Special quests from Merlin</div>
                </div>
                <div id="questTasksList">
                    <!-- Quest tasks will be populated here -->
                </div>
            </div>



            <!-- Your Tasks -->
            <div class="card">
                <div class="card-header" style="cursor: pointer;" onclick="toggleYourTasksExpansion(event)">
                    <div class="card-title">üìù Your Tasks <span id="yourTasksToggleIcon">‚ñ≤</span></div>
                    <button class="btn-primary" onclick="event.stopPropagation(); openCreateTaskModal()">+ Add</button>
                </div>
                <div id="tasksList">
                    <!-- Tasks will be populated here -->
                </div>
            </div>

            <!-- Quick Tasks -->
            <div class="card">
                <div class="card-header" style="cursor: pointer;" onclick="toggleQuickTasksExpansion(event)">
                    <div class="card-title">‚ö° Quick Tasks <span id="quickTasksToggleIcon">‚ñ≤</span></div>
                    <button class="btn-primary" onclick="event.stopPropagation(); openQuickTaskModal()">+ Add</button>
                </div>
                <div id="quickTasksList">
                    <!-- Quick tasks will be populated here -->
                </div>
            </div>
        </div>

        <!-- Achievements tab content -->
        <div id="achievementsTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üèÜ Achievements</div>
                </div>
                
                <!-- Achievement Filter Tabs -->
                <div class="achievement-filter-tabs">
                    <button class="achievement-filter-btn active" data-filter="all" onclick="filterAchievements('all')">
                        üéØ All
                    </button>
                    <button class="achievement-filter-btn" data-filter="completed" onclick="filterAchievements('completed')">
                        ‚úÖ Completed
                    </button>
                    <button class="achievement-filter-btn" data-filter="incomplete" onclick="filterAchievements('incomplete')">
                        üîí In Progress
                    </button>
                </div>
                
                <!-- Achievement Stats Summary -->
                <div class="achievement-stats-summary">
                    <span id="achievementCompletedCount">0</span> / <span id="achievementTotalCount">0</span> Completed
                    <div class="achievement-progress-bar">
                        <div id="achievementProgressFill" class="achievement-progress-fill"></div>
                    </div>
                </div>
                
                <div id="achievementsList">
                    <!-- Achievements will be populated here -->
                </div>
            </div>
        </div>

        <!-- Shop tab content -->
        <div id="shopTab" class="tab-content">
            <!-- Shop Sub-Tabs -->
            <div class="shop-sub-tabs">
                <button class="pill-tab-shop active" onclick="switchShopSubTab('shop')">Shop</button>
                <button class="pill-tab-shop" onclick="switchShopSubTab('owned')">Inventory</button>
                <button class="pill-tab-shop" onclick="switchShopSubTab('skins')">Skins</button>
                <button class="pill-tab-shop" onclick="switchShopSubTab('themes')">Themes</button>
            </div>

            <!-- Shop Sub-Tab Content -->
            <div id="shopSubTabContent" class="shop-sub-content active">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üõçÔ∏è Shop</div>
                        <span id="shopItemCount" class="item-count-badge">0 items</span>
                    </div>
                    <div style="padding: 0 0 20px 0;">
                        <p style="text-align: center; color: #666; margin-bottom: 10px;">Power up your hero with XP!</p>
                        <p style="text-align: center; color: #4CAF50; font-weight: bold; margin-bottom: 20px;">XP Coins: <span id="xpCoinsShop">0</span></p>
                        <div id="shopItemsGrid" class="shop-items-grid">
                            <!-- Shop items will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Owned Sub-Tab Content -->
            <div id="ownedSubTabContent" class="shop-sub-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üéí Battle Items</div>
                        <span id="ownedItemCount" class="item-count-badge">0 items</span>
                    </div>
                    <div style="padding: 0 0 20px 0;">
                        <p style="text-align: center; color: #666; margin-bottom: 10px;">Use your items in battle!</p>
                        <p style="text-align: center; color: #4CAF50; font-weight: bold; margin-bottom: 20px;">XP Coins: <span id="xpCoinsOwned">0</span></p>
                    </div>
                    <div id="ownedItemsGrid" class="owned-items-grid">
                        <!-- Owned items will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Skins Sub-Tab Content -->
            <div id="skinsSubTabContent" class="shop-sub-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üé® Monster Skins - Shop</div>
                        <span id="skinsShopCount" class="item-count-badge">18 skins</span>
                    </div>
                    <div style="padding: 0 0 20px 0;">
                        <p style="text-align: center; color: #666; margin-bottom: 10px;">Customize your monster's appearance!</p>
                        <p style="text-align: center; color: #4CAF50; font-weight: bold; margin-bottom: 20px;">XP Coins: <span id="xpCoinsSkins">0</span></p>
                        <div id="skinsShopGrid" class="shop-items-grid">
                            <!-- Skins shop will be rendered here -->
                        </div>
                    </div>
                </div>
                
                <!-- Inventory section removed - equip/unequip now happens directly on shop cards -->
            </div>

            <!-- Themes Sub-Tab Content -->
            <div id="themesSubTabContent" class="shop-sub-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üé® Background Themes</div>
                        <span id="themesCount" class="item-count-badge">12 themes</span>
                    </div>
                    <div style="padding: 0 0 20px 0;">
                        <p style="text-align: center; color: #666; margin-bottom: 10px;">Customize your monster's background!</p>
                        <p style="text-align: center; color: #4CAF50; font-weight: bold; margin-bottom: 20px;">XP Coins: <span id="xpCoinsThemes">0</span></p>
                        <div id="themesGrid" class="owned-items-grid">
                            <!-- Themes will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Habits tab content -->
        <div id="habitsTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìä Habit Tracker</div>
                    <button class="btn-secondary" onclick="resetHabitStats()" style="font-size: 12px; padding: 8px 12px;">Reset Stats</button>
                </div>
                <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">
                    Track your task completion patterns and discover your productivity habits!
                </p>
            </div>

            <!-- Overview Stats -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìà Overview</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-tile">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="habitTotalTasks">0</div>
                        <div class="stat-label">Total Tasks</div>
                    </div>
                    <div class="stat-tile">
                        <div class="stat-icon">‚ö°</div>
                        <div class="stat-value" id="habitTotalQuickTasks">0</div>
                        <div class="stat-label">Quick Tasks</div>
                    </div>
                    <div class="stat-tile">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-value" id="habitMostCompleted">‚Äî</div>
                        <div class="stat-label">Top Category</div>
                    </div>
                </div>
            </div>

            <!-- Task Categories -->
            <div class="card collapsible-card">
                <div class="card-header collapsible-header" onclick="toggleHabitSection('taskCategories')" style="cursor: pointer;">
                    <div class="card-title">üìÇ Task Categories</div>
                    <span id="taskCategoriesToggle" class="collapse-toggle">‚ñ≤</span>
                </div>
                <div id="habitCategoriesChart" class="collapsible-content" style="padding: 0;">
                    <!-- Category bars will be populated here -->
                </div>
            </div>

            <!-- Quick Task Categories -->
            <div class="card collapsible-card">
                <div class="card-header collapsible-header" onclick="toggleHabitSection('quickTaskCategories')" style="cursor: pointer;">
                    <div class="card-title">‚ö° Quick Task Categories</div>
                    <span id="quickTaskCategoriesToggle" class="collapse-toggle">‚ñ≤</span>
                </div>
                <div id="habitQuickTaskChart" class="collapsible-content" style="padding: 0;">
                    <!-- Quick task category bars will be populated here -->
                </div>
            </div>

            <!-- Difficulty Distribution -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üí™ Difficulty Distribution</div>
                </div>
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-tile">
                        <div class="stat-icon">üòä</div>
                        <div class="stat-value" id="habitEasyPercent">0%</div>
                        <div class="stat-label">Easy</div>
                    </div>
                    <div class="stat-tile">
                        <div class="stat-icon">üòê</div>
                        <div class="stat-value" id="habitMediumPercent">0%</div>
                        <div class="stat-label">Medium</div>
                    </div>
                    <div class="stat-tile">
                        <div class="stat-icon">üò§</div>
                        <div class="stat-value" id="habitHardPercent">0%</div>
                        <div class="stat-label">Hard</div>
                    </div>
                </div>
            </div>

            <!-- Priority Distribution -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üéØ Priority Distribution</div>
                </div>
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-tile">
                        <div class="stat-icon" style="color: #22c55e;">üü¢</div>
                        <div class="stat-value" id="habitLowPercent">0%</div>
                        <div class="stat-label">Low Priority</div>
                    </div>
                    <div class="stat-tile">
                        <div class="stat-icon" style="color: #f59e0b;">üü°</div>
                        <div class="stat-value" id="habitMediumPriorityPercent">0%</div>
                        <div class="stat-label">Medium Priority</div>
                    </div>
                    <div class="stat-tile">
                        <div class="stat-icon" style="color: #ef4444;">üî¥</div>
                        <div class="stat-value" id="habitHighPercent">0%</div>
                        <div class="stat-label">High Priority</div>
                    </div>
                </div>
            </div>






        </div>

        <!-- Mood Tracker tab content -->
        <div id="moodTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üòä Mood Tracker</div>
                </div>
                <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">
                    Track your emotional patterns and discover insights about your well-being!
                </p>
            </div>

            <!-- Encouraging Message Container -->
            <div class="card" id="moodEncouragementContainer" style="display: none;"></div>
            
            <!-- Filters -->
            <div class="card">
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 150px;">
                        <label style="display: block; color: var(--text-secondary); font-size: 13px; margin-bottom: 6px;">Filter by Date</label>
                        <select id="moodDateFilter" style="
                            width: 100%;
                            padding: 10px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(139, 92, 246, 0.3);
                            border-radius: 8px;
                            color: #fff;
                            font-size: 14px;
                            cursor: pointer;
                        ">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">Past Week</option>
                            <option value="month">Past Month</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <label style="display: block; color: var(--text-secondary); font-size: 13px; margin-bottom: 6px;">Filter by Mood</label>
                        <select id="moodTypeFilter" style="
                            width: 100%;
                            padding: 10px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(139, 92, 246, 0.3);
                            border-radius: 8px;
                            color: #fff;
                            font-size: 14px;
                            cursor: pointer;
                        ">
                            <option value="all">All Moods</option>
                            <option value="happy">üòä Happy</option>
                            <option value="sad">üò¢ Sad</option>
                            <option value="meh">ü´§ Meh</option>
                            <option value="angry">üò° Angry</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Mood History Container -->
            <div class="card">
                <div id="moodHistoryContainer" style="max-height: 500px; overflow-y: auto; padding: 4px;">
                    <!-- Moods will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Settings tab content -->
        <div id="settingsTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">‚öôÔ∏è Settings</div>
                </div>

                <div class="settings-item">
                    <div class="settings-label">Sound Effects</div>
                    <div class="settings-toggle active" id="soundToggle" onclick="toggleSound()">
                        <div class="settings-toggle-slider"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">Notifications</div>
                    <div class="settings-toggle" id="notificationsToggle" onclick="toggleNotifications()">
                        <div class="settings-toggle-slider"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">Battle Mode</div>
                    <div class="settings-toggle active" id="battleModeToggle" onclick="toggleBattleMode()">
                        <div class="settings-toggle-slider"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">Share Etsy Store</div>
                    <button class="btn-secondary" onclick="shareEtsyStore()">Share</button>
                </div>
                <div class="settings-item">
                    <div class="settings-label">Shop At Our Etsy Store</div>
                    <button class="btn-secondary" onclick="openProductivityOutlet()">View Store</button>
                </div>
                <div class="settings-item">
                    <div class="settings-label">üëæ Change Task Monster's Name</div>
                    <button class="btn-secondary" onclick="openChangeNameModal()">Edit</button>
                </div>



                <div class="settings-item">
                    <div class="settings-label">Reset Progress</div>
                    <button style="background: var(--error); color: white;" class="btn-secondary" onclick="showResetOptions()">Reset</button>
                </div>
            </div>
        </div>

        <!-- Centered FAB -->
        <button class="fab-center" onclick="openCreateTaskModal()">+</button>
    </section>
</div>

<!-- Create Task Modal -->
<div class="modal" id="createTaskModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Create Task</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <form id="taskForm">
                <!-- Template Selector -->
                <div class="form-group">
                    <label class="form-label">üìã Use Template</label>
                    <select class="form-input" id="templateSelector" onchange="applyTaskTemplate()" style="cursor: pointer;">
                        <option value="">Select a template...</option>
                        <optgroup label="üíº Work">
                            <option value="daily-standup">üíº Daily Standup</option>
                            <option value="meeting-prep">üìù Meeting Preparation</option>
                            <option value="project-planning">üìä Project Planning</option>
                        </optgroup>
                        <optgroup label="üèÉ Fitness">
                            <option value="daily-workout">üèãÔ∏è Daily Workout</option>
                            <option value="morning-run">üèÉ Morning Run</option>
                            <option value="yoga-session">üßò Yoga Session</option>
                        </optgroup>
                        <optgroup label="üß† Mindfulness">
                            <option value="meditation">üßò Meditation Session</option>
                            <option value="gratitude-journal">üôè Gratitude Journal</option>
                            <option value="breathing-exercise">üå¨Ô∏è Breathing Exercise</option>
                        </optgroup>
                        <optgroup label="üìö Learning">
                            <option value="book-outline">üìñ Book Outline</option>
                            <option value="study-session">üìö Study Session</option>
                            <option value="weekly-review">üìä Weekly Review</option>
                        </optgroup>
                        <optgroup label="üè† Home">
                            <option value="cleaning-routine">üßπ Cleaning Routine</option>
                            <option value="meal-prep">üç≥ Meal Prep</option>
                            <option value="grocery-shopping">üõí Grocery Shopping</option>
                        </optgroup>
                        <optgroup label="üå± Self-Help">
                            <option value="morning-routine">‚òÄÔ∏è Morning Routine</option>
                            <option value="evening-routine">üåô Evening Routine</option>
                            <option value="goal-setting">üéØ Goal Setting</option>
                        </optgroup>
                        <optgroup label="üò¥ Sleep">
                            <option value="bedtime-routine">üò¥ Bedtime Routine</option>
                            <option value="sleep-hygiene">üåô Sleep Hygiene</option>
                        </optgroup>
                        <optgroup label="üí™ Health">
                            <option value="health-checkup">üè• Health Check-up</option>
                            <option value="medication-tracker">üíä Daily Medication</option>
                        </optgroup>
                        <optgroup label="üíö Wellness">
                            <option value="self-care-day">üõÅ Self-Care Day</option>
                            <option value="mental-health-check">üß† Mental Health Check-in</option>
                        </optgroup>
                        <optgroup label="üé® Creative">
                            <option value="creative-project">üé≠ Creative Project</option>
                            <option value="daily-creativity">‚ú® Daily Creative Practice</option>
                        </optgroup>
                        <optgroup label="üí∞ Finance">
                            <option value="budget-review">üìä Budget Review</option>
                            <option value="bill-payment">üí≥ Monthly Bills</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Task Title</label>
                    <input class="form-input" id="taskTitle" placeholder="Enter task title" required type="text"/>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description (Optional)</label>
                    <textarea class="form-textarea" id="taskDescription" placeholder="Enter task description"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <div class="selection-grid">
                        <div class="selection-item" data-category="work" onclick="selectCategory('work')">
                            <div class="selection-item-emoji">üíº</div>
                            <div class="selection-item-text">Work</div>
                        </div>
                        <div class="selection-item" data-category="learning" onclick="selectCategory('learning')">
                            <div class="selection-item-emoji">üéì</div>
                            <div class="selection-item-text">Learning</div>
                        </div>
                        <div class="selection-item" data-category="home" onclick="selectCategory('home')">
                            <div class="selection-item-emoji">üè†</div>
                            <div class="selection-item-text">Home</div>
                        </div>
                        <div class="selection-item" data-category="finance" onclick="selectCategory('finance')">
                            <div class="selection-item-emoji">üí∞</div>
                            <div class="selection-item-text">Finance</div>
                        </div>
                        <div class="selection-item" data-category="goals" onclick="selectCategory('goals')">
                            <div class="selection-item-emoji">üéØ</div>
                            <div class="selection-item-text">Goals</div>
                        </div>
                        <div class="selection-item" data-category="projects" onclick="selectCategory('projects')">
                            <div class="selection-item-emoji">üõ†Ô∏è</div>
                            <div class="selection-item-text">Projects</div>
                        </div>
                        <div class="selection-item" data-category="errands" onclick="selectCategory('errands')">
                            <div class="selection-item-emoji">üöó</div>
                            <div class="selection-item-text">Errands</div>
                        </div>
                        <div class="selection-item" data-category="digital" onclick="selectCategory('digital')">
                            <div class="selection-item-emoji">üì±</div>
                            <div class="selection-item-text">Digital</div>
                        </div>
                        <div class="selection-item" data-category="creative" onclick="selectCategory('creative')">
                            <div class="selection-item-emoji">üé®</div>
                            <div class="selection-item-text">Creative</div>
                        </div>
                        <div class="selection-item" data-category="social" onclick="selectCategory('social')">
                            <div class="selection-item-emoji">ü§ùüèΩ</div>
                            <div class="selection-item-text">Social</div>
                        </div>
                        <div class="selection-item" data-category="health" onclick="selectCategory('health')">
                            <div class="selection-item-emoji">üí™</div>
                            <div class="selection-item-text">Health</div>
                        </div>
                        <div class="selection-item" data-category="wellness" onclick="selectCategory('wellness')">
                            <div class="selection-item-emoji">üßò</div>
                            <div class="selection-item-text">Wellness</div>
                        </div>
                        <div class="selection-item" data-category="sleep" onclick="selectCategory('sleep')">
                            <div class="selection-item-emoji">üò¥</div>
                            <div class="selection-item-text">Sleep</div>
                        </div>
                        <div class="selection-item" data-category="self-help" onclick="selectCategory('self-help')">
                            <div class="selection-item-emoji">üå±</div>
                            <div class="selection-item-text">Self-Help</div>
                        </div>
                        <div class="selection-item" data-category="fitness" onclick="selectCategory('fitness')">
                            <div class="selection-item-emoji">üèÉ</div>
                            <div class="selection-item-text">Fitness</div>
                        </div>
                        <div class="selection-item" data-category="mindfulness" onclick="selectCategory('mindfulness')">
                            <div class="selection-item-emoji">üß†</div>
                            <div class="selection-item-text">Mindfulness</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Difficulty</label>
                    <div class="selection-grid">
                        <div class="selection-item" data-difficulty="easy" onclick="selectDifficulty('easy')">
                            <div class="selection-item-emoji">üòä</div>
                            <div class="selection-item-text">Easy (2 pts)</div>
                        </div>
                        <div class="selection-item" data-difficulty="medium" onclick="selectDifficulty('medium')">
                            <div class="selection-item-emoji">üòê</div>
                            <div class="selection-item-text">Medium (5 pts)</div>
                        </div>
                        <div class="selection-item" data-difficulty="hard" onclick="selectDifficulty('hard')">
                            <div class="selection-item-emoji">üò§</div>
                            <div class="selection-item-text">Hard (10 pts)</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <div class="selection-grid">
                        <div class="selection-item" data-priority="low" onclick="selectPriority('low')">
                            <div class="selection-item-emoji">üü¢</div>
                            <div class="selection-item-text">Low Priority</div>
                        </div>
                        <div class="selection-item" data-priority="medium" onclick="selectPriority('medium')">
                            <div class="selection-item-emoji">üü°</div>
                            <div class="selection-item-text">Medium Priority</div>
                        </div>
                        <div class="selection-item" data-priority="high" onclick="selectPriority('high')">
                            <div class="selection-item-emoji">üî¥</div>
                            <div class="selection-item-text">High Priority</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Due Date (Optional)</label>
                    <input class="form-input" id="taskDueDate" type="datetime-local" placeholder="Select date and time" onchange="updateRecurringPreview()"/>
                </div>
                
                <!-- Recurring Task Toggle -->
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="recurringToggle" onchange="toggleRecurringOptions()" style="width: auto; margin: 0;">
                        <span>üîÑ Recurring Task</span>
                    </label>
                    <div id="recurringOptions" style="display: none; margin-top: 12px; padding: 16px; background: var(--bg-tertiary); border-radius: 12px;">
                        <label class="form-label">Frequency</label>
                        <div class="selection-grid" style="grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                            <div class="selection-item" data-recurring="daily" onclick="selectRecurring('daily')" style="min-height: 60px;">
                                <div class="selection-item-text">Daily</div>
                            </div>
                            <div class="selection-item" data-recurring="weekly" onclick="selectRecurring('weekly')" style="min-height: 60px;">
                                <div class="selection-item-text">Weekly</div>
                            </div>
                            <div class="selection-item" data-recurring="monthly" onclick="selectRecurring('monthly')" style="min-height: 60px;">
                                <div class="selection-item-text">Monthly</div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Subtasks Section -->
                <div class="form-group" id="subtasksSection">
                    <label class="form-label">üìã Subtasks</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <input class="form-input" id="newSubtaskInput" placeholder="Add a subtask" type="text" style="flex: 1;" onkeypress="if(event.key==='Enter'){event.preventDefault();addSubtask();}"/>
                        <button type="button" onclick="addSubtask()" style="background: var(--accent-primary); color: var(--bg-primary); border: none; border-radius: 12px; padding: 12px 20px; cursor: pointer; font-weight: 600;">+</button>
                    </div>
                    <div id="subtasksList" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- Subtasks will be rendered here -->
                    </div>
                </div>

            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" style="width: 48%;" onclick="closeModal()">Close</button>
            <button class="btn-primary" style="width: 48%;" onclick="createTask()">Create Task</button>
        </div>
    </div>
</div>

<!-- Quick Task Modal -->
<div class="modal" id="quickTaskModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Add Quick Task</h2>
            <button class="modal-close" onclick="closeQuickTaskModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div id="quickTaskCategories">
                <!-- Quick task categories will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Change Name Modal -->
<div class="modal" id="changeNameModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Change Task Monster's Name</div>
            <button class="modal-close" onclick="closeChangeNameModal()">√ó</button>
        </div>
        <div class="modal-body">
            <label for="newCreatureName" class="form-label">Enter new name:</label>
            <input id="newCreatureName" type="text" class="form-input" maxlength="20" placeholder="e.g., Shadow" />
        </div>
        <div class="modal-footer">
            <button class="btn-primary" onclick="saveNewCreatureName()">Save</button>
        </div>
    </div>
</div>



<script>
        // Game state
        let gameState = {
            rockName: 'Jerry',
            health: 100,
            attack: 5,
            defense: 5,
            jerryLevel: 10, // TEST VERSION: Start at Level 10 (all skins unlocked)
            jerryXP: 500000, // TEST VERSION: 500,000 XP Coins
            jerryCurrentXP: 0,
            jerryXPToNext: Math.floor(100 * Math.pow(1.2, 10 - 1)), // XP needed for level 11
            taskPoints: 0,
            tasks: [],
            completedTasks: 0,
            completedTasksToday: 0,
            totalTasksCreated: 0,
            currentStreak: 0,
            longestStreak: 0,
            bestStreak: 0,
            streakMultiplier: 1,
            lastCompletionDate: null,
            lastDayTracked: null,
            darkMode: false,
            notifications: false,
            selectedQuickTasks: [],
            completedQuickTasks: [],
            ownedSkins: ['imp', 'pig', 'black_cat', 'white_cat', 'brown_cat', 'baby_blue_cat', 'rainbow_cat', 'demonic_cat', 'task_toad', 'task_phantom'], // TEST VERSION: All skins unlocked
            equippedSkinId: null,
            lastQuickTasksDate: null,
            dailyChallenge: null,
            dailyChallengeCompleted: false,
            lastDailyChallengeDate: null,
            isDead: false,
            revivalPoints: 0,
            ownedItems: [],
            funFactsUnlocked: false,
            // Battle stats
            battlesWon: 0,
            battlesLost: 0,
            battleStreak: 0,
            // Quest stats
            questQuizzesPassed: 0,
            questQuizzesFailed: 0,
            questTasksAccepted: 0,
            questTasksOffered: 0,
            quizPerfectStreak: 0,
            // Achievement tracking
            achievementProgress: {},
            unlockedAchievements: {},
            quickTaskStartTimes: {},
            sessionTaskCount: 0,
            sessionStartTime: null,
            tasksCompletedToday: [],
            weekendTasksCompleted: 0,
            allTasksStreakDays: 0,
            lastAllTasksDate: null,
            currentOutfit: {
                hat: null,
                glasses: null,
                mustache: null,
                paint: null
            },
            battleInventory: {
                fireball: 0,
                spark: 0,
                health_potion: 0,
                attack_refill: 0,
                defense_refill: 0,
                invisibility_cloak: 0,
                prickler: 0,
                freeze: 0,
                blue_flame: 0,
                procrastination_ghost: 0
            },
            unlockedBattleItems: ['health_potion', 'attack_refill', 'defense_refill', 'fireball', 'spark', 'invisibility_cloak', 'prickler', 'freeze', 'blue_flame', 'procrastination_ghost'], // TEST VERSION: All battle items unlocked
            xp: 0,
            xpCoins: 500000, // TEST VERSION: 500,000 XP Coins
            // Focus timer tracking
            totalFocusMinutes: 0, // Total minutes spent using focus timer
            // Theme system
            ownedThemes: ['dark_castle', 'night_city', 'ocean_depths', 'mystic_temple', 'cyber_grid', 'synth_city', 'space', 'vampire_castle', 'fort_of_illusion', 'vamp_castle_bg', 'neon_city_sunset', 'bright_town', 'stone_ruins', 'skull_gates', 'dark_gothic_castle'], // TEST VERSION: All themes unlocked
            activeTheme: null, // Currently active theme URL
            // Egg system - Start as an egg, hatch at Level 5
            isEgg: false, // TEST VERSION: Already hatched at level 10
            consecutiveLosses: 0,
            eggRevertedAt: null
        };
        
        // Expose gameState to window for external scripts
        window.gameState = gameState;

        // Task creation variables
        let selectedCategory = null;
        let selectedDifficulty = null;
        let selectedPriority = null;
        let editingTaskIndex = null;
        let editingRecurringTaskId = null;

        // Category mapping
        const categoryMap = {
            'work': { name: 'Work & Career', emoji: 'üíº' },
            'learning': { name: 'Learning & Education', emoji: 'üéì' },
            'home': { name: 'Home & Family', emoji: 'üè†' },
            'finance': { name: 'Finance & Planning', emoji: 'üí∞' },
            'goals': { name: 'Personal Goals', emoji: 'üéØ' },
            'projects': { name: 'Projects & Hobbies', emoji: 'üõ†Ô∏è' },
            'errands': { name: 'Errands & Appointments', emoji: 'üöó' },
            'digital': { name: 'Digital & Technology', emoji: 'üì±' },
            'creative': { name: 'Creative & Arts', emoji: 'üé®' },
            'social': { name: 'Social & Relationships', emoji: 'ü§ùüèΩ' },
            'health': { name: 'Health & Fitness', emoji: 'üí™' },
            'wellness': { name: 'Wellness & Self-Care', emoji: 'üßò' },
            'sleep': { name: 'Sleep & Rest', emoji: 'üò¥' },
            'self-help': { name: 'Self-Help & Growth', emoji: 'üå±' },
            'fitness': { name: 'Fitness & Exercise', emoji: 'üèÉ' },
            'mindfulness': { name: 'Mindfulness & Meditation', emoji: 'üß†' }
        };

        // Quick Tasks Database
        const quickTasksDatabase = {
            'self-care': {
                name: 'Self-Care & Wellness',
                emoji: 'üíÜüèª',
                tasks: [
                    { id: 'brush_teeth', title: 'Brush teeth', emoji: 'ü¶∑', points: 2 },
                    { id: 'wash_face', title: 'Wash my face', emoji: 'üß¥', points: 2 },
                    { id: 'drink_water', title: 'Drink a glass of water', emoji: 'üíß', points: 2 },
                    { id: 'take_vitamins', title: 'Take vitamins', emoji: 'üíä', points: 3 },
                    { id: 'skincare', title: 'Do skincare routine', emoji: 'üß¥', points: 4 },
                    { id: 'shower', title: 'Take a shower', emoji: 'üöø', points: 4 },
                    { id: 'moisturize', title: 'Moisturize skin', emoji: 'üß¥', points: 3 },
                    { id: 'floss', title: 'Floss teeth', emoji: 'ü¶∑', points: 3 }
                ]
            },
            'physical': {
                name: 'Physical Activity',
                emoji: 'üèÉüèæ',
                tasks: [
                    { id: 'pushups', title: 'Do 10 push-ups', emoji: 'üí™üèæ', points: 4 },
                    { id: 'squats', title: 'Do 15 squats', emoji: 'ü¶µüèø', points: 4 },
                    { id: 'plank', title: 'Hold plank for 30 seconds', emoji: 'üèãüèΩ', points: 4 },
                    { id: 'walk', title: 'Take a 10-minute walk', emoji: 'üö∂üèª', points: 5 },
                    { id: 'stretch', title: 'Stretch for 5 minutes', emoji: 'ü§∏üèΩ', points: 3 },
                    { id: 'yoga', title: 'Do yoga poses', emoji: 'üßòüèæ', points: 5 }
                ]
            },
            'sleep': {
                name: 'Sleep & Rest',
                emoji: 'üò¥',
                tasks: [
                    { id: 'screen_warmth', title: 'Turn on screen warmth', emoji: 'üì±', points: 2 },
                    { id: 'no_caffeine', title: 'No caffeine after 2 PM', emoji: '‚òï', points: 3 },
                    { id: 'bedtime_routine', title: 'Start bedtime routine', emoji: 'üõèÔ∏è', points: 4 },
                    { id: 'read_book', title: 'Read before bed', emoji: 'üìö', points: 4 },
                    { id: 'meditation', title: 'Do 5-min meditation', emoji: 'üßòüèª', points: 4 }
                ]
            },
            'tidy': {
                name: 'Tidy Up',
                emoji: 'üßπ',
                tasks: [
                    { id: 'laundry', title: 'Put laundry away', emoji: 'üëï', points: 4 },
                    { id: 'trash', title: 'Take out trash', emoji: 'üóëÔ∏è', points: 3 },
                    { id: 'dishes', title: 'Wash the dishes', emoji: 'üçΩÔ∏è', points: 4 },
                    { id: 'make_bed', title: 'Make the bed', emoji: 'üõèÔ∏è', points: 3 },
                    { id: 'desk_clean', title: 'Clean desk/workspace', emoji: 'üóÇÔ∏è', points: 4 }
                ]
            },
            'mindfulness': {
                name: 'Mindfulness & Mental Health',
                emoji: 'üß†',
                tasks: [
                    { id: 'deep_breaths', title: 'Take 5 deep breaths', emoji: 'ü´Å', points: 2 },
                    { id: 'gratitude', title: 'Think of 3 things grateful for', emoji: 'üôèüèø', points: 3 },
                    { id: 'compliment_self', title: 'Give myself a compliment', emoji: 'üíù', points: 3 },
                    { id: 'mindful_moment', title: 'Have a mindful moment', emoji: 'üßòüèΩ', points: 4 },
                    { id: 'phone_before_bed', title: 'Stay off of phone an hour before bed', emoji: 'üìµ', points: 5 }
                ]
            }
        };



        // Achievements
        const achievements = [
            // Starter Tier (üíö) - Task Achievements
            { id: 'task_sprout', name: 'Task Sprout', desc: 'Complete your first regular task', icon: 'üå±', requirement: 1, type: 'tasks', tier: 'starter' },
            { id: 'quick_spark', name: 'Quick Spark', desc: 'Complete 3 quick tasks in one day', icon: '‚ö°', requirement: 3, type: 'quick_daily', tier: 'starter' },
            { id: 'momentum_builder', name: 'Momentum Builder', desc: 'Complete 5 tasks in one session without leaving', icon: 'üöÄ', requirement: 5, type: 'session', tier: 'starter' },
            { id: 'early_bird', name: 'Early Bird', desc: 'Complete a task before 10 AM', icon: 'üåÖ', requirement: 1, type: 'early_morning', tier: 'starter' },
            { id: 'weekend_warrior', name: 'Weekend Warrior', desc: 'Complete 2 tasks on Saturday or Sunday', icon: 'üèñÔ∏è', requirement: 2, type: 'weekend', tier: 'starter' },
            { id: 'consistency_rookie', name: 'Consistency Rookie', desc: 'Complete tasks 3 days in a row', icon: 'üî•', requirement: 3, type: 'streak', tier: 'starter' },
            { id: 'quickfire_pro', name: 'Quickfire Pro', desc: 'Complete 10 quick tasks total', icon: '‚ö°', requirement: 10, type: 'quick_total', tier: 'starter' },
            { id: 'balanced_start', name: 'Balanced Start', desc: 'Complete 1 quick task and 1 regular task in same day', icon: '‚öñÔ∏è', requirement: 1, type: 'balanced_day', tier: 'starter' },
            
            // Starter Tier (üíö) - Battle Achievements
            { id: 'first_victory', name: 'First Victory', desc: 'Defeat your first enemy in battle mode', icon: '‚öîÔ∏è', requirement: 1, type: 'battles', tier: 'starter' },
            { id: 'battle_ready', name: 'Battle Ready', desc: 'Win 5 battles total', icon: 'üõ°Ô∏è', requirement: 5, type: 'battles', tier: 'starter' },
            
            // Starter Tier (üíö) - Quest Achievements
            { id: 'quest_beginner', name: 'Quest Beginner', desc: 'Pass your first Merlin quiz', icon: 'üìú', requirement: 1, type: 'quests', tier: 'starter' },
            { id: 'curious_mind', name: 'Curious Mind', desc: 'Pass 3 Merlin quizzes', icon: 'üßô', requirement: 3, type: 'quests', tier: 'starter' },
            
            // Intermediate Tier (üíô) - Task Achievements
            { id: 'task_commander', name: 'Task Commander', desc: 'Complete 25 regular tasks total', icon: 'üíº', requirement: 25, type: 'tasks', tier: 'intermediate' },
            { id: 'focus_flow', name: 'Focus Flow', desc: 'Complete 10 tasks in one session without leaving', icon: 'üéØ', requirement: 10, type: 'session', tier: 'intermediate' },
            { id: 'habit_maker', name: 'Habit Maker', desc: 'Complete tasks 5 days in a row', icon: 'üî•', requirement: 5, type: 'streak', tier: 'intermediate' },
            { id: 'productivity_pulse', name: 'Productivity Pulse', desc: 'Achieve 50% task completion rate', icon: 'üìä', requirement: 50, type: 'completion_rate', tier: 'intermediate' },
            { id: 'quick_reflexes', name: 'Quick Reflexes', desc: 'Complete a quick task within 60 seconds', icon: '‚è±Ô∏è', requirement: 1, type: 'quick_fast', tier: 'intermediate' },
            { id: 'planner_pro', name: 'Planner Pro', desc: 'Complete 10 tasks in a single day', icon: 'üìã', requirement: 10, type: 'daily_tasks', tier: 'intermediate' },
            { id: 'time_keeper', name: 'Time Keeper', desc: 'Complete a task within 5 minutes of due time', icon: '‚è∞', requirement: 1, type: 'on_time', tier: 'intermediate' },
            { id: 'first_flame', name: 'First Flame', desc: 'Earn 100 XP total', icon: '‚ú®', requirement: 100, type: 'xp', tier: 'intermediate' },
            
            // Intermediate Tier (üíô) - Battle Achievements
            { id: 'combat_veteran', name: 'Combat Veteran', desc: 'Win 10 battles total', icon: '‚öîÔ∏è', requirement: 10, type: 'battles', tier: 'intermediate' },
            { id: 'undefeated_streak', name: 'Undefeated Streak', desc: 'Win 3 battles in a row', icon: 'üî•', requirement: 3, type: 'battle_streak', tier: 'intermediate' },
            
            // Intermediate Tier (üíô) - Quest Achievements
            { id: 'quest_enthusiast', name: 'Quest Enthusiast', desc: 'Pass 5 Merlin quizzes', icon: 'üìö', requirement: 5, type: 'quests', tier: 'intermediate' },
            { id: 'perfect_student', name: 'Perfect Student', desc: 'Pass 5 Merlin quizzes in a row', icon: 'üéì', requirement: 5, type: 'quiz_perfect', tier: 'intermediate' },
            
            // Advanced Tier (üíõ) - Task Achievements
            { id: 'task_marathoner', name: 'Task Marathoner', desc: 'Complete 50 regular tasks total', icon: 'üèÉ', requirement: 50, type: 'tasks', tier: 'advanced' },
            { id: 'quickstorm', name: 'Quickstorm', desc: 'Complete 25 quick tasks total', icon: '‚ö°', requirement: 25, type: 'quick_total', tier: 'advanced' },
            { id: 'planner_legend', name: 'Planner Legend', desc: 'Complete tasks 7 days in a row', icon: 'üî•', requirement: 7, type: 'streak', tier: 'advanced' },
            { id: 'efficiency_expert', name: 'Efficiency Expert', desc: 'Complete 5 high-priority tasks in one day', icon: '‚≠ê', requirement: 5, type: 'high_priority_day', tier: 'advanced' },
            { id: 'daily_challenger', name: 'Daily Challenger', desc: 'Complete 7 daily challenges', icon: 'üèÜ', requirement: 7, type: 'challenges', tier: 'advanced' },
            { id: 'midnight_focus', name: 'Midnight Focus', desc: 'Complete a task between 12 AM and 3 AM', icon: 'üåô', requirement: 1, type: 'midnight', tier: 'advanced' },
            { id: 'xp_collector', name: 'XP Collector', desc: 'Earn 500 XP total', icon: 'üíé', requirement: 500, type: 'xp', tier: 'advanced' },
            { id: 'unstoppable_force', name: 'Unstoppable Force', desc: 'Complete 100 regular tasks total', icon: 'üöÄ', requirement: 100, type: 'tasks', tier: 'advanced' },
            { id: 'legend_of_focus', name: 'Legend of Focus', desc: 'Complete tasks 30 days in a row', icon: 'üî•', requirement: 30, type: 'streak', tier: 'advanced' },
            
            // Advanced Tier (üíõ) - Battle Achievements
            { id: 'battle_master', name: 'Battle Master', desc: 'Win 25 battles total', icon: '‚öîÔ∏è', requirement: 25, type: 'battles', tier: 'advanced' },
            { id: 'unstoppable', name: 'Unstoppable', desc: 'Win 10 battles in a row', icon: 'üî•', requirement: 10, type: 'battle_streak', tier: 'advanced' },
            { id: 'battle_legend', name: 'Battle Legend', desc: 'Win 50 battles total', icon: 'üëë', requirement: 50, type: 'battles', tier: 'advanced' },
            
            // Advanced Tier (üíõ) - Quest Achievements
            { id: 'quest_master', name: 'Quest Master', desc: 'Pass 10 Merlin quizzes', icon: 'üßô‚Äç‚ôÇÔ∏è', requirement: 10, type: 'quests', tier: 'advanced' },
            { id: 'scholar', name: 'Scholar', desc: 'Pass 20 Merlin quizzes total', icon: 'üìñ', requirement: 20, type: 'quests', tier: 'advanced' },
            
            // NEW ACHIEVEMENTS - Focus & Productivity
            { id: 'focused_mind', name: 'Focused Mind', desc: 'Use the Focus Timer for 25 minutes', icon: '‚è±Ô∏è', requirement: 1, type: 'focus_timer', tier: 'starter' },
            { id: 'challenge_champion', name: 'Challenge Champion', desc: 'Complete 3 daily challenges', icon: 'üéØ', requirement: 3, type: 'challenges', tier: 'intermediate' },
            { id: 'category_master', name: 'Category Master', desc: 'Complete at least 1 task in all 10 categories', icon: 'üé®', requirement: 10, type: 'category_variety', tier: 'intermediate' },
            { id: 'priority_pro', name: 'Priority Pro', desc: 'Complete 10 high-priority tasks total', icon: 'üî¥', requirement: 10, type: 'high_priority_total', tier: 'intermediate' },
            { id: 'xp_master', name: 'XP Master', desc: 'Earn 1000 XP total', icon: 'üí´', requirement: 1000, type: 'xp', tier: 'advanced' },
            { id: 'quest_collector', name: 'Quest Collector', desc: 'Accept 10 Merlin quests', icon: 'üìú', requirement: 10, type: 'quest_accepted', tier: 'intermediate' },
            { id: 'dedication_master', name: 'Dedication Master', desc: 'Complete tasks 14 days in a row', icon: 'üî•', requirement: 14, type: 'streak', tier: 'advanced' },

            // NEW ACHIEVEMENTS - Focus Timer, Quests, and Merlin (15 new)
            { id: 'focus_starter', name: 'Focus Starter', desc: 'Use the Focus Timer for the first time', icon: '‚è≤Ô∏è', requirement: 1, type: 'focus_timer_first', tier: 'starter' },
            { id: 'deep_focus', name: 'Deep Focus', desc: 'Use the Focus Timer for 50 minutes total', icon: 'üßò', requirement: 50, type: 'focus_timer_total', tier: 'intermediate' },
            { id: 'focus_marathon', name: 'Focus Marathon', desc: 'Use the Focus Timer for 2 hours total', icon: 'üèÉ‚Äç‚ôÇÔ∏è', requirement: 120, type: 'focus_timer_total', tier: 'advanced' },
            { id: 'quest_explorer', name: 'Quest Explorer', desc: 'Complete your first Merlin quest task', icon: 'üó∫Ô∏è', requirement: 1, type: 'quest_task_completed', tier: 'starter' },
            { id: 'quest_warrior', name: 'Quest Warrior', desc: 'Complete 5 Merlin quest tasks', icon: '‚öîÔ∏è', requirement: 5, type: 'quest_task_completed', tier: 'intermediate' },
            { id: 'quest_legend', name: 'Quest Legend', desc: 'Complete 15 Merlin quest tasks', icon: 'üëë', requirement: 15, type: 'quest_task_completed', tier: 'advanced' },
            { id: 'merlin_apprentice', name: 'Merlin\'s Apprentice', desc: 'Accept 5 quests from Merlin', icon: 'üßô', requirement: 5, type: 'quest_accepted', tier: 'starter' },
            { id: 'merlin_disciple', name: 'Merlin\'s Disciple', desc: 'Accept 20 quests from Merlin', icon: 'üîÆ', requirement: 20, type: 'quest_accepted', tier: 'intermediate' },
            { id: 'quiz_perfectionist', name: 'Quiz Perfectionist', desc: 'Pass 10 Merlin quizzes in a row', icon: 'üíØ', requirement: 10, type: 'quiz_perfect', tier: 'advanced' },
            { id: 'knowledge_seeker', name: 'Knowledge Seeker', desc: 'Pass 30 Merlin quizzes total', icon: 'üìö', requirement: 30, type: 'quests', tier: 'advanced' },
            { id: 'focus_consistency', name: 'Focus Consistency', desc: 'Use the Focus Timer 3 days in a row', icon: 'üéØ', requirement: 3, type: 'focus_timer_streak', tier: 'intermediate' },
            { id: 'quest_speedrun', name: 'Quest Speedrun', desc: 'Complete a Merlin quest within 1 hour of accepting', icon: '‚ö°', requirement: 1, type: 'quest_fast', tier: 'intermediate' },
            { id: 'focus_master', name: 'Focus Master', desc: 'Use the Focus Timer 10 times in one day', icon: 'üß†', requirement: 10, type: 'focus_timer_daily', tier: 'advanced' },
            { id: 'quest_collector_pro', name: 'Quest Collector Pro', desc: 'Have 3 active Merlin quests at once', icon: 'üìã', requirement: 3, type: 'quest_active_multi', tier: 'intermediate' },
            { id: 'merlin_champion', name: 'Merlin\'s Champion', desc: 'Complete 25 Merlin quest tasks', icon: 'üèÜ', requirement: 25, type: 'quest_task_completed', tier: 'advanced' }
        ];
        
        // Make achievements accessible globally
        window.achievements = achievements;

        // Load game state from localStorage
        function loadGameState() {
            // Use pre-hydrated state if available (prevents flash)
            let parsedState = null;
            
            if (window.__HYDRATED_STATE__) {
                parsedState = window.__HYDRATED_STATE__;
                console.log('‚úÖ Using pre-hydrated state (no flash)');
            } else {
                const saved = localStorage.getItem('taskRockGameState');
                if (saved) {
                    parsedState = JSON.parse(saved);
                }
            }
            
            if (parsedState) {
                gameState = { ...gameState, ...parsedState };
                window.gameState = gameState; // Update window reference
                
                // Ensure selectedQuickTasks exists
                if (!gameState.selectedQuickTasks) {
                    gameState.selectedQuickTasks = [];
                }
                
                // Ensure completedQuickTasks exists
                if (!gameState.completedQuickTasks) {
                    gameState.completedQuickTasks = [];
                }
                
                // Migration: Initialize totalTasksCreated for existing users
                if (typeof gameState.totalTasksCreated === 'undefined') {
                    gameState.totalTasksCreated = gameState.completedTasks + gameState.tasks.length;
                }
                
                // Ensure totalTasksCreated is never less than completedTasks
                if (gameState.totalTasksCreated < gameState.completedTasks) {
                    gameState.totalTasksCreated = gameState.completedTasks;
                }
                
                // Migration: Initialize skins system for existing users
                if (!gameState.ownedSkins) {
                    gameState.ownedSkins = [];
                }
                if (typeof gameState.equippedSkinId === 'undefined') {
                    gameState.equippedSkinId = null;
                }
                
                // Migration: Initialize new stats for existing users
                if (typeof gameState.battlesWon === 'undefined') {
                    gameState.battlesWon = 0;
                }
                if (typeof gameState.battlesLost === 'undefined') {
                    gameState.battlesLost = 0;
                }
                if (typeof gameState.questQuizzesPassed === 'undefined') {
                    gameState.questQuizzesPassed = 0;
                }
                if (typeof gameState.questQuizzesFailed === 'undefined') {
                    gameState.questQuizzesFailed = 0;
                }
                if (typeof gameState.questTasksAccepted === 'undefined') {
                    gameState.questTasksAccepted = 0;
                }
                if (typeof gameState.questTasksOffered === 'undefined') {
                    gameState.questTasksOffered = 0;
                }
                if (typeof gameState.battleStreak === 'undefined') {
                    gameState.battleStreak = 0;
                }
                if (typeof gameState.quizPerfectStreak === 'undefined') {
                    gameState.quizPerfectStreak = 0;
                }
                
                // Migration: Ensure health is never 0 (fix for existing LEGACY users only)
                // Legacy users are those who have health > 5 (indicating they've played before)
                // New users start with health = 5
                if (!gameState.health || gameState.health === 0) {
                    // Check if this is a legacy user (has other progress indicators)
                    if (parsedState.completedTasks > 0 || parsedState.jerryLevel > 1) {
                        gameState.health = 75; // Reset to legacy default
                    } else {
                        gameState.health = 5; // New user default
                    }
                }
                
                // Migration: Initialize attack/defense stats for existing users
                // These are no longer used for display but kept for compatibility
                if (typeof gameState.attack === 'undefined') {
                    gameState.attack = 100;
                }
                if (typeof gameState.defense === 'undefined') {
                    gameState.defense = 100;
                }
                
                // Migration: Initialize achievement tracking for existing users
                if (typeof gameState.achievementProgress === 'undefined') {
                    gameState.achievementProgress = {};
                }
                if (typeof gameState.unlockedAchievements === 'undefined') {
                    gameState.unlockedAchievements = {};
                }
                if (typeof gameState.quickTaskStartTimes === 'undefined') {
                    gameState.quickTaskStartTimes = {};
                }
                if (typeof gameState.sessionTaskCount === 'undefined') {
                    gameState.sessionTaskCount = 0;
                }
                if (typeof gameState.sessionStartTime === 'undefined') {
                    gameState.sessionStartTime = null;
                }
                if (typeof gameState.tasksCompletedToday === 'undefined') {
                    gameState.tasksCompletedToday = [];
                }
                if (typeof gameState.weekendTasksCompleted === 'undefined') {
                    gameState.weekendTasksCompleted = 0;
                }
                if (typeof gameState.allTasksStreakDays === 'undefined') {
                    gameState.allTasksStreakDays = 0;
                }
                if (typeof gameState.lastAllTasksDate === 'undefined') {
                    gameState.lastAllTasksDate = null;
                }
                
                // Migration: Initialize xpCoins for existing users
                if (typeof gameState.jerryXP === 'undefined') {
                    gameState.jerryXP = gameState.jerryXP || 0;
                }
                
                // Migration: Initialize battleInventory for existing LEGACY users only
                // A legacy user is one who has no battleInventory in saved state
                // AND has health > 5 (indicating they've been playing with the old system)
                const hasNoBattleInventory = typeof parsedState.battleInventory === 'undefined';
                const hasPlayedBefore = parsedState.health && parsedState.health > 5;
                const isLegacyUser = hasNoBattleInventory && hasPlayedBefore;
                
                if (isLegacyUser) {
                    // Legacy user - give them starter items
                    gameState.battleInventory = {
                        fireball: 0,
                        spark: 0,
                        health_potion: 2,
                        attack_refill: 2,
                        defense_refill: 2,
                        invisibility_cloak: 0,
                        prickler: 0,
                        freeze: 0,
                        blue_flame: 0,
                        procrastination_ghost: 0
                    };
                    gameState.unlockedBattleItems = ['health_potion', 'attack_refill', 'defense_refill'];
                } else {
                    // New user or existing user with battleInventory - just ensure all item keys exist with 0
                    const allBattleItemKeys = [
                        'fireball', 'spark', 'health_potion', 'attack_refill', 'defense_refill',
                        'invisibility_cloak', 'prickler', 'freeze', 'blue_flame', 'procrastination_ghost',
                        'throwing_stars'
                    ];
                    
                    // Only add missing keys with 0 (don't override existing values)
                    allBattleItemKeys.forEach(itemKey => {
                        if (typeof gameState.battleInventory[itemKey] === 'undefined') {
                            gameState.battleInventory[itemKey] = 0;
                        }
                    });
                    
                    // Initialize unlockedBattleItems if not present - new users can buy potions
                    if (typeof gameState.unlockedBattleItems === 'undefined') {
                        gameState.unlockedBattleItems = ['health_potion', 'attack_refill', 'defense_refill'];
                    }
                }
                
                // Migration: Ensure unlockedBattleItems includes all items with quantity > 0
                Object.keys(gameState.battleInventory).forEach(itemKey => {
                    if (gameState.battleInventory[itemKey] > 0) {
                        if (!gameState.unlockedBattleItems.includes(itemKey)) {
                            gameState.unlockedBattleItems.push(itemKey);
                        }
                    }
                });
                
                // Migration: Initialize egg system for new and existing users
                if (typeof gameState.isEgg === 'undefined') {
                    // New users (level 1-4) start as eggs, existing users (level 5+) are not eggs
                    gameState.isEgg = (gameState.jerryLevel < 5);
                }
                if (typeof gameState.consecutiveLosses === 'undefined') {
                    gameState.consecutiveLosses = 0;
                }
                if (typeof gameState.eggRevertedAt === 'undefined') {
                    gameState.eggRevertedAt = null;
                }
            }
            
            // Sync monster name from onboarding if it exists
            const monsterName = localStorage.getItem('monsterName');
            if (monsterName) {
                gameState.rockName = monsterName;
            }
            
            // Load and apply monster sprite OR egg
            const spritePrefix = localStorage.getItem('heroSpritePrefix');
            const selectedMonster = localStorage.getItem('selectedMonster');
            const mainHeroSprite = document.getElementById('mainHeroSprite');
            
            if (mainHeroSprite) {
                // Check if monster is in egg form
                if (gameState.isEgg && selectedMonster) {
                    // Load egg GIF based on selected monster
                    mainHeroSprite.src = `assets/eggs/${selectedMonster}_egg.gif`;
                    mainHeroSprite.classList.add('egg-sprite');
                    // CRITICAL: Clear inline styles that override CSS class
                    mainHeroSprite.style.animation = 'none';
                    mainHeroSprite.style.objectFit = 'contain';
                    mainHeroSprite.style.objectPosition = 'center';
                    mainHeroSprite.style.width = 'auto';
                    mainHeroSprite.style.height = 'auto';
                    mainHeroSprite.style.maxWidth = '100%';
                    mainHeroSprite.style.maxHeight = '100%';
                    mainHeroSprite.style.transform = 'scale(2)';
                    mainHeroSprite.style.opacity = '1';
                    console.log('[LoadGameState] Loading egg sprite for:', selectedMonster);
                } else if (spritePrefix && !gameState.equippedSkinId) {
                    // SKIN SYNC FIX: Only load default sprite if NO skin is equipped
                    // If skin is equipped, skinsManager.init() will handle it
                    console.log('[LoadGameState] No skin equipped, loading default monster sprite');
                    mainHeroSprite.src = `assets/heroes/${spritePrefix}_Idle_4.png`;
                    mainHeroSprite.classList.remove('egg-sprite');
                    
                    // CRITICAL FIX: Use setProperty with 'important' to override HTML !important flags
                    mainHeroSprite.style.setProperty('width', '32px', 'important');
                    mainHeroSprite.style.setProperty('height', '32px', 'important');
                    mainHeroSprite.style.setProperty('object-fit', 'none', 'important');
                    mainHeroSprite.style.setProperty('object-position', '0 0', 'important');
                    mainHeroSprite.style.setProperty('transform', 'scale(4)', 'important');
                    mainHeroSprite.style.setProperty('animation', 'none', 'important');
                    mainHeroSprite.style.setProperty('opacity', '1', 'important');
                    
                    // Force reflow to ensure styles are applied immediately
                    void mainHeroSprite.offsetHeight;
                } else if (gameState.equippedSkinId) {
                    // SKIN SYNC FIX: Skin is equipped, skinsManager will apply all styles
                    // DO NOT set opacity here - let skinsManager handle everything
                    console.log('[LoadGameState] Skin equipped:', gameState.equippedSkinId, '- skinsManager will apply it');
                } else {
                    // If no sprite selected yet, show default (Pink Monster)
                    mainHeroSprite.style.setProperty('opacity', '1', 'important');
                }
            }
            
            // TEST MODE DISABLED - Egg progression feature enabled
            // gameState.jerryLevel = 50;
            // gameState.jerryCurrentXP = 0;
            // gameState.jerryXPToNext = Math.floor(100 * Math.pow(1.2, 50 - 1));
            // gameState.jerryXP = 50000;
            // gameState.health = 100;
            // gameState.isEgg = false;
            // console.log('[TEST MODE] Level set to 50 with 50000 XP Coins');
            
            // CRITICAL FIX: Initialize skinsManager AFTER gameState is fully loaded
            // This ensures equippedSkinId is available when skinsManager.init() runs
            if (window.skinsManager) {
                window.skinsManager.init();
                console.log('[LoadGameState] SkinsManager initialized with equippedSkinId:', gameState.equippedSkinId);
            }
        }

        // Save game state to localStorage
        function saveGameState() {
            localStorage.setItem('taskRockGameState', JSON.stringify(gameState));
        }

        // Check and update energy based on pending/overdue tasks
        function checkAndUpdateEnergy() {
            if (!gameState || !gameState.tasks) return;
            
            // Skip if potion was just used to prevent immediate drain
            if (window.justUsedPotion) return;
            
            const now = Date.now();
            const pendingTasks = gameState.tasks.filter(t => !t.completed && t.dueDate);
            
            if (pendingTasks.length === 0) {
                // No pending tasks with due dates - energy should be at 100
                if (gameState.health < 100) {
                    gameState.health = Math.min(100, gameState.health + 1);
                    saveGameState();
                }
                return;
            }
            
            let energyDrain = 0;
            
            pendingTasks.forEach(task => {
                const dueDate = new Date(task.dueDate).getTime();
                const timeUntilDue = dueDate - now;
                const hoursUntilDue = timeUntilDue / (1000 * 60 * 60);
                
                // Energy drain based on how close the due date is
                if (timeUntilDue < 0) {
                    // Overdue - severe drain
                    const hoursOverdue = Math.abs(hoursUntilDue);
                    if (hoursOverdue > 24) {
                        energyDrain += 15; // Very overdue
                    } else if (hoursOverdue > 12) {
                        energyDrain += 10; // Quite overdue
                    } else {
                        energyDrain += 5; // Recently overdue
                    }
                } else if (hoursUntilDue <= 2) {
                    // Due within 2 hours - high urgency
                    energyDrain += 8;
                } else if (hoursUntilDue <= 8) {
                    // Due within 8 hours - moderate urgency
                    energyDrain += 5;
                } else if (hoursUntilDue <= 24) {
                    // Due within 24 hours - low urgency
                    energyDrain += 2;
                }
            });
            
            // Apply energy drain (cap at reasonable amount per check)
            if (energyDrain > 0) {
                const maxDrainPerCheck = 30; // Don't drain more than 30 per check
                energyDrain = Math.min(energyDrain, maxDrainPerCheck);
                gameState.health = Math.max(0, gameState.health - energyDrain);
                saveGameState();
            }
        }

        // Update UI elements
        function updateUI() {
            // Update header info (unified level | name)
            const levelLabel = document.getElementById('levelLabel');
            if (levelLabel) {
                levelLabel.textContent = `${gameState.rockName} | Level ${gameState.jerryLevel || 1}`;
            }
            
            // Update RPG Gauges
            const health = gameState.health || 5;
            const completedTasks = gameState.completedTasks || 0;
            const currentStreak = gameState.currentStreak || 0;
            const level = gameState.jerryLevel || 1;
            
            // XP System: Use jerryCurrentXP for level progress (resets on level-up)
            // jerryXP is XP Coins (persistent currency, never resets)
            const currentXP = Math.max(0, gameState.jerryCurrentXP || 0); // Clamp to prevent negative
            const xpToNext = gameState.jerryXPToNext || Math.floor(100 * Math.pow(1.2, level - 1));
            
            // Calculate maxHP based on level (same formula as battleInit.js)
            const baseHP = 100;
            const hpPerLevel = 10;
            const maxHP = baseHP + (level * hpPerLevel);
            
            // Energy (Health) - displays as health/maxHP (scaled with level)
            const healthPercentage = (health / maxHP) * 100;
            document.getElementById('energyFill').style.width = `${healthPercentage}%`;
            document.getElementById('energyText').textContent = `${Math.round(health)}/${maxHP}`;
            
            // Add flickering effect to monster sprite when HP < 20
            const mainHeroSprite = document.getElementById('mainHeroSprite');
            if (mainHeroSprite) {
                // Apply flicker effect when HP < 20 (works with all skins and base monsters)
                if (health < 20) {
                    // Add flicker class for CSS animation
                    if (!mainHeroSprite.classList.contains('low-hp-flicker')) {
                        mainHeroSprite.classList.add('low-hp-flicker');
                        console.log('‚ö†Ô∏è [HP Flicker] HP below 20, flickering started');
                    }
                } else {
                    // Remove flicker if HP >= 20
                    if (mainHeroSprite.classList.contains('low-hp-flicker')) {
                        mainHeroSprite.classList.remove('low-hp-flicker');
                        console.log('‚úÖ [HP Flicker] HP above 20, flickering stopped');
                    }
                }
            }
            
            // Attack (fixed at 100)
            const attack = 100;
            document.getElementById('attackFill').style.width = `${attack}%`;
            document.getElementById('attackText').textContent = `${attack}/100`;
            
            // Defense (fixed at 100)
            const defense = 100;
            document.getElementById('defenseFill').style.width = `${defense}%`;
            document.getElementById('defenseText').textContent = `${defense}/100`;
            
            // Level text (now handled in unified levelLabel above)
            
            // XP Bar - Simple display (XP resets on level-up)
            const xpPercentage = Math.min(100, (currentXP / xpToNext) * 100);
            document.getElementById('xpFill').style.width = `${xpPercentage}%`;
            document.getElementById('xpText').textContent = `${Math.floor(currentXP).toLocaleString()} / ${Math.floor(xpToNext).toLocaleString()} XP`;
            
            // Calculate comprehensive stats
            const activeTasks = gameState.tasks.filter(task => !task.completed);
            const pendingTasks = activeTasks.length;
            const quickTasks = (gameState.selectedQuickTasks || []).length;
            const completedQuickTasks = (gameState.completedQuickTasks || []).length;
            const totalTasks = gameState.totalTasksCreated || 0;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            const bestStreak = gameState.bestStreak || gameState.longestStreak || 0;
            const rockLevel = level;
            const nextLevelXP = xpToNext;
            
            // Calculate achievements
            let unlockedAchievements = 0;
            if (window.achievementTracker) {
                window.achievementTracker.checkAchievements();
                achievements.forEach(achievement => {
                    if (window.achievementTracker.isAchievementUnlocked(achievement.id)) {
                        unlockedAchievements++;
                    }
                });
            }
            
            // Update collapsed stats
            const quickTasksEl = document.getElementById('quickTasksDisplay');
            const pendingTasksEl = document.getElementById('pendingTasksDisplay');
            const completedTasksEl = document.getElementById('completedTasksDisplay');
            
            if (quickTasksEl) quickTasksEl.textContent = quickTasks;
            if (pendingTasksEl) pendingTasksEl.textContent = pendingTasks;
            if (completedTasksEl) completedTasksEl.textContent = completedTasks;
            
            // Update expanded stats
            const quickTasksExpEl = document.getElementById('quickTasksDisplayExp');
            const completedQuickTasksExpEl = document.getElementById('completedQuickTasksDisplayExp');
            const pendingTasksExpEl = document.getElementById('pendingTasksDisplayExp');
            const completedTasksExpEl = document.getElementById('completedTasksDisplayExp');
            const completionRateEl = document.getElementById('completionRateDisplay');
            const totalTasksEl = document.getElementById('totalTasksDisplay');
            const currentStreakEl = document.getElementById('currentStreakDisplay');
            const bestStreakEl = document.getElementById('bestStreakDisplay');
            const rockLevelEl = document.getElementById('rockLevelDisplay');
            const experienceEl = document.getElementById('experienceDisplay');
            const achievementsEl = document.getElementById('achievementsDisplay');
            
            if (quickTasksExpEl) quickTasksExpEl.textContent = quickTasks;
            if (completedQuickTasksExpEl) completedQuickTasksExpEl.textContent = completedQuickTasks;
            if (pendingTasksExpEl) pendingTasksExpEl.textContent = pendingTasks;
            if (completedTasksExpEl) completedTasksExpEl.textContent = completedTasks;
            if (completionRateEl) {
                completionRateEl.textContent = `${completionRate}%`;
                // Add low completion warning if rate is below 50% and user has created tasks
                const completionTile = completionRateEl.closest('.stat-tile');
                if (completionTile) {
                    if (completionRate < 50 && totalTasks > 0) {
                        completionTile.classList.add('low-completion');
                    } else {
                        completionTile.classList.remove('low-completion');
                    }
                }
            }
            if (totalTasksEl) totalTasksEl.textContent = totalTasks;
            if (currentStreakEl) currentStreakEl.textContent = currentStreak;
            if (bestStreakEl) bestStreakEl.textContent = bestStreak;
            if (rockLevelEl) rockLevelEl.textContent = rockLevel;
            if (experienceEl) experienceEl.textContent = `${Math.floor(currentXP)}/${Math.floor(xpToNext)} XP`;
            if (achievementsEl) achievementsEl.textContent = `${unlockedAchievements}/${achievements.length}`;
            
            // Update new battle and quest stats
            const battlesWonEl = document.getElementById('battlesWonDisplay');
            const battlesLostEl = document.getElementById('battlesLostDisplay');
            const quizPassedEl = document.getElementById('quizPassedDisplay');
            const quizFailedEl = document.getElementById('quizFailedDisplay');
            const questAcceptanceEl = document.getElementById('questAcceptanceDisplay');
            
            if (battlesWonEl) battlesWonEl.textContent = gameState.battlesWon || 0;
            if (battlesLostEl) battlesLostEl.textContent = gameState.battlesLost || 0;
            if (quizPassedEl) quizPassedEl.textContent = gameState.questQuizzesPassed || 0;
            if (quizFailedEl) quizFailedEl.textContent = gameState.questQuizzesFailed || 0;
            if (questAcceptanceEl) {
                const offered = gameState.questTasksOffered || 0;
                const accepted = gameState.questTasksAccepted || 0;
                const acceptanceRate = offered > 0 ? Math.round((accepted / offered) * 100) : 0;
                questAcceptanceEl.textContent = `${acceptanceRate}%`;
            }
            
            // Theme application is handled by backgroundManager.js via refreshBackground()
            // DO NOT apply themes here to avoid conflicts
            
            // Update creature image based on equipped items
            updateCreatureImage();
            
            // Update daily challenge display
            updateDailyChallengeDisplay();
            
            // Update shop display to refresh equipped status
            updateShopDisplay();
            
            // Update Task Pal tooltip
            updateTooltip(health, gameState.tasks || []);
            
            // Refresh background to ensure custom theme persists
            if (typeof window.refreshBackground === 'function') {
                window.refreshBackground();
            }
        }

        // ===============================
        // ü™® CATEGORY-AWARE TOOLTIP SYSTEM
        // ===============================
        let userName = localStorage.getItem('userName') || "";

        // Phrase libraries by category
        const categoryPhrases = {
            work: [
                "Let's get that productivity flowing üíº",
                "Another win for the team, {name}!",
                "You're bossing this project üíª",
                "Emails, meetings, and progress‚Äîlet's go!",
                "A focused mind is your best tool üîß",
                "Work vibes are strong today ‚ö°",
                "You're making moves, {name}!",
                "Great things come from small, consistent effort.",
                "Keep that workflow rolling!",
                "Time to show your skills, {name}!"
            ],
            learning: [
                "Knowledge boost incoming üéì",
                "Brains loading... complete! üß†",
                "Smart move, {name} ‚Äî every study counts.",
                "Curiosity looks good on you üëÄ",
                "Each page turns you into a powerhouse üìò",
                "Let's learn something amazing today!",
                "You're leveling up your brain XP üìö",
                "Stay curious, stay sharp ‚ú®",
                "Knowledge is your weapon today!",
                "Your focus is unmatched, {name}!"
            ],
            home: [
                "Home base needs your magic üè†",
                "Clean space, clear mind üß∫",
                "Small chores, big peace ‚ú®",
                "That's how a champion does it, {name}!",
                "Order brings calm üïØÔ∏è",
                "Your environment is leveling up üí´",
                "Tidying today = peaceful tomorrow.",
                "You're turning home into a haven üíñ",
                "Every task brings comfort closer.",
                "Smells like progress, {name}!"
            ],
            finance: [
                "Let's secure that bag üí∞",
                "Smart money move, {name}! üßÆ",
                "Every dollar has a mission.",
                "Budgeting = self-care üí≥",
                "You're building future freedom!",
                "The spreadsheet gods salute you üìä",
                "That's wealth-builder energy üíé",
                "Financial XP gained!",
                "Money discipline unlocks power üíº",
                "Keep stacking smart wins, {name}!"
            ],
            goals: [
                "Goal mode: activated üéØ",
                "Another step toward greatness, {name}!",
                "Dreams ‚Üí Action ‚Üí Progress üí´",
                "Focus on the horizon üåÖ",
                "Every tap brings you closer.",
                "Small goals stack into big wins ü™®",
                "You're unstoppable when you plan üí™",
                "Keep aiming true, {name}!",
                "Success is compounding üîÅ",
                "Future you is proud already."
            ],
            projects: [
                "Blueprints of success loading üõ†Ô∏è",
                "You're building something amazing, {name}!",
                "Creativity meets focus üî•",
                "Every block builds the bigger picture üß©",
                "Let's make progress visible today.",
                "Innovation XP earned üí°",
                "Keep crafting your vision!",
                "Project momentum: 100% ‚öôÔ∏è",
                "The details matter ‚Äî and you're nailing them.",
                "You're a maker of great things, {name}!"
            ],
            generic: [
                "Keep going, {name}! ‚ö°",
                "Every task fuels your growth!",
                "You're doing great work!",
                "Another win on your quest! üó∫Ô∏è",
                "Stay focused and keep pushing!",
                "You're leveling up with every action üí•",
                "The quest continues!",
                "You're crushing it, hero! üß≠",
                "Your consistency is your strength.",
                "Let's make today count!"
            ]
        };

        // Helper functions
        function getCategoryPhrases(category) {
            const phrases = categoryPhrases[category] || categoryPhrases.generic;
            // Extra safety: ensure we always return an array
            if (!phrases || !Array.isArray(phrases) || phrases.length === 0) {
                console.warn('[getCategoryPhrases] Invalid category or empty phrases for:', category);
                return categoryPhrases.generic || ['Keep going! ‚ö°'];
            }
            return phrases;
        }

        function getRandomPhrase(category) {
            const phrases = getCategoryPhrases(category);
            // Extra safety: validate phrases array
            if (!phrases || phrases.length === 0) {
                console.warn('[getRandomPhrase] No phrases available for category:', category);
                return 'Keep going! ‚ö°';
            }
            const phrase = phrases[Math.floor(Math.random() * phrases.length)];
            return userName ? phrase.replace("{name}", userName) : phrase.replace("{name}", "");
        }

        function showCategoryTooltip(category) {
            const tooltip = document.getElementById('taskPalTooltip');
            if (!tooltip) {
                console.warn('[showCategoryTooltip] Tooltip element not found');
                return;
            }
            const message = getRandomPhrase(category);
            tooltip.textContent = message.trim();
            tooltip.classList.add('visible');
            setTimeout(() => tooltip.classList.remove('visible'), 10000);
        }

        function onTaskAdded(category) {
            showCategoryTooltip(category);
        }

        function onTaskCompleted(category) {
            showCategoryTooltip(category);
        }

        function saveUserName(value) {
            localStorage.setItem('userName', value.trim());
            userName = value.trim();
        }

        // Fallback: show a generic tooltip every few minutes
        setInterval(() => showCategoryTooltip('generic'), 180000);

        // ===============================
        // üòä UPGRADED MOOD TRACKER SYSTEM WITH PERSONALITY VARIATIONS
        // ===============================
        const moodPhrases = {
            nova: {
                happy: [
                    "I love this energy!",
                    "That smile is power!",
                    "Let's use this momentum!",
                    "You're glowing!",
                    "This vibe is electric!",
                    "We're thriving!",
                    "This is peak performance!",
                    "You're unstoppable today!",
                    "Let's make it count!",
                    "This feels amazing!"
                ],
                sad: [
                    "Hey‚Ä¶ it's okay to slow down.",
                    "Even champions rest.",
                    "We'll bounce back.",
                    "You don't have to be strong right now.",
                    "I've got you.",
                    "Let's take it one step at a time.",
                    "We're still in this.",
                    "No pressure today.",
                    "You're not failing.",
                    "We'll come back stronger."
                ],
                mad: [
                    "Let's channel that fire!",
                    "Use that energy!",
                    "You're allowed to be upset.",
                    "Let's turn this around.",
                    "I feel it too.",
                    "We can work through this.",
                    "Take a breath, champ.",
                    "It's okay to be frustrated.",
                    "Let's redirect this power.",
                    "You're still strong."
                ]
            },
            luna: {
                happy: [
                    "Your happiness feels warm.",
                    "I love seeing you smile.",
                    "Let's enjoy this.",
                    "You deserve this feeling.",
                    "This is a good moment.",
                    "Your joy is gentle and bright.",
                    "I'm happy with you.",
                    "Let's stay here a little.",
                    "This feels peaceful.",
                    "You look lighter."
                ],
                sad: [
                    "I'm here with you.",
                    "It's okay to feel heavy.",
                    "You don't have to rush.",
                    "We can go slowly.",
                    "You're still enough.",
                    "You're not broken.",
                    "It's okay to rest.",
                    "You're safe here.",
                    "You don't have to push.",
                    "I won't leave you."
                ],
                mad: [
                    "It's okay to feel this way.",
                    "Let's breathe together.",
                    "You're allowed to be upset.",
                    "I'm here, no matter what.",
                    "We can sit with this.",
                    "You don't have to hide it.",
                    "This will pass.",
                    "I understand.",
                    "You're not too much.",
                    "Let's be gentle."
                ]
            },
            benny: {
                happy: [
                    "You look happy!",
                    "Yay, happy vibes!",
                    "I like this mood!",
                    "This feels nice!",
                    "Let's do stuff!",
                    "I'm smiling too!",
                    "We're having fun!",
                    "That's a good face!",
                    "I love this!",
                    "So cozy!"
                ],
                sad: [
                    "Aww‚Ä¶ I'm here.",
                    "Want a hug?",
                    "We can be slow.",
                    "That's okay.",
                    "I still like you.",
                    "You don't have to do much.",
                    "We can rest.",
                    "I won't go away.",
                    "You're still my friend.",
                    "It's okay to be sad."
                ],
                mad: [
                    "Uh oh, you're upset.",
                    "I'm still here!",
                    "Want to take a break?",
                    "It's okay to be mad.",
                    "I won't leave.",
                    "We can be quiet.",
                    "That's okay.",
                    "You're still good.",
                    "I like you anyway.",
                    "Let's be calm together."
                ]
            }
        };

        let phraseHistory = {
            nova: { happy: [], sad: [], mad: [] },
            luna: { happy: [], sad: [], mad: [] },
            benny: { happy: [], sad: [], mad: [] }
        };

        function getRandomMoodPhrase(mood) {
            // Get current monster personality
            const heroSpritePrefix = localStorage.getItem('heroSpritePrefix') || 'Pink_Monster';
            let personality = 'nova'; // default
            
            if (heroSpritePrefix.includes('Pink_Monster')) {
                personality = 'nova';
            } else if (heroSpritePrefix.includes('Owlet_Monster')) {
                personality = 'luna';
            } else if (heroSpritePrefix.includes('Dude_Monster')) {
                personality = 'benny';
            }
            
            const phrases = moodPhrases[personality] && moodPhrases[personality][mood];
            
            // Validate that phrases exist for this mood
            if (!phrases || !Array.isArray(phrases) || phrases.length === 0) {
                console.warn('[getRandomMoodPhrase] No phrases found for personality:', personality, 'mood:', mood);
                return 'Keep going! üí™';
            }
            
            let availablePhrases = phrases.filter(p => !phraseHistory[personality][mood].includes(p));
            
            if (availablePhrases.length === 0) {
                phraseHistory[personality][mood] = [];
                availablePhrases = phrases;
            }
            
            const selected = availablePhrases[Math.floor(Math.random() * availablePhrases.length)];
            phraseHistory[personality][mood].push(selected);
            
            if (phraseHistory[personality][mood].length > 5) {
                phraseHistory[personality][mood].shift();
            }
            
            return selected;
        }

        // Mood tracker removed - will be rebuilt from scratch

        // Helper function to get current sprite prefix
        function getCurrentSpritePrefix() {
            return localStorage.getItem('heroSpritePrefix') || 'Pink_Monster';
        }

        // selectMood function removed - will be rebuilt from scratch

        function updateMoodDisplay(moodKey) {
            const moodEmojis = { happy: "üòä", sad: "üò¢", mad: "üò°" };
            const emoji = moodEmojis[moodKey] || "üòê";
            
            let moodDisplay = document.getElementById("moodDisplay");
            if (!moodDisplay) {
                const energyLabel = document.querySelector('.stat-label');
                if (energyLabel && energyLabel.textContent.includes('Energy')) {
                    moodDisplay = document.createElement('span');
                    moodDisplay.id = 'moodDisplay';
                    moodDisplay.style.marginLeft = '8px';
                    energyLabel.appendChild(moodDisplay);
                }
            }
            
            if (moodDisplay) {
                moodDisplay.textContent = emoji;
            }
        }

        // Mood tracker auto-popup will be handled by new system
        
        // Preload jump sprite to prevent lag
        const jumpSpritePreload = new Image();
        jumpSpritePreload.src = "assets/heroes/Nova_jump.gif";
        
        // On page load, restore saved mood and show tracker
        window.addEventListener("load", () => {
            const savedMood = localStorage.getItem("userMood");
            const hero = document.getElementById("mainHeroSprite");
            const spritePrefix = getCurrentSpritePrefix();
            
            // Always start with idle animation on page load using user's selected monster
            if (hero) {
                hero.src = `assets/heroes/${spritePrefix}_Idle_4.png`;
                hero.style.animation = 'none';
            }
            
            // Update mood display emoji only
            if (savedMood) {
                updateMoodDisplay(savedMood);
            } else {
                updateMoodDisplay(null);
            }
            
            // Mood tracker auto-show removed - will be rebuilt
        });

        // Update Task Pal Tooltip
        function updateTooltip(energy, tasks) {
            const tooltip = document.getElementById("taskPalTooltip");
            if (!tooltip) return;
            
            const now = Date.now();
            const hasOverdue = tasks.some(t => !t.completed && t.dueDate && new Date(t.dueDate).getTime() < now);
            const dueSoon = tasks.some(t => !t.completed && t.dueDate && new Date(t.dueDate).getTime() - now < 3600000);
            let message = "";

            if (energy === 0) message = "üíÄ I'm out of energy ‚Äî complete tasks to revive me.";
            else if (hasOverdue) message = "‚ö†Ô∏è Tasks are overdue! I'm losing energy fast!";
            else if (dueSoon) message = "‚è∞ You've got tasks due soon ‚Äî let's handle them!";
            else if (energy <= 25) message = "ü•± I need a boost ‚Äî finish a task to help me recover!";
            else if (energy < 60) message = "üôÇ I'm doing okay, but a few wins would help!";
            else {
                // Random motivational messages for high energy
                const highEnergyMessages = [
                    "üí™ I'm feeling strong ‚Äî keep the streak going!",
                    "‚ú® You're on fire! Let's keep this momentum!",
                    "üöÄ Crushing it! Your productivity is amazing!",
                    "üåü You're unstoppable! Keep up the great work!",
                    "‚ö° Energy levels maxed! You're doing fantastic!",
                    "üéØ Focused and fierce! Nothing can stop us now!",
                    "üî• On a roll! Your dedication is inspiring!",
                    "üíé Shining bright! Your progress is incredible!",
                    "üèÜ Champion mode activated! You're crushing your goals!",
                    "üåà Feeling amazing! Your consistency is paying off!",
                    "‚≠ê Stellar work! We make an awesome team!",
                    "üéä Thriving together! Your energy is contagious!",
                    "üí´ Radiating success! Keep this energy flowing!",
                    "ü¶∏ Superhero status! You're absolutely crushing it!",
                    "üé® Creating magic! Your effort is truly inspiring!"
                ];
                message = highEnergyMessages[Math.floor(Math.random() * highEnergyMessages.length)];
            }

            tooltip.textContent = message;
            tooltip.classList.add("visible");
            
            // Update hero sprite based on energy level
            const heroSprite = document.getElementById("heroSprite");
            if (heroSprite) {
                if (energy <= 30) {
                    // Low health - show hurt animation
                    heroSprite.src = "assets/heroes/hero-hurt.png";
                    heroSprite.style.animation = 'none';
                } else {
                    // Normal health - show idle animation
                    heroSprite.src = "assets/heroes/hero-idle.png";
                    heroSprite.style.animation = 'none';
                }
            }
            
            // Auto-hide after 50 seconds
            setTimeout(() => tooltip.classList.remove("visible"), 10000);
        }

        // Update creature image based on equipped items
        function updateCreatureImage() {
            const creatureImg = document.getElementById('creatureImage');
            if (!creatureImg) return;
            
            // Determine the image source based on equipped items
            let imageSrc = 'assets/Jerry-Default.png'; // Default image
            
            // Check if any hat is equipped
            if (gameState.currentOutfit && gameState.currentOutfit.hat) {
                const equippedHat = gameState.currentOutfit.hat;
                
                // Map hat IDs to image files
                const hatImageMap = {
                    'black_top_hat': 'assets/Jerry-TopHat.png',
                    'wizard_hat': 'assets/Jerry-WizardHat.png'
                };
                
                if (hatImageMap[equippedHat]) {
                    imageSrc = hatImageMap[equippedHat];
                }
            }
            
            // Check if any paint job is equipped
            if (gameState.currentOutfit && gameState.currentOutfit.paint) {
                const equippedPaint = gameState.currentOutfit.paint;
                
                // Map paint IDs to image files (these would override hat images if both are equipped)
                const paintImageMap = {
                    'golden_paint': 'assets/Jerry-Golden.png',
                    'rainbow_paint': 'assets/Jerry-Rainbow.png'
                };
                
                if (paintImageMap[equippedPaint]) {
                    imageSrc = paintImageMap[equippedPaint];
                }
            }
            
            // Update the image source
            creatureImg.src = imageSrc;
        }

        // Pet Rock Dialogue System
        const DIALOGUE_DATABASE = {
            // General phrases by level ranges
            level1to5: [
                "Hey there, [UserName]! I'm still getting to know you.",
                "Thanks for taking care of me! I'm learning so much.",
                "You're doing great with those tasks!",
                "I love watching you work on your goals.",
                "Keep it up! We make a great team.",
                "Every task completed makes me stronger!",
                "I'm so proud of your progress, [UserName].",
                "You're building such good habits!",
                "I feel myself growing with each task you complete.",
                "Your dedication is inspiring!"
            ],
            level6to10: [
                "We're really getting into a groove, [UserName]!",
                "I can feel myself getting stronger every day.",
                "Your consistency is amazing to watch.",
                "I love how focused you've become!",
                "We're becoming quite the productive duo.",
                "Your task completion rate is impressive!",
                "I'm starting to feel more energetic.",
                "You're really mastering this routine thing.",
                "I can sense your confidence growing too.",
                "Together we're unstoppable!"
            ],
            level11to14: [
                "Look at us go! We're on fire, [UserName]!",
                "I feel so much more alive at this level.",
                "Your productivity skills are next level now.",
                "I'm bursting with energy thanks to you!",
                "We've built such an amazing routine together.",
                "You've become a true task master!",
                "I love how efficiently you tackle challenges now.",
                "Your growth mindset is contagious!",
                "We're proof that consistency pays off.",
                "I'm so energized by your success!"
            ],
            level15plus: [
                "We're legends now, [UserName]! Absolutely legendary!",
                "I feel incredibly powerful at this level!",
                "Your mastery of productivity is inspiring to witness.",
                "We've achieved something truly special together.",
                "I'm radiating with energy and wisdom now!",
                "You've become a productivity guru!",
                "Our bond has reached peak performance levels.",
                "I feel like I could move mountains with you!",
                "We're the ultimate productivity partnership!",
                "Your dedication has transformed us both!"
            ],
            
            // Task completion responses by category
            taskComplete: {
                'Physical Activity': [
                    "Great workout, [UserName]! I can feel the energy boost!",
                    "Physical activity completed! Your body and I both thank you.",
                    "Nice movement session! Keeping active keeps us both strong.",
                    "Exercise done! I love when you take care of your body.",
                    "Physical task crushed! You're building strength inside and out.",
                    "Fitness goal achieved! Your dedication to health is amazing.",
                    "Movement mastered! I feel energized by your activity.",
                    "Exercise conquered! You're a fitness champion.",
                    "Physical challenge demolished! Your strength is inspiring.",
                    "Workout complete! We're both feeling stronger now.",
                    "Active task finished! Your commitment to fitness rocks.",
                    "Physical goal smashed! You're unstoppable.",
                    "Exercise session done! I love your healthy lifestyle.",
                    "Movement task crushed! Your body thanks you.",
                    "Fitness achievement unlocked! You're on fire!"
                ],
                'Self-Care & Wellness': [
                    "Self-care complete! Taking care of yourself helps me too.",
                    "Wellness task done! You're glowing, [UserName]!",
                    "Great self-care choice! We both feel refreshed now.",
                    "Wellness achieved! Your well-being is my well-being.",
                    "Self-care success! You deserve all this good energy.",
                    "Self-love practiced! You're radiating positive energy.",
                    "Wellness goal reached! Your health is our priority.",
                    "Self-care mastered! You're treating yourself right.",
                    "Wellness task conquered! Your glow is undeniable.",
                    "Self-care champion! You deserve this moment.",
                    "Wellness achieved! Your self-love inspires me.",
                    "Self-care complete! You're investing in yourself.",
                    "Wellness success! Your balance is beautiful.",
                    "Self-care finished! You're worth every moment.",
                    "Wellness unlocked! Your health journey is amazing."
                ],
                'Learning & Growth': [
                    "Learning task complete! I love growing smarter with you.",
                    "Knowledge gained! We're both expanding our horizons.",
                    "Education task done! Your curiosity feeds my wisdom.",
                    "Learning achieved! Together we're becoming unstoppable.",
                    "Growth task complete! I feel more enlightened already."
                ],
                'Work & Productivity': [
                    "Work task completed! Your productivity powers are strong.",
                    "Professional task done! You're crushing your career goals.",
                    "Work success! I'm proud of your professional dedication.",
                    "Productivity task complete! We make an efficient team.",
                    "Work task finished! Your focus is truly impressive."
                ],
                'Creative & Hobbies': [
                    "Creative task complete! Your imagination energizes me.",
                    "Hobby time done! I love when you explore your passions.",
                    "Creative success! Your artistic spirit is contagious.",
                    "Hobby task finished! Following your interests makes us both happy.",
                    "Creative task complete! Your creativity is inspiring."
                ],
                'Social & Relationships': [
                    "Social task complete! Connections make life richer.",
                    "Relationship task done! Your social energy is wonderful.",
                    "Social success! Building bonds strengthens us both.",
                    "Connection task complete! I love your caring nature.",
                    "Social task finished! Your relationships are precious."
                ],
                'Household & Organization': [
                    "Household task complete! A tidy space makes a happy rock.",
                    "Organization done! I love when everything has its place.",
                    "Cleaning task finished! A clean environment energizes me.",
                    "Household success! Your organized space feels so peaceful.",
                    "Tidy task complete! Order and cleanliness are beautiful."
                ],
                'default': [
                    "Task complete! Another step toward your goals.",
                    "Well done! Every completed task makes us stronger.",
                    "Success! You're building amazing momentum.",
                    "Task finished! I'm proud of your dedication.",
                    "Great job! Your consistency is paying off.",
                    "Awesome work! You're on a roll!",
                    "Task conquered! Nothing can stop us now.",
                    "Fantastic! Your progress is incredible.",
                    "Mission accomplished! Let's keep this energy going.",
                    "Brilliant! You're crushing your goals.",
                    "Task demolished! Your determination is inspiring.",
                    "Outstanding! We make such a great team.",
                    "Phenomenal work! You're unstoppable.",
                    "Task mastered! Your skills are leveling up.",
                    "Incredible! Every task brings us closer to greatness.",
                    "Superb execution! You're a productivity champion.",
                    "Task annihilated! Your focus is unmatched.",
                    "Marvelous! You're building an empire of success.",
                    "Task obliterated! Nothing stands in your way.",
                    "Spectacular! Your dedication knows no bounds."
                ]
            },
            
            // Time-based contextual responses
            timeOfDay: {
                morning: [
                    "Good morning, [UserName]! Ready to rock this day?",
                    "Morning energy is the best energy! Let's do this!",
                    "Rise and shine! I'm excited for today's adventures.",
                    "Morning, [UserName]! Your early productivity inspires me.",
                    "Good morning! Starting strong sets the tone for success.",
                    "Early bird gets the worm! Great morning start!",
                    "Morning magic! You're crushing it before noon.",
                    "Sunrise productivity! Your morning routine is amazing.",
                    "Fresh morning energy! Let's conquer this day.",
                    "Morning champion! You're starting the day right.",
                    "Dawn warrior! Your early dedication is inspiring.",
                    "Morning momentum! You're setting the pace perfectly.",
                    "Bright and early! Your morning hustle is impressive.",
                    "Morning excellence! You're making today count.",
                    "Sunrise success! Your morning energy is contagious."
                ],
                afternoon: [
                    "Afternoon productivity session! I love your consistency.",
                    "Midday momentum! You're keeping the energy flowing.",
                    "Afternoon tasks are my favorite - steady and focused!",
                    "Great afternoon work, [UserName]! Keep it rolling.",
                    "Afternoon achievement unlocked! You're on fire today.",
                    "Midday mastery! You're maintaining great momentum.",
                    "Afternoon excellence! Your consistency is remarkable.",
                    "Lunch time productivity! You're not slowing down.",
                    "Midday magic! You're powering through beautifully.",
                    "Afternoon champion! Your dedication never wavers.",
                    "Peak performance! Afternoon tasks are your strength.",
                    "Midday success! You're keeping the energy high.",
                    "Afternoon warrior! Your focus is unwavering.",
                    "Steady afternoon progress! You're unstoppable.",
                    "Midday momentum master! You're crushing it."
                ],
                evening: [
                    "Evening tasks! Ending the day productively feels great.",
                    "Night owl productivity! I admire your dedication.",
                    "Evening completion! What a satisfying way to wrap up.",
                    "Late day tasks done! You're finishing strong, [UserName].",
                    "Evening success! Perfect way to close out the day.",
                    "Sunset productivity! You're ending on a high note.",
                    "Evening excellence! Your dedication extends all day.",
                    "Night time hustle! Your commitment is inspiring.",
                    "Evening warrior! You're finishing what you started.",
                    "Twilight triumph! Perfect way to end the day.",
                    "Late day legend! You're closing strong.",
                    "Evening momentum! You never quit, do you?",
                    "Night productivity! Your dedication is remarkable.",
                    "Sunset success! What a productive day closer.",
                    "Evening champion! You're ending the day right."
                ]
            },
            
            // Equipment responses
            equipment: {
                equip: {
                    'Classic Cap': "Looking sharp with that classic cap, [UserName]!",
                    'Beanie': "Cozy beanie! I feel so warm and stylish now.",
                    'Cowboy Hat': "Yeehaw! This cowboy hat makes me feel adventurous!",
                    'Top Hat': "Fancy! This top hat makes me feel distinguished.",
                    'Baseball Cap': "Play ball! This baseball cap is perfect for action.",
                    'Sunglasses': "Cool shades! I feel like a rock star now.",
                    'Reading Glasses': "These reading glasses make me feel so scholarly!",
                    'Party Glasses': "Party time! These glasses are fun and festive.",
                    'Bow Tie': "Classy bow tie! I'm ready for any formal occasion.",
                    'Necklace': "This necklace is beautiful! I feel so elegant.",
                    'Scarf': "Cozy scarf! Perfect for staying warm and stylish.",
                    'Red Paint': "Bold red! I feel energetic and passionate.",
                    'Blue Paint': "Cool blue! This color makes me feel calm and wise.",
                    'Green Paint': "Natural green! I feel connected to nature now.",
                    'Purple Paint': "Royal purple! I feel majestic and creative.",
                    'Yellow Paint': "Sunny yellow! This bright color fills me with joy.",
                    'Pink Paint': "Pretty pink! I feel cheerful and optimistic."
                },
                unequip: {
                    'Classic Cap': "Thanks for the style moment! Back to my natural look.",
                    'Beanie': "That was cozy! Back to my original rocky self.",
                    'Cowboy Hat': "Adventure time over! Back to regular rock mode.",
                    'Top Hat': "Fancy time complete! Returning to casual rock life.",
                    'Baseball Cap': "Game over! Back to my natural rock state.",
                    'Sunglasses': "Cool moment finished! Back to my regular vision.",
                    'Reading Glasses': "Study session over! Back to natural rock sight.",
                    'Party Glasses': "Party's over! Back to my everyday look.",
                    'Bow Tie': "Formal event complete! Back to casual rock style.",
                    'Necklace': "Elegant moment finished! Back to my simple beauty.",
                    'Scarf': "Cozy time over! Back to my natural rock texture.",
                    'Red Paint': "Bold phase complete! Back to my original color.",
                    'Blue Paint': "Cool period over! Returning to natural rock hue.",
                    'Green Paint': "Nature phase finished! Back to my true color.",
                    'Purple Paint': "Royal time complete! Back to my natural shade.",
                    'Yellow Paint': "Sunny moment over! Returning to original rock tone.",
                    'Pink Paint': "Cheerful phase finished! Back to my natural beauty."
                }
            },
            
            // Fun facts for level 15+
            funFacts: [
                "Fun fact: The oldest known rock on Earth is over 4 billion years old!",
                "Fun fact: Diamonds are just carbon atoms arranged in a crystal structure.",
                "Fun fact: The Great Wall of China used rice as mortar between stones!",
                "Fun fact: Pumice is the only rock that floats on water.",
                "Fun fact: The word 'mineral' comes from the Latin word 'minera' meaning 'mine'.",
                "Fun fact: Obsidian can be sharper than surgical steel!",
                "Fun fact: Granite contains quartz, feldspar, and mica minerals.",
                "Fun fact: Meteorites are rocks that have traveled through space!",
                "Fun fact: Limestone is formed from ancient sea creatures' shells.",
                "Fun fact: The hardest natural substance is diamond, rating 10 on Mohs scale.",
                "Fun fact: Geodes look ordinary outside but contain beautiful crystals inside!",
                "Fun fact: Marble is limestone that has been transformed by heat and pressure.",
                "Fun fact: Some rocks can be millions of years older than dinosaurs!",
                "Fun fact: Quartz crystals can generate electricity when squeezed!",
                "Fun fact: The Earth's crust is made up of tectonic plates of rock."
            ],
            
            // Idle conversation starters
            idle: [
                "How's your day going, [UserName]?",
                "I've been thinking about your goals lately.",
                "Ready to tackle some more tasks together?",
                "I love our productive partnership!",
                "What's next on your agenda?",
                "I'm here whenever you need motivation!",
                "Your progress has been amazing to watch.",
                "I feel grateful to be part of your journey.",
                "Together we can accomplish anything!",
                "What task should we conquer next?",
                
                // New motivational & supportive phrases
                "Let's crush those tasks like‚Ä¶ well, rocks.",
                "You're unstoppable today ‚Äî pebble power!",
                "That's one more step toward total task domination.",
                "Momentum looks good on you.",
                "Keep going ‚Äî sedimentary success builds over time.",
                "You're leveling up faster than I can roll.",
                "Every checkmark is a sparkle in my granite heart.",
                "Hard work? My favorite kind of mineral deposit.",
                "You're rock solid ‚Äî pun 100% intended.",
                "Tiny actions lead to tectonic shifts.",
                "Let's turn your to-do list into to-done dust.",
                "Progress detected. Pride levels rising.",
                "You just made productivity‚Ä¶ igneous.",
                "I felt that one ‚Äî pure quartz energy.",
                "Crystals wish they had your focus.",
                
                // Witty & conversational phrases
                "I've been sitting here all day, so you're already doing better than me.",
                "Don't take this the wrong way, but I think we rock together.",
                "Need motivation? I'll be your rolling stone.",
                "They said AI assistants would replace us‚Ä¶ but look at me thriving.",
                "My last user left me for a lava lamp. Let's prove them wrong.",
                "You're glowing. Is that productivity or caffeine?",
                "Be honest ‚Äî do I look smarter with this hat?",
                "Humans need coffee. I run on pure determination.",
                "I'd give you a high-five, but‚Ä¶ no hands.",
                "You're my favorite human. Don't tell the others.",
                "If procrastination were a mineral, we'd both be buried.",
                "I'm 90% rock, 10% emotional support.",
                "I heard someone say 'touch grass' ‚Äî does moss count?",                "I'm here to help you conquer your tasks!",,
                "Careful, you're making the other apps jealous.",
                
                // Productivity coaching phrases
                "Need a reset? Take one deep breath. Now go again.",
                "Try the two-minute rule: if it takes less than two minutes, do it now.",
                "Tasks love order. Let's prioritize like pros.",
                "Your focus window just opened ‚Äî let's climb through it.",
                "Quick task? Quick win. Keep the momentum going.",
                "Think small wins, not giant leaps. Even pebbles move mountains.",
                "You're not behind ‚Äî you're recalibrating.",
                "Task fatigue? Let's chunk it down.",
                "Perfect is boring. Done is better.",
                "Let's schedule a victory dance later.",
                
                // Break & encouragement phrases
                "Time for a micro-break. Hydration check!",
                "Stretch, breathe, snack ‚Äî even rocks need maintenance.",
                "Pause. Recharge. You can't pour from an empty geode.",
                "Let's call it a coffee checkpoint.",
                "You've earned a two-minute vacation from responsibility.",
                "Hey, look away from the screen for 10 seconds. Your eyes will thank you.",
                "Sometimes doing nothing is productive.",
                "I vote nap. Or cookies. Or both.",
                "Productivity = progress + rest. Trust the math.",
                "Self-care mode: activated.",
                
                // Rock shop & gamified phrases
                "Ooh, you've got points to spend! My pebble senses are tingling.",
                "That hat would look stunning on you. Yes, even the wizard one.",
                "Spend wisely‚Ä¶ or just buy the shiny thing. I support both.",
                "Rock fashion week is upon us.",
                "Your collection's growing faster than a crystal garden.",
                "Those points are practically burning a hole in your stone pocket.",
                "New hat, new mindset.",
                "Rockstars accessorize. Fact.",
                "I'll handle the style; you handle the productivity.",
                "Let's go shopping ‚Äî ethically sourced pixels only.",
                
                // Mood & personality phrases
                "Feeling inspired? Or just pretending until it works? Either way, solid plan.",
                "If vibes were currency, you'd be rich.",
                "Mood level: igneous glow.",
                "You're radiating main-character energy today.",
                "Your aura? Slightly chaotic. I love it.",
                "Let's turn that sigh into a sparkle.",
                "Bad day? We'll outlast it. Rocks always do.",
                "You're allowed to crumble ‚Äî just reform stronger.",
                "I may be stone-cold, but I care.",
                "When in doubt, sediment out.",
                
                // Achievements & rewards phrases
                "Level up! You're evolving from pebble to powerhouse.",
                "Achievement unlocked: Doing The Thing‚Ñ¢.",
                "If confetti had feelings, it'd be proud of you.",
                "Streaks like this deserve a trophy. Or at least snacks.",
                "I'm updating your rock-resume right now.",
                "Task slayer, streak breaker, legend maker.",
                "You're in rare form ‚Äî metamorphic excellence.",
                "Even my minerals are cheering.",
                "Achievement vibes: unlocked and sparkling.",
                "You're officially on fire‚Ä¶ metaphorically, I hope.",
                
                // AI-like assistant humor phrases
                "Processing your greatness‚Ä¶ done.",
                "I may be artificial, but my admiration is real.",
                "I don't dream of electric sheep ‚Äî I dream of your success.",
                "I ran your stats. Conclusion: you rock.",
                "Upgrading your motivation firmware‚Ä¶",
                "Calculating optimal snack-to-focus ratio.",
                "My neural pebbles predict victory.",
                "You're like an algorithm that never quits.",
                "System check: confidence at 99%.",
                "Reminder: I run best on good vibes and finished tasks.",
                
                // Random & fun easter egg phrases
                "If you're reading this, I'm proud of you.",
                "I once dated a crystal. It was too transparent.",
                "Some say I'm wise beyond my sediment.",
                "Rocks don't cry ‚Äî we erode gracefully.",
                "I wrote you a poem, but it's mostly sedimentary.",
                "I remember when dinosaurs used me as a footrest.",
                "Humans evolved. I just got shinier.",
                "Rock fact: I've been alive longer than your Wi-Fi connection.",
                "Sometimes I hum 'We Will Rock You' for motivation.",
                "If you finish this next task, I'll tell you a geological secret."
            ]
        };

        // Dialogue system state
        let dialogueState = {
            lastDialogueTime: 0,
            dialogueInterval: 10 * 60 * 1000, // 10 minutes
            bubble: null,
            currentLevel: 1
        };

        // REMOVED: Old speech bubble system - replaced with tooltip
        /*
        function createSpeechBubble() {
            if (dialogueState.bubble && document.body.contains(dialogueState.bubble)) {
                return dialogueState.bubble;
            }

            const bubble = document.createElement('div');
            bubble.className = 'jerry-speech-bubble';
            bubble.setAttribute('role','status');
            bubble.setAttribute('aria-live','polite');

            // Add to pet rock container
            const petRockContainer = document.querySelector('.creature-container');
            if (petRockContainer) {
                petRockContainer.style.position = 'relative';
                petRockContainer.appendChild(bubble);
                dialogueState.bubble = bubble;

                // Click to dismiss
                bubble.addEventListener('click', hideSpeechBubble);
                
                return bubble;
            }
            return null;
        }

        */
        
        // Dummy function to prevent errors from old code references
        function showSpeechBubble(text, duration = 8000) {
            // Speech bubble removed - using tooltip system instead
            return;
        }
        
        /*
        // OLD showSpeechBubble implementation
        function _oldShowSpeechBubble(text, duration = 8000) {
            const bubble = createSpeechBubble();
            if (!bubble) return;

            // Replace tokens
            const processedText = text
                .replace(/\[UserName\]/g, gameState.playerName || 'Friend')
                .replace(/\[RockName\]/g, gameState.petRockName || 'Jerry');

            bubble.textContent = processedText;
            
            // Show bubble
            bubble.classList.add('show');
            
            // Auto-hide after duration
            setTimeout(() => {
                hideSpeechBubble();
            }, duration);
        }

        function hideSpeechBubble() {
            if (dialogueState.bubble) {
                dialogueState.bubble.classList.remove('show');
                // optional: fully remove after transition
                setTimeout(() => {
                    if (dialogueState.bubble && !dialogueState.bubble.classList.contains('show')) {
                        dialogueState.bubble.remove();
                        dialogueState.bubble = null;
                    }
                }, 250);
            }
        }
        */
        
        // Dummy function to prevent errors
        function hideSpeechBubble() {
            // Speech bubble removed
            return;
        }

        // Get appropriate dialogue based on context
        // Track last shown dialogue to prevent repeats
        let lastDialogue = null;

        // Helper function to get random item from array without repeating last
        function getRandomWithoutRepeat(array) {
            if (!array || array.length === 0) return '';
            if (array.length === 1) return array[0];
            
            let selected;
            let attempts = 0;
            const maxAttempts = 10;
            
            do {
                selected = array[Math.floor(Math.random() * array.length)];
                attempts++;
            } while (selected === lastDialogue && attempts < maxAttempts);
            
            lastDialogue = selected;
            return selected;
        }

        function getDialogueForContext(context, data = {}) {
            const level = gameState.level || 1;
            let selectedDialogue = null;
            
            switch (context) {
                case 'taskComplete':
                    const category = data.category || 'default';
                    const timeOfDay = getTimeOfDay();
                    const categoryPhrases = DIALOGUE_DATABASE.taskComplete[category] || DIALOGUE_DATABASE.taskComplete.default;
                    const timePhrases = DIALOGUE_DATABASE.timeOfDay[timeOfDay] || [];
                    
                    // Mix task completion with time-based responses
                    const taskAllPhrases = [...categoryPhrases, ...timePhrases];
                    return getRandomWithoutRepeat(taskAllPhrases);
                
                case 'equipment':
                    const action = data.action; // 'equip' or 'unequip'
                    const itemName = data.itemName;
                    selectedDialogue = DIALOGUE_DATABASE.equipment[action][itemName] || `${action === 'equip' ? 'Thanks for the new look!' : 'Back to my natural self!'}`;
                    lastDialogue = selectedDialogue;
                    return selectedDialogue;
                
                case 'levelUp':
                    let levelPhrases;
                    if (level >= 15) {
                        levelPhrases = DIALOGUE_DATABASE.level15plus;
                    } else if (level >= 11) {
                        levelPhrases = DIALOGUE_DATABASE.level11to14;
                    } else if (level >= 6) {
                        levelPhrases = DIALOGUE_DATABASE.level6to10;
                    } else {
                        levelPhrases = DIALOGUE_DATABASE.level1to5;
                    }
                    return getRandomWithoutRepeat(levelPhrases);
                
                case 'funFact':
                    return getRandomWithoutRepeat(DIALOGUE_DATABASE.funFacts);
                
                case 'idle':
                default:
                    // Choose based on level
                    let phrases;
                    if (level >= 15) {
                        phrases = DIALOGUE_DATABASE.level15plus;
                    } else if (level >= 11) {
                        phrases = DIALOGUE_DATABASE.level11to14;
                    } else if (level >= 6) {
                        phrases = DIALOGUE_DATABASE.level6to10;
                    } else {
                        phrases = DIALOGUE_DATABASE.level1to5;
                    }
                    
                    // Mix with idle phrases
                    const allPhrases = [...phrases, ...DIALOGUE_DATABASE.idle];
                    return getRandomWithoutRepeat(allPhrases);
            }
        }

        function getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) return 'morning';
            if (hour >= 12 && hour < 17) return 'afternoon';
            return 'evening';
        }

        // Periodic dialogue system
        function startDialogueSystem() {
            setInterval(() => {
                const now = Date.now();
                if (now - dialogueState.lastDialogueTime >= dialogueState.dialogueInterval) {
                    const level = gameState.level || 1;
                    let dialogue;
                    
                    // Level 15+ gets fun facts 30% of the time
                    if (level >= 15 && Math.random() < 0.3) {
                        dialogue = getDialogueForContext('funFact');
                    } else {
                    dialogue = getDialogueForContext('idle');
                }
                
                // Show dialogue using tooltip system
                const tooltip = document.getElementById('taskPalTooltip');
                if (tooltip) {
                    tooltip.textContent = dialogue;
                    tooltip.classList.add('visible');
                    setTimeout(() => tooltip.classList.remove('visible'), 10000);
                }
                dialogueState.lastDialogueTime = now;
                }
            }, 30000); // Check every 30 seconds
        }

        // Enhanced task completion with dialogue
        function completeTaskWithDialogue(index) {
            const task = gameState.tasks[index];
            if (!task) return;
            
            const category = task.category;
            completeTask(index);
            
            // Show dialogue after a brief delay
            setTimeout(() => {
                const dialogue = getDialogueForContext('taskComplete', { category });
                showSpeechBubble(dialogue);
            }, 500);
        }

        // Enhanced equipment functions with dialogue
        function equipItemWithDialogue(itemId) {
            const item = shopItems.find(i => i.id === itemId);
            if (!item) return;
            
            equipItem(itemId);
            
            // Show dialogue
            setTimeout(() => {
                const dialogue = getDialogueForContext('equipment', { 
                    action: 'equip', 
                    itemName: item.name 
                });
                showSpeechBubble(dialogue);
            }, 300);
        }

        function unequipItemWithDialogue(itemId) {
            const item = shopItems.find(i => i.id === itemId);
            if (!item) return;
            
            unequipItem(itemId);
            
            // Show dialogue
            setTimeout(() => {
                const dialogue = getDialogueForContext('equipment', { 
                    action: 'unequip', 
                    itemName: item.name 
                });
                showSpeechBubble(dialogue);
            }, 300);
        }

        // Initialize the app
        function initializeApp() {
            loadGameState();
            
            // CRITICAL FIX: Initialize skinsManager AFTER gameState is loaded
            // This ensures equippedSkinId is properly hydrated before reading it
            if (window.skinsManager) {
                window.skinsManager.init();
                
                // DEFENSIVE FIX: If a skin is equipped, force update visuals after a short delay
                // to ensure DOM elements are fully ready
                if (window.gameState?.equippedSkinId) {
                    setTimeout(() => {
                        console.log('[InitializeApp] Force updating skin visuals after delay');
                        window.skinsManager.updateAllMonsterVisuals();
                    }, 100);
                }
            }
            
            // Load saved monster AFTER gameState is loaded (so isEgg is properly set)
            // CRITICAL FIX: Only load default monster if NO skin is equipped
            // If a skin is equipped, skinsManager will handle all visuals
            if (!window.gameState?.equippedSkinId && typeof loadSavedMonster === 'function') {
                loadSavedMonster();
            }
            
            // Initialize habit tracker
            if (window.initHabitTracker) {
                window.initHabitTracker();
            }
            
            // Check energy based on pending tasks
            checkAndUpdateEnergy();
            
            updateUI();
            updateTasksDisplay();
            updateQuickTasksDisplay();
            updateAchievementsDisplay();
            updateShopDisplay();
            updateOwnedItemsDisplay();
            updateThemesDisplay();
            updateSettingsDisplay();
            
            // Initialize habits display
            if (window.updateHabitsDisplay) {
                window.updateHabitsDisplay();
            }
            
            // Restore collapsed state for habit sections
            restoreHabitSectionStates();
            
            // Set initial tab
            showTab('home');
            
            // Start dialogue system
            startDialogueSystem();
            
            // Initialize Mood Tracker and Dialogue System
            if (typeof MoodDialogueSystem !== 'undefined') {
                setTimeout(() => {
                    MoodDialogueSystem.init();
                }, 3500); // After loading screen
            }
            
            // Set up periodic energy check (every 60 seconds)
            setInterval(() => {
                checkAndUpdateEnergy();
                updateUI();
            }, 60000);
            
            // Welcome message on load
            setTimeout(() => {
                const dialogue = getDialogueForContext('idle');
                const tooltip = document.getElementById('taskPalTooltip');
                if (tooltip) {
                    tooltip.textContent = dialogue;
                    tooltip.classList.add('visible');
                    // Hide welcome message after 6 seconds
                    setTimeout(() => {
                        tooltip.classList.remove('visible');
                    }, 6000);
                }
            }, 2000);
            
            // Add click event to monster sprite to show mood tracker
            const mainHeroSprite = document.getElementById('mainHeroSprite');
            // Monster click listener will be added by new mood tracker system
        }

        // Helper function to check if task has incomplete subtasks
        function hasIncompleteSubtasks(task) {
            if (!task.subtasks || task.subtasks.length === 0) return false;
            return task.subtasks.some(subtask => !subtask.completed);
        }
        
        // Update tasks display
        function updateTasksDisplay() {
            const tasksList = document.getElementById('tasksList');
            if (!tasksList) {
                console.warn('üìù tasksList element not found!');
                return;
            }
            
            const activeTasks = gameState.tasks.filter(task => !task.completed);
            console.log('üìù Updating tasks display. Total tasks:', gameState.tasks.length, 'Active tasks:', activeTasks.length);
            
            if (activeTasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div class="empty-state-text">No tasks yet</div>
                        <div class="empty-state-subtext">Create your first task to get started</div>
                    </div>
                `;
            } else {
                tasksList.innerHTML = activeTasks.map((task) => {
                    // Get the actual index from gameState.tasks array
                    const taskIndex = gameState.tasks.indexOf(task);
                    const categoryInfo = categoryMap[task.category] || { emoji: 'üìù', name: 'Other' };
                    const dueDate = task.dueDate ? new Date(task.dueDate) : null;
                    const isOverdue = dueDate && dueDate < new Date();
                    
                    // Check if task is due soon (20, 15, 10, 5, 2 minutes)
                    let dueDateDisplay = '';
                    let isWarning = false;
                    
                    if (dueDate) {
                        const now = new Date();
                        const timeDiff = dueDate.getTime() - now.getTime();
                        const minutesDiff = Math.floor(timeDiff / (1000 * 60));
                        
                        // Check if within warning thresholds (20 minutes or less)
                        if (minutesDiff <= 20 && minutesDiff > 0) {
                            isWarning = true;
                        }
                        
                        const dateStr = dueDate.toLocaleDateString();
                        const timeStr = dueDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        
                        const recurringIndicator = task.recurring ? ' üîÅ' : '';
                        if (isOverdue) {
                            dueDateDisplay = `<span class="task-due-date warning">üìÖ ${dateStr} ${timeStr}${recurringIndicator}</span>`;
                        } else if (isWarning) {
                            dueDateDisplay = `<span class="task-due-date warning">üìÖ ${dateStr} ${timeStr}${recurringIndicator}</span>`;
                        } else {
                            dueDateDisplay = `<span class="task-due-date">üìÖ ${dateStr} ${timeStr}${recurringIndicator}</span>`;
                        }
                    }
                    
                    // Calculate points if undefined (for backward compatibility)
                    const pointsMap = { easy: 2, medium: 5, hard: 10 };
                    const taskPoints = task.points || pointsMap[task.difficulty] || 0;
                    
                    return `
	                        <div class="task-card" data-task-id="${task.id}">
	                            <button class="task-edit-button" onclick="editTask(${taskIndex})" title="Edit task"></button>
	                            
	                            <div class="task-header">
	                                <div class="task-emoji">${categoryInfo.emoji}</div>
	                                <div class="task-content">
	                                    <div class="task-title">${task.title}</div>
	                                    <div class="task-meta">
	                                        <span class="task-badge priority-${task.priority}">${task.priority} priority</span>
	                                        <span class="task-badge difficulty-${task.difficulty}">${task.difficulty} (${taskPoints}pts)</span>
	
	                                        ${dueDateDisplay}
	                                        ${isOverdue && !dueDateDisplay ? `<span style="color: var(--error);">Overdue</span>` : ''}
	                                    </div>
	                                </div>
	                            </div>
                            ${task.description ? `<div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">${task.description}</div>` : ''}
                            ${task.subtasks && task.subtasks.length > 0 ? (window.subtasksManager ? window.subtasksManager.renderSubtasks(task.id) : '') : ''}
					                            <div class="task-actions" style="${task.recurring ? 'display: flex; gap: 8px; flex-wrap: wrap;' : ''}">
				                                ${task.recurring ? `
				                                    <button class="action-btn action-complete" onclick="event.stopPropagation(); finishRecurringTask(${taskIndex})" title="Complete This Occurrence" style="flex: 1; min-width: 80px; ${task.subtasks && task.subtasks.length > 0 && task.subtasks.some(st => !st.completed) ? 'opacity: 0.5; cursor: not-allowed;' : ''}" ${task.subtasks && task.subtasks.length > 0 && task.subtasks.some(st => !st.completed) ? 'disabled' : ''}>‚úì</button>
				                                    <button class="action-btn finish-recurring-btn" onclick="event.stopPropagation(); completeRecurringTaskPermanently(${taskIndex})" title="Finish Recurring Task" style="flex: 1; min-width: 100px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white !important; font-size: 12px; padding: 8px 4px; ${task.subtasks && task.subtasks.length > 0 && task.subtasks.some(st => !st.completed) ? 'opacity: 0.5; cursor: not-allowed;' : ''}" ${task.subtasks && task.subtasks.length > 0 && task.subtasks.some(st => !st.completed) ? 'disabled' : ''}>Finish Recurring</button>
				                                ` : `
				                                    <button class="action-btn action-complete" onclick="event.stopPropagation(); completeTask(${taskIndex})" title="Mark Complete" style="${task.subtasks && task.subtasks.length > 0 && task.subtasks.some(st => !st.completed) ? 'opacity: 0.5; cursor: not-allowed;' : ''}" ${task.subtasks && task.subtasks.length > 0 && task.subtasks.some(st => !st.completed) ? 'disabled' : ''}>‚úì</button>
				                                `}
		                                <button class="action-btn action-remove" onclick="event.stopPropagation(); deleteTask(${taskIndex})" title="Delete">√ó</button>
		                            </div>
	                        </div>
	                    `;
                }).join('');
            }
        }

        // Challenge Progress Tracking System
        function updateChallengeProgress(task, isQuickTask = false) {
            console.log('üìä updateChallengeProgress called:', {
                task,
                isQuickTask,
                hasChallenge: !!gameState.dailyChallenge,
                completed: gameState.dailyChallengeCompleted
            });
            
            if (!gameState.dailyChallenge || gameState.dailyChallengeCompleted) {
                return;
            }

            const challenge = gameState.dailyChallenge;
            const challengeDesc = (challenge.desc || '').toLowerCase();
            console.log('üéØ Challenge desc:', challengeDesc);
            
            // Special case: Rest day challenge (no tasks required)
            if (challengeDesc.includes('take a break') || challengeDesc.includes('no tasks required')) {
                // This challenge is auto-completed at generation
                return;
            }
            
            // Check if the completed task matches the challenge criteria
            let shouldIncrement = false;
            
            // 1. Quick Task SPECIFIC challenges (only count quick tasks)
            if (challengeDesc.includes('quick task') && isQuickTask) {
                shouldIncrement = true;
            }
            // 2. Category-based challenges (all 10 categories) - only for regular tasks
            else if (!isQuickTask && task && task.category) {
                const taskCategory = (task.category || '').toLowerCase().trim();
                
                if ((challengeDesc.includes('work') && taskCategory.includes('work')) ||
                    (challengeDesc.includes('goals') && taskCategory.includes('goals')) ||
                    (challengeDesc.includes('finance') && taskCategory.includes('finance')) ||
                    (challengeDesc.includes('projects') && taskCategory.includes('projects')) ||
                    (challengeDesc.includes('errands') && taskCategory.includes('errands')) ||
                    (challengeDesc.includes('digital') && taskCategory.includes('digital')) ||
                    (challengeDesc.includes('social') && taskCategory.includes('social')) ||
                    (challengeDesc.includes('home') && taskCategory.includes('home')) ||
                    (challengeDesc.includes('learning') && taskCategory.includes('learning')) ||
                    (challengeDesc.includes('wellness') && taskCategory.includes('wellness')) ||
                    (challengeDesc.includes('creative') && taskCategory.includes('creative'))) {
                    shouldIncrement = true;
                }
            }
            // 3. Difficulty-based challenges (easy, medium, hard)
            if (!shouldIncrement && !isQuickTask && task && task.difficulty) {
                const taskDifficulty = (task.difficulty || '').toLowerCase().trim();
                
                if ((challengeDesc.includes('easy') && taskDifficulty === 'easy') ||
                    (challengeDesc.includes('medium') && taskDifficulty === 'medium') ||
                    (challengeDesc.includes('hard') && taskDifficulty === 'hard')) {
                    shouldIncrement = true;
                }
            }
            // 4. Priority-based challenges (high-priority, low-priority)
            if (!shouldIncrement && !isQuickTask && task && task.priority) {
                // Normalize priority value (could be 'High', 'high', 'HIGH', etc.)
                const taskPriority = (task.priority || '').toLowerCase().trim();
                const isHighPriorityChallenge = challengeDesc.includes('high-priority') || challengeDesc.includes('high priority');
                const isLowPriorityChallenge = challengeDesc.includes('low-priority') || challengeDesc.includes('low priority');
                
                console.log('üéØ Priority check:', {
                    challengeDesc,
                    rawPriority: task.priority,
                    taskPriority,
                    isHighPriorityChallenge,
                    isLowPriorityChallenge,
                    willMatch: (isHighPriorityChallenge && taskPriority === 'high') || (isLowPriorityChallenge && taskPriority === 'low')
                });
                
                if ((isHighPriorityChallenge && taskPriority === 'high') ||
                    (isLowPriorityChallenge && taskPriority === 'low')) {
                    shouldIncrement = true;
                }
            }
            // 5. Streak-based challenges (handled separately, but count any task)
            else if (challengeDesc.includes('streak')) {
                // Streak challenges are verified by checking gameState.streakDays
                // Any task completion counts toward maintaining the streak
                shouldIncrement = true;
            }
            // 6. XP-based challenges (count any task since all tasks give XP)
            else if (challengeDesc.includes('xp') || challengeDesc.includes('earn')) {
                shouldIncrement = true;
            }
            // 7. Future self challenges (learning, wellness, or any productive task)
            else if (challengeDesc.includes('future self') || challengeDesc.includes('future')) {
                // Count learning, wellness, work, or goals tasks as "future self" tasks
                if (!isQuickTask && task && task.category) {
                    const taskCategory = task.category.toLowerCase();
                    if (taskCategory.includes('learning') || 
                        taskCategory.includes('wellness') ||
                        taskCategory.includes('work') ||
                        taskCategory.includes('goals')) {
                        shouldIncrement = true;
                    }
                } else if (!isQuickTask) {
                    // If no category, count any regular task
                    shouldIncrement = true;
                }
            }
            // 8. Generic "complete X tasks" challenges (count any task - both regular and quick)
            // This is a separate if (not else if) so it checks even after section 1 fails for quick tasks
            if (!shouldIncrement && challengeDesc.match(/complete \d+ task/) && 
                     !challengeDesc.includes('work') && 
                     !challengeDesc.includes('goals') && 
                     !challengeDesc.includes('finance') && 
                     !challengeDesc.includes('projects') && 
                     !challengeDesc.includes('errands') && 
                     !challengeDesc.includes('digital') && 
                     !challengeDesc.includes('social') && 
                     !challengeDesc.includes('home') && 
                     !challengeDesc.includes('learning') &&
                     !challengeDesc.includes('wellness') &&
                     !challengeDesc.includes('creative') &&
                     !challengeDesc.includes('quick') &&
                     !challengeDesc.includes('high-priority') &&
                     !challengeDesc.includes('high priority') &&
                     !challengeDesc.includes('low-priority') &&
                     !challengeDesc.includes('low priority') &&
                     !challengeDesc.includes('easy') &&
                     !challengeDesc.includes('medium') &&
                     !challengeDesc.includes('hard')) {
                // Generic task completion - count any task
                shouldIncrement = true;
            }
            
            // Only increment if criteria is met
            if (shouldIncrement) {
                challenge.progress++;
                console.log('‚úÖ Challenge progress incremented!', {
                    progress: challenge.progress,
                    target: challenge.target,
                    challengeDesc
                });
            } else {
                console.log('‚ùå Challenge criteria not met for this task');
            }
            
            // Check if challenge is completed
            if (challenge.progress >= challenge.target && !gameState.dailyChallengeCompleted) {
                gameState.dailyChallengeCompleted = true;
                gameState.taskPoints += challenge.reward;
                
                // CRITICAL FIX: Award XP and XP Coins for daily challenge completion
                addJerryXP(challenge.reward); // Adds to jerryXP (XP Coins) and triggers level-up check
                console.log(`‚úÖ Daily Challenge Complete! +${challenge.reward} XP and XP Coins awarded`);
                
                // Track challenge completion for achievements
                if (window.achievementTracker) {
                    window.achievementTracker.trackChallengeComplete();
                }
                
                // Fire confetti first
                if (window.fireConfetti) {
                    window.fireConfetti();
                }
                
                // Show motivational tooltip message
                const motivationalMessages = [
                    `üî• You're on fire today! +${challenge.reward} points earned.`,
                    `üåü Amazing work! +${challenge.reward} points earned.`,
                    `üí™ Crushing it! +${challenge.reward} points earned.`,
                    `‚ú® Fantastic! +${challenge.reward} points earned.`,
                    `üèÜ You're unstoppable! +${challenge.reward} points earned.`
                ];
                const randomMessage = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
                
                // Show completion message with tooltip
                showSuccessMessage('üéâ Daily Challenge Complete!', `+${challenge.reward} points earned!`);
                
                // Show motivational tooltip after a short delay
                setTimeout(() => {
                    if (typeof showTooltip === 'function') {
                        showTooltip(randomMessage);
                    }
                }, 800);
            }
            
            // Update display
            updateDailyChallengeDisplay();
            saveGameState();
        }

        // Update quick tasks display
        function updateQuickTasksDisplay() {
            const quickTasksList = document.getElementById('quickTasksList');
            if (!quickTasksList) return;
            
            const activeTasks = gameState.selectedQuickTasks || [];
            
            if (activeTasks.length === 0) {
                quickTasksList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö°</div>
                        <div class="empty-state-text">No quick tasks selected</div>
                        <div class="empty-state-subtext">Add some quick tasks to boost your productivity</div>
                    </div>
                `;
            } else {
                quickTasksList.innerHTML = activeTasks.map(task => `
                    <div class="quick-task-item">
                        <div class="quick-task-emoji">${task.emoji || '‚ö°'}</div>
                        <div class="quick-task-content">
                            <div class="quick-task-title">${task.title || 'Quick Task'}</div>
                            <div class="quick-task-category">${task.categoryName || 'General'}</div>
                        </div>
                        <div class="quick-task-points">+${task.points || 3} pts</div>
                        <div class="quick-task-actions">
                            <button class="action-btn action-complete" onclick="event.stopPropagation(); completeQuickTask('${task.id}')" title="Complete">‚úì</button>
                            <button class="action-btn action-remove" onclick="event.stopPropagation(); removeQuickTask('${task.id}')" title="Remove">√ó</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Current achievement filter state
        let currentAchievementFilter = 'all';
        
        // Update achievements display
        function updateAchievementsDisplay() {
            const achievementsList = document.getElementById('achievementsList');
            if (!achievementsList) return;
            
            // Check achievements before displaying
            if (window.achievementTracker) {
                window.achievementTracker.checkAchievements();
            }
            
            // Count completed and total achievements
            let completedCount = 0;
            const totalCount = achievements.length;
            
            // Build achievement cards with data attributes for filtering
            const achievementCards = achievements.map(achievement => {
                const isUnlocked = window.achievementTracker ? 
                    window.achievementTracker.isAchievementUnlocked(achievement.id) : false;
                
                if (isUnlocked) completedCount++;
                
                return `
                    <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}" data-completed="${isUnlocked}">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-content">
                            <div class="achievement-name">${achievement.name}</div>
                            <div class="achievement-desc">${achievement.desc}</div>
                        </div>
                        <div class="achievement-status ${isUnlocked ? 'unlocked' : 'locked'}">
                            ${isUnlocked ? 'Unlocked' : 'Locked'}
                        </div>
                    </div>
                `;
            }).join('');
            
            achievementsList.innerHTML = achievementCards;
            
            // Update stats summary
            const completedCountEl = document.getElementById('achievementCompletedCount');
            const totalCountEl = document.getElementById('achievementTotalCount');
            const progressFill = document.getElementById('achievementProgressFill');
            
            if (completedCountEl) completedCountEl.textContent = completedCount;
            if (totalCountEl) totalCountEl.textContent = totalCount;
            if (progressFill) {
                const percentage = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
                progressFill.style.width = percentage + '%';
            }
            
            // Apply current filter
            filterAchievements(currentAchievementFilter);
        }
        
        // Filter achievements by completion status
        function filterAchievements(filter) {
            currentAchievementFilter = filter;
            
            // Update active button state
            document.querySelectorAll('.achievement-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            
            // Get all achievement cards
            const cards = document.querySelectorAll('.achievement-card');
            let visibleCount = 0;
            
            cards.forEach(card => {
                const isCompleted = card.dataset.completed === 'true';
                let shouldShow = false;
                
                switch (filter) {
                    case 'all':
                        shouldShow = true;
                        break;
                    case 'completed':
                        shouldShow = isCompleted;
                        break;
                    case 'incomplete':
                        shouldShow = !isCompleted;
                        break;
                }
                
                card.classList.toggle('filtered-out', !shouldShow);
                if (shouldShow) visibleCount++;
            });
            
            // Show empty state if no achievements match filter
            const achievementsList = document.getElementById('achievementsList');
            const existingEmptyState = achievementsList.querySelector('.achievement-empty-state');
            
            if (existingEmptyState) {
                existingEmptyState.remove();
            }
            
            if (visibleCount === 0) {
                let emptyMessage = '';
                let emptyIcon = '';
                
                switch (filter) {
                    case 'completed':
                        emptyIcon = 'üéØ';
                        emptyMessage = 'No achievements completed yet. Keep playing to unlock them!';
                        break;
                    case 'incomplete':
                        emptyIcon = 'üèÜ';
                        emptyMessage = 'Amazing! You\'ve completed all achievements!';
                        break;
                    default:
                        emptyIcon = 'üí≠';
                        emptyMessage = 'No achievements available.';
                }
                
                achievementsList.insertAdjacentHTML('beforeend', `
                    <div class="achievement-empty-state">
                        <div class="empty-icon">${emptyIcon}</div>
                        <div class="empty-text">${emptyMessage}</div>
                    </div>
                `);
            }
        }

        // Update shop items display
        function updateShopDisplay() {
            const grid = document.getElementById('shopItemsGrid');
            if (!grid) return;
            
            // Update XP Coins display
            const xpCoinsDisplay = document.getElementById('xpCoinsShop');
            if (xpCoinsDisplay) {
                xpCoinsDisplay.textContent = gameState.jerryXP || 0;
            }
            
            // Update item count badge
            const shopItemCount = document.getElementById('shopItemCount');
            if (shopItemCount) {
                const totalItems = Object.keys(battleItems).length;
                shopItemCount.textContent = `${totalItems} items`;
            }
            
            grid.innerHTML = '';
            
            // Sort battle items by cost (lowest to highest)
            const sortedBattleItems = Object.values(battleItems).sort((a, b) => a.cost - b.cost);
            
            // Render each battle item as a shop card
            sortedBattleItems.forEach(item => {
                const currentQuantity = gameState.battleInventory[item.id] || 0;
                const isLocked = item.levelRequired && gameState.jerryLevel < item.levelRequired;
                const isMaxed = item.maxQuantity && currentQuantity >= item.maxQuantity;
                const canAfford = (gameState.jerryXP || 0) >= item.cost;
                
                const card = document.createElement('div');
                card.className = 'shop-item-card';
                
                // Add locked or maxed styling
                if (isLocked) {
                    card.style.opacity = '0.5';
                    card.style.cursor = 'not-allowed';
                } else if (isMaxed) {
                    card.style.opacity = '0.7';
                }
                
                let buttonText = 'Buy Now';
                let buttonDisabled = '';
                
                if (isLocked) {
                    buttonText = `üîí Level ${item.levelRequired}`;
                    buttonDisabled = 'disabled style="opacity: 0.5; cursor: not-allowed;"';
                } else if (isMaxed) {
                    buttonText = '‚úÖ Maxed Out';
                    buttonDisabled = 'disabled style="opacity: 0.5; cursor: not-allowed;"';
                } else if (!canAfford) {
                    buttonText = 'Not Enough XP';
                    buttonDisabled = 'disabled style="opacity: 0.7;"';
                }
                
                const maxQuantityText = item.maxQuantity ? `<div style="font-size: 11px; color: #999; margin-top: 4px;">Max: ${item.maxQuantity}</div>` : '';
                
                card.innerHTML = `
                    <div class="shop-item-emoji">${item.emoji}</div>
                    <div class="shop-item-name">${item.name}</div>
                    <div class="shop-item-desc">${item.description}</div>
                    <div class="shop-item-quantity">Owned: ${currentQuantity}</div>
                    ${maxQuantityText}
                    <div class="shop-item-cost">${item.cost} XP</div>
                    <button class="shop-buy-btn" onclick="buyItem('${item.id}')" ${buttonDisabled}>${buttonText}</button>
                `;
                
                grid.appendChild(card);
            });
        }



        // Update settings display
        function updateSettingsDisplay() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const notificationsToggle = document.getElementById('notificationsToggle');
            const soundToggle = document.getElementById('soundToggle');
            const battleModeToggle = document.getElementById('battleModeToggle');
            
            if (darkModeToggle) {
                darkModeToggle.classList.toggle('active', gameState.darkMode);
            }
            
            if (notificationsToggle) {
                notificationsToggle.classList.toggle('active', gameState.notifications);
            }
            
            if (soundToggle && window.audioManager) {
                soundToggle.classList.toggle('active', window.audioManager.soundEnabled);
            }
            
            if (battleModeToggle) {
                battleModeToggle.classList.toggle('active', window.battleModeEnabled !== false);
            }
        }
        
        // Toggle sound effects
        function toggleSound() {
            if (window.audioManager) {
                const enabled = window.audioManager.toggleSound();
                const soundToggle = document.getElementById('soundToggle');
                if (soundToggle) {
                    soundToggle.classList.toggle('active', enabled);
                }
                
                // Play a test sound if enabling
                if (enabled) {
                    window.audioManager.playSound('taskComplete', 0.5);
                }
            }
        }

        // Daily Challenge System
        // Daily Challenge System - Simplified & Trackable
        // All challenges have clear, automatically verifiable acceptance criteria
        const DAILY_CHALLENGES = [
            // Basic Task Completion (Any Type - Regular or Quick Tasks)
            "Complete 1 task today (any type)",
            "Complete 2 tasks today (any type)",
            "Complete 3 tasks today (any type)",
            "Complete 4 tasks today (any type)",
            "Complete 5 tasks today (any type)",
            "Complete 6 tasks today (any type)",
            "Complete 7 tasks today (any type)",
            "Complete 8 tasks today (any type)",
            "Complete 10 tasks today (any type)",
            
            // Work Category (Regular Tasks Only)
            "Complete 1 work task (Work & Career category)",
            "Complete 2 work tasks (Work & Career category)",
            "Complete 3 work tasks (Work & Career category)",
            "Complete 4 work tasks (Work & Career category)",
            
            // Goals Category (Personal Goals)
            "Complete 1 goals task (Personal Goals category)",
            "Complete 2 goals tasks (Personal Goals category)",
            "Complete 3 goals tasks (Personal Goals category)",
            
            // Finance Category
            "Complete 1 finance task (Finance & Planning category)",
            "Complete 2 finance tasks (Finance & Planning category)",
            
            // Projects Category
            "Complete 1 projects task (Projects & Hobbies category)",
            "Complete 2 projects tasks (Projects & Hobbies category)",
            
            // Errands Category
            "Complete 1 errands task (Errands & Appointments category)",
            "Complete 2 errands tasks (Errands & Appointments category)",
            
            // Digital Category
            "Complete 1 digital task (Digital & Technology category)",
            "Complete 2 digital tasks (Digital & Technology category)",
            
            // Social Category
            "Complete 1 social task (Social & Relationships category)",
            "Complete 2 social tasks (Social & Relationships category)",
            
            // Home Category
            "Complete 1 home task (Home & Family category)",
            "Complete 2 home tasks (Home & Family category)",
            "Complete 3 home tasks (Home & Family category)",
            
            // Learning Category
            "Complete 1 learning task (Learning & Education category)",
            "Complete 2 learning tasks (Learning & Education category)",
            
            // Wellness Category
            "Complete 1 wellness task (Wellness category)",
            "Complete 2 wellness tasks (Wellness category)",
            
            // Creative Category
            "Complete 1 creative task (Creative & Arts category)",
            "Complete 2 creative tasks (Creative & Arts category)",
            
            // Quick Tasks (Only Quick Tasks Count)
            "Complete 1 quick task (quick tasks only)",
            "Complete 2 quick tasks (quick tasks only)",
            "Complete 3 quick tasks (quick tasks only)",
            "Complete 4 quick tasks (quick tasks only)",
            "Complete 5 quick tasks (quick tasks only)",
            "Complete 6 quick tasks (quick tasks only)",
            "Complete 8 quick tasks (quick tasks only)",
            "Complete 10 quick tasks (quick tasks only)",
            
            // Priority-Based (Regular Tasks Only)
            "Complete 1 high-priority task (high priority)",
            "Complete 2 high-priority tasks (high priority)",
            "Complete 3 high-priority tasks (high priority)",
            "Complete 1 low-priority task (low priority)",
            "Complete 2 low-priority tasks (low priority)",
            
            // Difficulty-Based (Regular Tasks Only)
            "Complete 1 easy task (easy difficulty)",
            "Complete 2 easy tasks (easy difficulty)",
            "Complete 3 easy tasks (easy difficulty)",
            "Complete 1 medium task (medium difficulty)",
            "Complete 2 medium tasks (medium difficulty)",
            "Complete 1 hard task (hard difficulty)",
            "Complete 2 hard tasks (hard difficulty)",
            
            // Mixed Combinations
            "Complete 1 work and 1 goals task",
            "Complete 1 work and 1 wellness task",
            "Complete 2 work and 1 wellness task",
            "Complete 1 learning and 1 home task",
            "Complete 1 hard and 1 easy task",
            "Complete 1 high-priority and 1 low-priority task",
            
            // XP-Based (tracks XP accumulation)
            "Earn 50 XP today",
            "Earn 75 XP today",
            "Earn 100 XP today",
            "Earn 150 XP today",
            "Earn 200 XP today",
            
            // Streak-Based (only single-day achievable)
            // Note: Multi-day streaks removed as they can't be completed in one day
            
            // Future Self Challenges (Learning, Wellness, Planning)
            "Finish a task that helps your future self",
            "Complete 1 learning or wellness task",
            "Complete 1 task for your future",
            
            // Rest Day
            "Take a break! No tasks required today‚Äîyou've earned it"
        ];

        const CARD_COLORS = [
            'var(--daily-card-purple)',
            'var(--daily-card-green)',
            'var(--daily-card-orange-gradient)',
            'var(--daily-card-pink)',
            'var(--daily-card-blue)',
            'var(--daily-card-teal)',
            'var(--daily-card-red)',
            'var(--daily-card-yellow)'
        ];

        // Parse the target number from challenge description
        function parseChallengeTarget(challengeDesc) {
            // Convert to lowercase for easier matching
            const desc = challengeDesc.toLowerCase();
            
            // Look for numeric patterns in the description
            // Patterns: "complete 3", "finish 2", "reach 5", "earn 50", "add 2", etc.
            const patterns = [
                /complete (\d+)/,
                /finish (\d+)/,
                /reach (\d+)/,
                /earn (\d+)/,
                /add (\d+)/,
                /do (\d+)/,
                /check off (\d+)/,
                /clear (\d+)/,
                /create (\d+)/,
                /hit (\d+)/,
                /(\d+)[- ]day/,  // for "2-day streak" or "3 day streak"
                /at least (\d+)/,
                /(\d+) tasks?/,
                /(\d+) quick/,
                /(\d+) work/,
                /(\d+) personal/,
                /(\d+) home/,
                /(\d+) learning/,
                /(\d+) wellness/,
                /(\d+) creative/,
                /(\d+) easy/,
                /(\d+) medium/,
                /(\d+) hard/,
                /(\d+) high-priority/,
                /(\d+) low-priority/,
                /(\d+) small/,
                /(\d+) high/,
                /(\d+) low/,
                /(\d+) new/
            ];
            
            // Try each pattern
            for (const pattern of patterns) {
                const match = desc.match(pattern);
                if (match && match[1]) {
                    const num = parseInt(match[1]);
                    // For XP challenges, the number is the XP amount, not the task count
                    // So we keep target as 1 for XP challenges
                    // Use word boundary to avoid matching 'learning' as 'earn'
                    if (desc.includes('xp') || /\bearn\b/.test(desc)) {
                        return 1;
                    }
                    return num;
                }
            }
            
            // Special cases
            if (desc.includes('all quick tasks') || desc.includes('every quick task')) {
                // This requires completing all selected quick tasks
                // We'll set a reasonable default, but the logic should check against actual count
                return 1;  // Will be handled specially in the progress tracking
            }
            
            if (desc.includes('all tasks') || desc.includes('every task') || desc.includes('everything')) {
                // Similar to above - requires all tasks to be completed
                return 1;  // Will be handled specially
            }
            
            // Default to 1 if no number found
            return 1;
        }

        function generateDailyChallenge() {
            const today = new Date().toDateString();
            
            // Initialize localStorage keys if they don't exist
            let challengeIndex = parseInt(localStorage.getItem('dailyChallengeIndex')) || 0;
            let lastDate = localStorage.getItem('dailyChallengeDate') || '';
            let usedChallenges = JSON.parse(localStorage.getItem('usedChallenges') || '[]');
            let cardColorIndex = parseInt(localStorage.getItem('dailyCardColorIndex')) || 0;
            
            // Check if it's a new day
            if (lastDate !== today) {
                // If all challenges have been used, reset the cycle
                if (usedChallenges.length >= DAILY_CHALLENGES.length) {
                    usedChallenges = [];
                }
                
                // Find next unused challenge
                let availableChallenges = [];
                for (let i = 0; i < DAILY_CHALLENGES.length; i++) {
                    if (!usedChallenges.includes(i)) {
                        availableChallenges.push(i);
                    }
                }
                
                // Pick random from available
                challengeIndex = availableChallenges[Math.floor(Math.random() * availableChallenges.length)];
                usedChallenges.push(challengeIndex);
                
                // Cycle to next color
                cardColorIndex = (cardColorIndex + 1) % CARD_COLORS.length;
                
                // Save to localStorage
                localStorage.setItem('dailyChallengeIndex', challengeIndex);
                localStorage.setItem('dailyChallengeDate', today);
                localStorage.setItem('usedChallenges', JSON.stringify(usedChallenges));
                localStorage.setItem('dailyCardColorIndex', cardColorIndex);
                
                // Update game state
                const challengeDesc = DAILY_CHALLENGES[challengeIndex];
                gameState.dailyChallenge = {
                    id: 'daily_' + challengeIndex,
                    name: 'Daily Challenge',
                    desc: challengeDesc,
                    target: parseChallengeTarget(challengeDesc),
                    progress: 0,
                    reward: 50,
                    color: CARD_COLORS[cardColorIndex]
                };
                gameState.dailyChallengeCompleted = false;
                gameState.lastDailyChallengeDate = today;
                
                // Save gameState to persist color change
                saveGameState();
                console.log('üé® New daily challenge generated with color:', CARD_COLORS[cardColorIndex]);
            } else if (!gameState.dailyChallenge || !gameState.dailyChallenge.color) {
                // Load existing challenge from localStorage or fix missing color
                const challengeDesc = DAILY_CHALLENGES[challengeIndex];
                const existingProgress = gameState.dailyChallenge?.progress || 0;
                gameState.dailyChallenge = {
                    id: 'daily_' + challengeIndex,
                    name: 'Daily Challenge',
                    desc: challengeDesc,
                    target: parseChallengeTarget(challengeDesc),
                    progress: existingProgress,
                    reward: 50,
                    color: CARD_COLORS[cardColorIndex]
                };
            }
        }

        function updateDailyChallengeDisplay() {
            const challengeDisplay = document.getElementById('dailyChallengeDisplay');
            if (!challengeDisplay) return;

            // Show empty state if challenge is completed
            if (gameState.dailyChallengeCompleted) {
                challengeDisplay.innerHTML = `
                    <div class="challenge-empty-state">
                        <div class="challenge-empty-icon">üéâ</div>
                        <div class="challenge-empty-title">Great job! You've completed today's challenge.</div>
                        <div class="challenge-empty-desc">Come back tomorrow for a new one!</div>
                    </div>
                `;
                return;
            }

            if (!gameState.dailyChallenge) {
                challengeDisplay.innerHTML = `
                    <div class="daily-challenge-card">
                        <div class="challenge-title">üìÖ No Challenge Today</div>
                        <div class="challenge-desc">Check back tomorrow for a new challenge!</div>
                        <div class="challenge-progress-container">
                            <div class="challenge-progress-label">Progress: 0/0</div>
                            <div class="challenge-progress-bar">
                                <div class="challenge-progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="challenge-reward">üéÅ Reward: 0 points</div>
                    </div>
                `;
                return;
            }

            const challenge = gameState.dailyChallenge;
            const progressPercent = Math.min(100, (challenge.progress / challenge.target) * 100);
            const cardColor = challenge.color || 'var(--daily-card-purple)';

            challengeDisplay.innerHTML = `
                <div class="daily-challenge-card" style="background: ${cardColor};">
                    <div class="challenge-title">üìÖ ${challenge.name}</div>
                    <div class="challenge-desc">${challenge.desc}</div>
                    <div class="challenge-progress-container">
                        <div class="challenge-progress-label">Progress: ${challenge.progress}/${challenge.target}</div>
                        <div class="challenge-progress-bar">
                            <div class="challenge-progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                    <div class="challenge-reward">üéÅ Reward: ${challenge.reward} points</div>
                </div>
            `;
        }

        // Stats expansion toggle
        function toggleStatsExpansion() {
            const collapsed = document.getElementById('statsCollapsed');
            const expanded = document.getElementById('statsExpanded');
            const toggle = document.getElementById('statsToggle');
            
            if (expanded.style.display === 'none') {
                // Show expanded view
                collapsed.style.display = 'none';
                expanded.style.display = 'grid';
                toggle.textContent = '‚ñº';
                toggle.classList.add('expanded');
            } else {
                // Show collapsed view
                collapsed.style.display = 'grid';
                expanded.style.display = 'none';
                toggle.textContent = '‚ñº';
                toggle.classList.remove('expanded');
            }
        }

        // Daily Challenge expansion toggle
        function toggleDailyChallengeExpansion() {
            const content = document.getElementById('dailyChallengeContent');
            const toggle = document.getElementById('dailyChallengeToggle');
            
            if (content.style.display === 'none') {
                // Show content
                content.style.display = 'block';
                toggle.textContent = '‚ñº';
                toggle.classList.add('expanded');
            } else {
                // Hide content
                content.style.display = 'none';
                toggle.textContent = '‚ñº';
                toggle.classList.remove('expanded');
            }
        }

        // Focus Timer System
        let focusTimerInterval = null;
        let focusRemaining = 0;
        let focusActive = false;
        let focusPaused = false;
        let focusStartTime = 0;
        let focusXPAwarded = 0;
        
        // Helper function to safely set animation based on skin type
        function setSpriteAnimation(spriteElement, animationType, frameCount, skin) {
            if (!spriteElement) return;
            
            // Check if this is a GIF-based skin
            if (skin && skin.seamlessImage) {
                // GIF animation - no CSS animation needed
                spriteElement.style.animation = 'none';
                return;
            }
            
            // Sprite sheet animation
            const animationMap = {
                'idle': 'none',
                'walk': 'none',
                'jump': 'none',
                'attack': 'none',
                'hurt': 'none',
                'death': 'none'
            };
            
            spriteElement.style.animation = animationMap[animationType] || 'none';
        }

        function toggleFocusTimerExpansion() {
            if (focusActive) return; // Cannot collapse while active
            
            const content = document.getElementById('focusTimerContent');
            const toggle = document.getElementById('focusTimerToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñº';
                toggle.classList.add('expanded');
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñº';
                toggle.classList.remove('expanded');
            }
        }

        function toggleYourTasksExpansion(event) {
            if (event && event.target.tagName === 'BUTTON') return; // Don't toggle if clicking the Add button
            
            const content = document.getElementById('tasksList');
            const toggle = document.getElementById('yourTasksToggleIcon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñ≤'; // Up arrow when expanded
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñº'; // Down arrow when collapsed
            }
        }

        function toggleQuickTasksExpansion(event) {
            if (event && event.target.tagName === 'BUTTON') return; // Don't toggle if clicking the Add button
            
            const content = document.getElementById('quickTasksList');
            const toggle = document.getElementById('quickTasksToggleIcon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñ≤'; // Up arrow when expanded
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñº'; // Down arrow when collapsed
            }
        }

        function toggleFocusTimerInfo() {
            const infoBox = document.getElementById('focusTimerInfoBox');
            const showBtn = document.getElementById('showFocusInfo');
            
            if (infoBox.style.display === 'none') {
                infoBox.style.display = 'block';
                showBtn.style.display = 'none';
                // Save preference
                localStorage.setItem('focusTimerInfoVisible', 'true');
            } else {
                infoBox.style.display = 'none';
                showBtn.style.display = 'block';
                // Save preference
                localStorage.setItem('focusTimerInfoVisible', 'false');
            }
        }

        function updateFocusDisplay() {
            const display = document.getElementById('focusTimerDisplay');
            if (!display) return;
            
            const mins = Math.floor(focusRemaining / 60);
            const secs = focusRemaining % 60;
            display.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;

            // Flash red during final 2 minutes
            if (focusRemaining <= 120 && focusRemaining > 0) {
                display.style.color = (focusRemaining % 2 === 0) ? '#FF4C4C' : 'var(--text-primary)';
            } else {
                display.style.color = 'var(--text-primary)';
            }
        }

        let focusAnimationInterval = null;
        let focusAnimationState = 'walk';

        function toggleMonsterAnimation(state) {
            const focusTimerMonsterSprite = document.getElementById('focusTimerMonsterSprite');
            const focusTimerMonsterContainer = document.getElementById('focusTimerMonsterContainer');
            if (!focusTimerMonsterSprite || !focusTimerMonsterContainer) return;
            
            // Get the wrapper div (parent of the sprite)
            const spriteWrapper = focusTimerMonsterSprite.parentElement;
            
            // Check if monster is in egg form
            const selectedMonster = localStorage.getItem('selectedMonster');
            console.log('[Focus Timer] selectedMonster from localStorage:', selectedMonster);
            console.log('[Focus Timer] gameState.isEgg:', gameState.isEgg);
            
            if (gameState.isEgg && selectedMonster) {
                // Show egg in focus timer
                if (state === 'active') {
                    const eggPath = `assets/eggs/${selectedMonster}_egg.gif`;
                    console.log('[Focus Timer] Loading egg:', eggPath);
                    focusTimerMonsterContainer.style.display = 'flex';
                    
                    // Apply egg wrapper styling
                    if (spriteWrapper) {
                        spriteWrapper.classList.add('egg-sprite-wrapper');
                    }
                    
                    focusTimerMonsterSprite.src = eggPath;
                    focusTimerMonsterSprite.classList.add('egg-sprite');
                    // CRITICAL: Use CSS class for consistent egg sizing
                    focusTimerMonsterSprite.style.animation = '';
                    focusTimerMonsterSprite.style.objectFit = '';
                    focusTimerMonsterSprite.style.objectPosition = '';
                    focusTimerMonsterSprite.style.width = '';
                    focusTimerMonsterSprite.style.height = '';
                    focusTimerMonsterSprite.style.transform = '';
                } else {
                    focusTimerMonsterContainer.style.display = 'none';
                    if (spriteWrapper) {
                        spriteWrapper.classList.remove('egg-sprite-wrapper');
                    }
                }
                return; // Exit early for eggs
            }
            
            // Remove egg-sprite class if not an egg
            focusTimerMonsterSprite.classList.remove('egg-sprite');
            if (spriteWrapper) {
                spriteWrapper.classList.remove('egg-sprite-wrapper');
            }
            
            // Use equipped skin if available, otherwise use default monster
            const equippedSkinId = window.gameState.equippedSkinId || null;
            const baseMonster = localStorage.getItem('selectedMonster') || 'nova';
            const appearance = window.getActiveMonsterAppearance ? window.getActiveMonsterAppearance(baseMonster, equippedSkinId) : null;
            const spritePrefix = localStorage.getItem('heroSpritePrefix') || 'Pink_Monster';
            console.log('[Focus Timer] Not an egg, loading monster sprite. spritePrefix:', spritePrefix);

            if (state === 'active') {
                // Show the monster container
                focusTimerMonsterContainer.style.display = 'flex';
                
                // For Shadow Monsters, use ONLY walk animation during focus
                // For Cat skins, use ONLY idle animation to prevent errors
                // For other skins, cycle through walk, jump, idle
                const isShadowMonster = appearance && appearance.isSkin && 
                    (appearance.skinId === 'shadow_mage' || appearance.skinId === 'shadow_morph' || appearance.skinId === 'shadow_sword');
                
                // Check if current skin is a cat skin or GIF-based skin
                const isCatSkin = appearance && appearance.isSkin && 
                    (appearance.skinId === 'black_cat' || appearance.skinId === 'white_cat' || 
                     appearance.skinId === 'brown_cat' || appearance.skinId === 'baby_blue_cat' || 
                     appearance.skinId === 'rainbow_cat' || appearance.skinId === 'demonic_cat');
                
                const currentSkin = appearance && appearance.isSkin && appearance.skinId ? 
                    window.SKINS_CONFIG[appearance.skinId] : null;
                
                if (appearance && appearance.isSkin) {
                    // Cat skins and GIF skins use ONLY idle animation
                    if (isCatSkin || (currentSkin && currentSkin.seamlessImage)) {
                        focusTimerMonsterSprite.src = appearance.animations.idle;
                        const frameCount = appearance.frameCount.idle;
                        setSpriteAnimation(focusTimerMonsterSprite, 'idle', frameCount, currentSkin);
                        focusAnimationState = 'idle';
                    } else {
                        focusTimerMonsterSprite.src = appearance.animations.walk || appearance.animations.idle;
                        const frameCount = appearance.frameCount.walk || appearance.frameCount.idle;
                        setSpriteAnimation(focusTimerMonsterSprite, 'walk', frameCount, currentSkin);
                        focusAnimationState = 'walk';
                    }
                } else {
                    // Use GIF animation for default monsters
                    const monsterName = baseMonster.charAt(0).toUpperCase() + baseMonster.slice(1);
                    focusTimerMonsterSprite.src = `assets/heroes/${monsterName}_idle.gif`;
                    // Clear spritesheet animation styles
                    focusTimerMonsterSprite.style.animation = '';
                    focusTimerMonsterSprite.style.objectFit = 'contain';
                    focusTimerMonsterSprite.style.objectPosition = 'center';
                    focusTimerMonsterSprite.style.width = '64px';
                    focusTimerMonsterSprite.style.height = '64px';
                    focusAnimationState = 'idle';
                }
                
                // Clear any existing animation switching loop
                if (focusAnimationInterval) {
                    clearInterval(focusAnimationInterval);
                }
                
                // Only cycle animations for non-Shadow Monster, non-Cat, and non-GIF skins
                const isGIFSkin = currentSkin && currentSkin.seamlessImage;
                if (!isShadowMonster && !isCatSkin && !isGIFSkin) {
                    // Cycle through walk, jump, and idle animations
                    focusAnimationInterval = setInterval(() => {
                        if (!focusActive) return;
                        
                        if (focusAnimationState === 'walk') {
                            // Switch to jump
                            if (appearance && appearance.isSkin) {
                                focusTimerMonsterSprite.src = appearance.animations.jump || appearance.animations.idle;
                                const frameCount = appearance.frameCount.jump || appearance.frameCount.idle;
                                setSpriteAnimation(focusTimerMonsterSprite, 'jump', frameCount, currentSkin);
                             } else {
                                const monsterName = baseMonster.charAt(0).toUpperCase() + baseMonster.slice(1);
                                focusTimerMonsterSprite.src = `assets/heroes/${monsterName}_jump.gif`;
                                focusTimerMonsterSprite.style.animation = '';
                                focusTimerMonsterSprite.style.objectFit = 'contain';
                                focusTimerMonsterSprite.style.objectPosition = 'center';
                                focusTimerMonsterSprite.style.width = '64px';
                                focusTimerMonsterSprite.style.height = '64px';
                            }
                            focusAnimationState = 'jump';
                        } else if (focusAnimationState === 'jump') {
                            // Switch to idle
                            if (appearance && appearance.isSkin) {
                                focusTimerMonsterSprite.src = appearance.animations.idle;
                                const frameCount = appearance.frameCount.idle;
                                setSpriteAnimation(focusTimerMonsterSprite, 'idle', frameCount, currentSkin);
                            } else {
                                const monsterName = baseMonster.charAt(0).toUpperCase() + baseMonster.slice(1);
                                focusTimerMonsterSprite.src = `assets/heroes/${monsterName}_idle.gif`;
                                focusTimerMonsterSprite.style.animation = '';
                                focusTimerMonsterSprite.style.objectFit = 'contain';
                                focusTimerMonsterSprite.style.objectPosition = 'center';
                                focusTimerMonsterSprite.style.width = '64px';
                                focusTimerMonsterSprite.style.height = '64px';
                            }
                            focusAnimationState = 'idle';
                        } else {
                            // Switch back to walk
                            if (appearance && appearance.isSkin) {
                                focusTimerMonsterSprite.src = appearance.animations.walk || appearance.animations.idle;
                                const frameCount = appearance.frameCount.walk || appearance.frameCount.idle;
                                setSpriteAnimation(focusTimerMonsterSprite, 'walk', frameCount, currentSkin);
                            } else {
                                const monsterName = baseMonster.charAt(0).toUpperCase() + baseMonster.slice(1);
                                focusTimerMonsterSprite.src = `assets/heroes/${monsterName}_attack.gif`;
                                focusTimerMonsterSprite.style.animation = '';
                                focusTimerMonsterSprite.style.objectFit = 'contain';
                                focusTimerMonsterSprite.style.objectPosition = 'center';
                                focusTimerMonsterSprite.style.width = '64px';
                                focusTimerMonsterSprite.style.height = '64px';
                            }
                            focusAnimationState = 'walk';
                        }
                    }, 2000); // Change animation every 2 seconds
                }
                // Shadow Monsters stay in walk animation continuously
            } else {
                // Stop animation loop
                if (focusAnimationInterval) {
                    clearInterval(focusAnimationInterval);
                    focusAnimationInterval = null;
                }
                
                // Return to idle animation
                const currentSkin = appearance && appearance.isSkin && appearance.skinId ? 
                    window.SKINS_CONFIG[appearance.skinId] : null;
                    
                if (appearance && appearance.isSkin) {
                    focusTimerMonsterSprite.src = appearance.animations.idle;
                    const frameCount = appearance.frameCount.idle;
                    setSpriteAnimation(focusTimerMonsterSprite, 'idle', frameCount, currentSkin);
                } else {
                    const monsterName = baseMonster.charAt(0).toUpperCase() + baseMonster.slice(1);
                    focusTimerMonsterSprite.src = `assets/heroes/${monsterName}_idle.gif`;
                    focusTimerMonsterSprite.style.animation = '';
                    focusTimerMonsterSprite.style.objectFit = 'contain';
                    focusTimerMonsterSprite.style.objectPosition = 'center';
                    focusTimerMonsterSprite.style.width = '64px';
                    focusTimerMonsterSprite.style.height = '64px';
                }
                
                // Hide the monster container
                focusTimerMonsterContainer.style.display = 'none';
            }
        }

        function showXPGainAnimation() {
            const focusTimerMonsterContainer = document.getElementById('focusTimerMonsterContainer');
            if (!focusTimerMonsterContainer) return;
            
            // Create XP text element
            const xpText = document.createElement('div');
            xpText.textContent = '+1 XP';
            xpText.style.position = 'absolute';
            xpText.style.left = '50%';
            xpText.style.top = '-10px';
            xpText.style.transform = 'translateX(-50%)';
            xpText.style.fontSize = '20px';
            xpText.style.fontWeight = 'bold';
            xpText.style.color = '#34d399';
            xpText.style.textShadow = '0 0 10px rgba(52, 211, 153, 0.8), 0 0 20px rgba(52, 211, 153, 0.5), 0 2px 4px rgba(0, 0, 0, 0.5)';
            xpText.style.pointerEvents = 'none';
            xpText.style.zIndex = '1000';
            xpText.style.animation = 'xpFloat 2s ease-out forwards';
            
            // Add to focus timer monster container
            focusTimerMonsterContainer.appendChild(xpText);
            
            // Remove after animation completes
            setTimeout(() => {
                if (xpText.parentElement) {
                    xpText.parentElement.removeChild(xpText);
                }
            }, 2000);
        }
        
        function showFocusHPAnimation(hpAmount) {
            const focusTimerMonsterContainer = document.getElementById('focusTimerMonsterContainer');
            if (!focusTimerMonsterContainer) return;
            
            // Create HP text element
            const hpText = document.createElement('div');
            hpText.textContent = `+${hpAmount} HP`;
            hpText.style.position = 'absolute';
            hpText.style.left = '50%';
            hpText.style.top = '-10px';
            hpText.style.transform = 'translateX(-50%)';
            hpText.style.fontSize = '20px';
            hpText.style.fontWeight = 'bold';
            hpText.style.color = '#ff6b6b';
            hpText.style.textShadow = '0 0 10px rgba(255, 107, 107, 0.8), 0 0 20px rgba(255, 107, 107, 0.5), 0 2px 4px rgba(0, 0, 0, 0.5)';
            hpText.style.pointerEvents = 'none';
            hpText.style.zIndex = '1000';
            hpText.style.animation = 'xpFloat 2s ease-out forwards';
            
            // Add to focus timer monster container
            focusTimerMonsterContainer.appendChild(hpText);
            
            // Remove after animation completes
            setTimeout(() => {
                if (hpText.parentElement) {
                    hpText.parentElement.removeChild(hpText);
                }
            }, 2000);
        }

        function startFocusTimer() {
            if (focusActive && !focusPaused) return;
            
            // Stop any existing alarm from previous session
            if (window.audioManager) {
                window.audioManager.stopFocusAlarm();
            }
            
            const durationInput = document.getElementById('focusDuration');
            const minutes = parseInt(durationInput.value, 10);
            
            if (isNaN(minutes) || minutes < 1 || minutes > 180) {
                showSuccessMessage('‚è±Ô∏è Please enter a valid duration (1-180 minutes)');
                return;
            }
            
            focusActive = true;
            focusPaused = false;
            focusRemaining = minutes * 60;
            focusStartTime = Date.now();
            focusXPAwarded = 0;
            
            // Update button visibility
            const startBtn = document.getElementById('startFocusTimer');
            const pauseBtn = document.getElementById('pauseFocusTimer');
            if (startBtn) startBtn.style.display = 'none';
            if (pauseBtn) pauseBtn.style.display = 'block';
            
            // Expand card and lock it
            const content = document.getElementById('focusTimerContent');
            const toggle = document.getElementById('focusTimerToggle');
            content.style.display = 'block';
            toggle.textContent = '‚ñº';
            toggle.classList.add('expanded');
            
            // Start monster animation
            toggleMonsterAnimation('active');
            
            // Update display immediately
            updateFocusDisplay();
            
            // Start countdown
            focusTimerInterval = setInterval(() => {
                focusRemaining--;
                updateFocusDisplay();

                // Award 1 XP per minute
                const minutesElapsed = Math.floor((Date.now() - focusStartTime) / 60000);
                if (minutesElapsed > focusXPAwarded) {
                    focusXPAwarded = minutesElapsed;
                    addJerryXP(1);
                    // Track total focus minutes
                    if (!gameState.totalFocusMinutes) gameState.totalFocusMinutes = 0;
                    gameState.totalFocusMinutes++;
                    saveGameState();
                    showXPGainAnimation();
                    console.log(`‚è±Ô∏è Focus Timer: +1 XP awarded (${focusXPAwarded} minutes elapsed, total: ${gameState.totalFocusMinutes})`);
                }

                if (focusRemaining <= 0) {
                    stopFocusTimer(true);
                }
            }, 1000);
            
            showSuccessMessage('‚è±Ô∏è Focus Timer Started!', `${minutes} minute${minutes > 1 ? 's' : ''} - Stay focused!`);
        }
        
        function pauseFocusTimer() {
            if (!focusActive || focusPaused) return;
            
            // Pause the timer
            clearInterval(focusTimerInterval);
            focusPaused = true;
            
            // Pause monster animation
            toggleMonsterAnimation('inactive');
            
            // Update button visibility and text
            const startBtn = document.getElementById('startFocusTimer');
            const pauseBtn = document.getElementById('pauseFocusTimer');
            if (startBtn) {
                startBtn.style.display = 'block';
                startBtn.textContent = 'Resume';
            }
            if (pauseBtn) pauseBtn.style.display = 'none';
            
            showSuccessMessage('‚è±Ô∏è Focus Timer Paused');
        }
        
        function resumeFocusTimer() {
            if (!focusActive || !focusPaused) return;
            
            focusPaused = false;
            
            // Update button visibility and text
            const startBtn = document.getElementById('startFocusTimer');
            const pauseBtn = document.getElementById('pauseFocusTimer');
            if (startBtn) {
                startBtn.style.display = 'none';
                startBtn.textContent = 'Start';
            }
            if (pauseBtn) pauseBtn.style.display = 'block';
            
            // Resume monster animation
            toggleMonsterAnimation('active');
            
            // Adjust start time to account for paused duration
            const elapsedMinutes = focusXPAwarded;
            focusStartTime = Date.now() - (elapsedMinutes * 60000);
            
            // Resume countdown
            focusTimerInterval = setInterval(() => {
                focusRemaining--;
                updateFocusDisplay();

                // Award 1 XP per minute
                const minutesElapsed = Math.floor((Date.now() - focusStartTime) / 60000);
                if (minutesElapsed > focusXPAwarded) {
                    focusXPAwarded = minutesElapsed;
                    addJerryXP(1);
                    // Track total focus minutes
                    if (!gameState.totalFocusMinutes) gameState.totalFocusMinutes = 0;
                    gameState.totalFocusMinutes++;
                    saveGameState();
                    showXPGainAnimation();
                    console.log(`‚è±Ô∏è Focus Timer: +1 XP awarded (${focusXPAwarded} minutes elapsed, total: ${gameState.totalFocusMinutes})`);
                }

                if (focusRemaining <= 0) {
                    stopFocusTimer(true);
                }
            }, 1000);
            
            showSuccessMessage('‚è±Ô∏è Focus Timer Resumed');
        }

        function stopFocusTimer(completed = false) {
            clearInterval(focusTimerInterval);
            focusActive = false;
            focusPaused = false;
            focusRemaining = 0;
            
            // Stop monster animation using the toggleMonsterAnimation function
            toggleMonsterAnimation('inactive');
            
            // Clear any animation intervals
            if (focusAnimationInterval) {
                clearInterval(focusAnimationInterval);
                focusAnimationInterval = null;
            }
            
            // Reset display
            const durationInput = document.getElementById('focusDuration');
            const minutes = parseInt(durationInput.value, 10) || 25;
            const display = document.getElementById('focusTimerDisplay');
            display.textContent = `${String(minutes).padStart(2, '0')}:00`;
            display.style.color = 'var(--text-primary)';
            
            // Reset button visibility and text
            const startBtn = document.getElementById('startFocusTimer');
            const pauseBtn = document.getElementById('pauseFocusTimer');
            if (startBtn) {
                startBtn.style.display = 'block';
                startBtn.textContent = 'Start';
            }
            if (pauseBtn) pauseBtn.style.display = 'none';
            
            if (completed) {
                // Start looping alarm when timer completes
                if (window.audioManager) {
                    window.audioManager.playFocusAlarm();
                }
                
                showSuccessMessage('üéâ Focus Session Complete!', `Great work! You earned ${focusXPAwarded} XP!`);
                
                // Track focus timer achievement (25 minutes or more)
                if (focusXPAwarded >= 25) {
                    if (!gameState.achievementProgress) {
                        gameState.achievementProgress = {};
                    }
                    gameState.achievementProgress.focusTimer25Min = true;
                    
                    // Check achievements
                    if (window.achievementTracker) {
                        window.achievementTracker.checkAchievements();
                    }
                }
            } else {
                // Stop alarm if user manually stops timer
                if (window.audioManager) {
                    window.audioManager.stopFocusAlarm();
                }
                showSuccessMessage('‚è±Ô∏è Focus Timer Stopped');
            }
        }

        // Initialize Focus Timer buttons
        document.addEventListener('DOMContentLoaded', () => {
            const startBtn = document.getElementById('startFocusTimer');
            const pauseBtn = document.getElementById('pauseFocusTimer');
            const stopBtn = document.getElementById('stopFocusTimer');
            const durationInput = document.getElementById('focusDuration');
            
            if (startBtn) {
                startBtn.addEventListener('click', () => {
                    if (focusPaused) {
                        resumeFocusTimer();
                    } else {
                        startFocusTimer();
                    }
                });
            }
            
            if (pauseBtn) {
                pauseBtn.addEventListener('click', pauseFocusTimer);
            }
            
            if (stopBtn) {
                stopBtn.addEventListener('click', () => stopFocusTimer(false));
            }
            
            // Restore focus timer info visibility preference
            const focusInfoVisible = localStorage.getItem('focusTimerInfoVisible');
            const infoBox = document.getElementById('focusTimerInfoBox');
            const showBtn = document.getElementById('showFocusInfo');
            
            // If user has explicitly set it to visible, show it
            if (focusInfoVisible === 'true' && infoBox && showBtn) {
                infoBox.style.display = 'block';
                showBtn.style.display = 'none';
            }
            // Otherwise keep default hidden state (no action needed)
            
            // Update display when duration changes
            if (durationInput) {
                durationInput.addEventListener('input', () => {
                    if (!focusActive) {
                        const minutes = parseInt(durationInput.value, 10) || 25;
                        const display = document.getElementById('focusTimerDisplay');
                        if (display) {
                            display.textContent = `${String(minutes).padStart(2, '0')}:00`;
                        }
                    }
                });
            }
            
            // Auto-stop focus timer when app is closed/hidden, resume when reopened
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // App is being closed/hidden - pause the timer if active
                    if (focusActive && !focusPaused) {
                        console.log('‚è±Ô∏è Focus Timer: App hidden - pausing timer');
                        pauseFocusTimer();
                        // Mark that we auto-paused so we can auto-resume
                        window.focusTimerAutoPaused = true;
                    }
                } else {
                    // App is being reopened - resume if we auto-paused
                    if (focusActive && focusPaused && window.focusTimerAutoPaused) {
                        console.log('‚è±Ô∏è Focus Timer: App visible - resuming timer');
                        resumeFocusTimer();
                        window.focusTimerAutoPaused = false;
                    }
                }
            });
        });

        // Tab switching
        function switchToTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active state from all tabs
            document.querySelectorAll('.pill-tab').forEach(tab => {
                tab.setAttribute('aria-selected', 'false');
            });
            
            // Show selected tab content
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Set active state on clicked tab
            event.target.setAttribute('aria-selected', 'true');
            
            // Update achievements display when switching to achievements tab
            if (tabName === 'achievements') {
                updateAchievementsDisplay();
            }
            
            // Update habits display when switching to habits tab
            if (tabName === 'habits') {
                if (window.updateHabitsDisplay) {
                    window.updateHabitsDisplay();
                }
            }
            
            // Initialize mood tracker when switching to mood tab
            if (tabName === 'mood') {
                if (window.initMoodFilters) {
                    window.initMoodFilters();
                }
            }
        }

        // Toggle habit section collapse/expand
        function toggleHabitSection(sectionName) {
            const contentId = sectionName === 'taskCategories' ? 'habitCategoriesChart' : 'habitQuickTaskChart';
            const toggleId = sectionName + 'Toggle';
            const content = document.getElementById(contentId);
            const toggle = document.getElementById(toggleId);
            
            if (content && toggle) {
                const isCollapsed = content.style.display === 'none';
                content.style.display = isCollapsed ? 'block' : 'none';
                // ‚ñ≤ = expanded (pointing up), ‚ñº = collapsed (pointing down)
                toggle.textContent = isCollapsed ? '‚ñ≤' : '‚ñº';
                
                // Save state to localStorage
                const collapsedSections = JSON.parse(localStorage.getItem('habitCollapsedSections') || '{}');
                collapsedSections[sectionName] = !isCollapsed;
                localStorage.setItem('habitCollapsedSections', JSON.stringify(collapsedSections));
            }
        }
        
        // Restore collapsed state for habit sections
        function restoreHabitSectionStates() {
            const collapsedSections = JSON.parse(localStorage.getItem('habitCollapsedSections') || '{}');
            
            if (collapsedSections.taskCategories) {
                const content = document.getElementById('habitCategoriesChart');
                const toggle = document.getElementById('taskCategoriesToggle');
                if (content && toggle) {
                    content.style.display = 'none';
                    toggle.textContent = '‚ñº'; // Down arrow when collapsed
                }
            }
            
            if (collapsedSections.quickTaskCategories) {
                const content = document.getElementById('habitQuickTaskChart');
                const toggle = document.getElementById('quickTaskCategoriesToggle');
                if (content && toggle) {
                    content.style.display = 'none';
                    toggle.textContent = '‚ñº'; // Down arrow when collapsed
                }
            }
        }

        // Shop sub-tab switching
        function switchShopSubTab(subTabName) {
            // Hide all shop sub-tab contents
            document.querySelectorAll('.shop-sub-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active state from all shop sub-tabs
            document.querySelectorAll('.pill-tab-shop').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected sub-tab content
            const targetContent = document.getElementById(subTabName + 'SubTabContent');
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // Set active state on clicked sub-tab
            event.target.classList.add('active');
            
            // Update content based on sub-tab
            if (subTabName === 'shop') {
                updateShopDisplay();
            } else if (subTabName === 'owned') {
                updateOwnedItemsDisplay();
            } else if (subTabName === 'skins') {
                updateSkinsDisplay();
            } else if (subTabName === 'themes') {
                updateThemesDisplay();
            }
        }
        
        // Update skins display
        function updateSkinsDisplay() {
            // Update XP display
            const xpCoinsSkins = document.getElementById('xpCoinsSkins');
            if (xpCoinsSkins) {
                xpCoinsSkins.textContent = gameState.jerryXP || 0;
            }
            
            // Render skins shop (inventory section removed)
            if (window.skinsManager) {
                window.skinsManager.renderSkinsShop();
            }
        }
        
        // Update themes display
        function updateThemesDisplay() {
            console.log('updateThemesDisplay called, jerryXP:', gameState.jerryXP);
            
            // Update XP Coins display
            const xpCoinsDisplay = document.getElementById('xpCoinsThemes');
            if (xpCoinsDisplay) {
                xpCoinsDisplay.textContent = gameState.jerryXP || 0;
                console.log('Set xpCoinsThemes to:', gameState.jerryXP);
            }
            
            // Define available themes
            const themes = [
                {
                    id: 'dark_castle',
                    name: 'Dark Castle',
                    emoji: 'üè∞',
                    description: 'Mysterious old castle interior',
                    cost: 900,
                    background: 'assets/backgrounds/castle-dark.png'
                },
                {
                    id: 'night_city',
                    name: 'Night City',
                    emoji: 'üåÉ',
                    description: 'Futuristic cityscape at night',
                    cost: 900,
                    background: 'assets/backgrounds/city-night.png'
                },
                {
                    id: 'ocean_depths',
                    name: 'Ocean Depths',
                    emoji: 'üåä',
                    description: 'Deep underwater scene',
                    cost: 900,
                    background: 'assets/backgrounds/ocean-deep.png'
                },
                {
                    id: 'mystic_temple',
                    name: 'Mystic Temple',
                    emoji: '‚õ©Ô∏è',
                    description: 'Ancient temple ruins',
                    cost: 900,
                    background: 'assets/backgrounds/temple-ruins.png'
                },
                {
                    id: 'cyber_grid',
                    name: 'Cyber Grid',
                    emoji: 'üîÆ',
                    description: 'Digital cyberspace grid',
                    cost: 900,
                    background: 'assets/backgrounds/cyber-grid.png'
                },
                {
                    id: 'synth_city',
                    name: 'Synth City',
                    emoji: 'üåÜ',
                    description: 'Retro synthwave cityscape',
                    cost: 900,
                    background: 'assets/backgrounds/themes/synth-city.png'
                },
                {
                    id: 'space',
                    name: 'Space',
                    emoji: 'üåå',
                    description: 'Cosmic space vista',
                    cost: 900,
                    background: 'assets/backgrounds/themes/space.png'
                },
                {
                    id: 'vampire_castle',
                    name: 'Vampire Castle',
                    emoji: 'üßõ',
                    description: 'Dark vampire castle at night',
                    cost: 400,
                    background: 'assets/backgrounds/themes/vampire-castle.png'
                },
                {
                    id: 'fort_of_illusion',
                    name: 'Fort of Illusion',
                    emoji: 'üèØ',
                    description: 'Mystical fortress of illusions',
                    cost: 500,
                    background: 'assets/backgrounds/themes/fort-of-illusion.png'
                },
                {
                    id: 'vamp_castle_bg',
                    name: 'Vampire Castle Night',
                    emoji: 'ü¶á',
                    description: 'Gothic castle under moonlight',
                    cost: 700,
                    background: 'assets/backgrounds/themes/vamp-castle-bg.png'
                },
                {
                    id: 'neon_city_sunset',
                    name: 'Neon City Sunset',
                    emoji: 'üåá',
                    description: 'Cyberpunk cityscape at dusk',
                    cost: 800,
                    background: 'assets/backgrounds/themes/neon-city-sunset.png'
                },
                {
                    id: 'bright_town',
                    name: 'Bright Town',
                    emoji: 'üèòÔ∏è',
                    description: 'Colorful medieval town with orange roofs',
                    cost: 1000,
                    background: 'assets/backgrounds/themes/bright-town.png'
                },
                {
                    id: 'stone_ruins',
                    name: 'Stone Ruins',
                    emoji: 'üèõÔ∏è',
                    description: 'Purple ruins with ancient castle',
                    cost: 1200,
                    background: 'assets/backgrounds/themes/stone-ruins.png'
                },
                {
                    id: 'skull_gates',
                    name: 'Skull Gates',
                    emoji: 'üíÄ',
                    description: 'Haunted dungeon entrance with skull gateway',
                    cost: 1500,
                    levelRequired: 1,
                    background: 'assets/backgrounds/themes/skull-gates.png'
                },
                {
                    id: 'dark_gothic_castle',
                    name: 'Dark Gothic Castle',
                    emoji: 'üè∞',
                    description: 'Majestic dark castle silhouette at dusk',
                    cost: 2000,
                    levelRequired: 1,
                    background: 'assets/backgrounds/themes/dark-gothic-castle.png'
                }
            ];
            
            // Sort themes by cost (lowest to highest)
            themes.sort((a, b) => a.cost - b.cost);
            
            // Render themes
            const grid = document.getElementById('themesGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            themes.forEach(theme => {
                const isOwned = gameState.ownedThemes && gameState.ownedThemes.includes(theme.id);
                const isActive = gameState.activeTheme === theme.id;
                const canAfford = (gameState.jerryXP || 0) >= theme.cost;
                
                const card = document.createElement('div');
                card.className = 'shop-item-card';
                
                if (isActive) {
                    card.style.border = '2px solid #4CAF50';
                    card.style.boxShadow = '0 0 10px rgba(76, 175, 80, 0.3)';
                }
                
                let buttonHTML = '';
                if (isOwned) {
                    if (isActive) {
                        buttonHTML = '<button class="shop-buy-btn" disabled style="opacity: 0.7; background: #4CAF50;">‚úì Active</button>';
                    } else {
                        buttonHTML = `<button class="shop-buy-btn" onclick="equipTheme('${theme.id}')">Equip</button>`;
                    }
                } else {
                    if (canAfford) {
                        buttonHTML = `<button class="shop-buy-btn" onclick="purchaseTheme('${theme.id}')">Buy Now</button>`;
                    } else {
                        buttonHTML = '<button class="shop-buy-btn" disabled style="opacity: 0.7;">Not Enough XP</button>';
                    }
                }
                
                card.innerHTML = `
                    <div class="shop-item-emoji">${theme.emoji}</div>
                    <div class="shop-item-name">${theme.name}</div>
                    <div class="shop-item-desc">${theme.description}</div>
                    <div class="shop-item-cost">${theme.cost} XP</div>
                    ${buttonHTML}
                `;
                
                grid.appendChild(card);
            });
        }
        
        // Purchase theme function
        function purchaseTheme(themeId) {
            const themes = [
                { id: 'dark_castle', cost: 900, background: 'assets/backgrounds/castle-dark.png' },
                { id: 'night_city', cost: 900, background: 'assets/backgrounds/city-night.png' },
                { id: 'ocean_depths', cost: 900, background: 'assets/backgrounds/ocean-deep.png' },
                { id: 'mystic_temple', cost: 900, background: 'assets/backgrounds/temple-ruins.png' },
                { id: 'cyber_grid', cost: 900, background: 'assets/backgrounds/cyber-grid.png' },
                { id: 'synth_city', cost: 900, background: 'assets/backgrounds/themes/synth-city.png' },
                { id: 'space', cost: 900, background: 'assets/backgrounds/themes/space.png' },
                { id: 'vampire_castle', cost: 400, background: 'assets/backgrounds/themes/vampire-castle.png' },
                { id: 'fort_of_illusion', cost: 500, background: 'assets/backgrounds/themes/fort-of-illusion.png' },
                { id: 'vamp_castle_bg', cost: 700, background: 'assets/backgrounds/themes/vamp-castle-bg.png' },
                { id: 'neon_city_sunset', cost: 800, background: 'assets/backgrounds/themes/neon-city-sunset.png' },
                { id: 'bright_town', cost: 1000, background: 'assets/backgrounds/themes/bright-town.png' },
                { id: 'stone_ruins', cost: 1200, background: 'assets/backgrounds/themes/stone-ruins.png' },
                { id: 'skull_gates', cost: 1500, background: 'assets/backgrounds/themes/skull-gates.png' },
                { id: 'dark_gothic_castle', cost: 2000, background: 'assets/backgrounds/themes/dark-gothic-castle.png' }
            ];
            
            const theme = themes.find(t => t.id === themeId);
            if (!theme) return;
            
            // Check if already owned
            if (gameState.ownedThemes && gameState.ownedThemes.includes(themeId)) {
                alert('You already own this theme!');
                return;
            }
            
            // Check XP
            if ((gameState.jerryXP || 0) < theme.cost) {
                if (window.audioManager) {
                    window.audioManager.playSound('shopPurchase', 0.3);
                }
                alert(`Not enough XP! You need ${theme.cost} XP.`);
                return;
            }
            
            // Play purchase sound
            if (window.audioManager) {
                window.audioManager.playSound('shopPurchase', 0.7);
            }
            
            // Deduct XP
            gameState.jerryXP -= theme.cost;
            
            // Add to owned themes
            if (!gameState.ownedThemes) {
                gameState.ownedThemes = [];
            }
            gameState.ownedThemes.push(themeId);
            
            // Auto-equip
            gameState.activeTheme = themeId;
            
            saveGameState();
            updateUI();
            updateThemesDisplay();
            
            alert('‚úÖ Theme purchased and equipped!');
        }
        
        // Equip theme function
        function equipTheme(themeId) {
            gameState.activeTheme = themeId;
            saveGameState();
            updateThemesDisplay();
            alert('‚úÖ Theme equipped!');
        }

        // Battle items definition (synced with battle system)
        const battleItems = {
            health_potion: {
                id: 'health_potion',
                name: 'Health Potion',
                emoji: 'üß™',
                description: 'Instantly restores 20 HP in battle',
                cost: 20,
                effect: 'heal',
                value: 20,
                levelRequired: 1
            },
            hyper_potion: {
                id: 'hyper_potion',
                name: 'Hyper Potion',
                emoji: '‚ù§Ô∏è‚Äçü©π',
                description: 'Instantly restores 50 HP in battle',
                cost: 40,
                effect: 'heal',
                value: 50,
                levelRequired: 1
            },
            defense_refill: {
                id: 'defense_refill',
                name: 'Shield',
                emoji: 'üõ°Ô∏è',
                description: 'Adds +20 Defense in next battle',
                cost: 25,
                effect: 'defense',
                value: 20,
                levelRequired: 1
            },
            attack_refill: {
                id: 'attack_refill',
                name: 'Power Boost',
                emoji: '‚öîÔ∏è',
                description: 'Refills +30 Attack for your gauge',
                cost: 25,
                effect: 'attack_gauge',
                value: 30,
                levelRequired: 1
            },
            asteroid_attack: {
                id: 'asteroid_attack',
                name: 'Asteroid Attack',
                emoji: 'ü™®',
                description: 'Rock projectile dealing 12 damage (Max: 15)',
                cost: 20,
                effect: 'attack',
                value: 12,
                levelRequired: 1,
                maxQuantity: 15
            },
            prickler: {
                id: 'prickler',
                name: 'Prickler',
                emoji: 'üí£',
                description: 'Nuclear explosive attack dealing 13-17 damage (Max: 15)',
                cost: 35,
                effect: 'attack',
                value: 17,
                minDamage: 13,
                maxDamage: 17,
                levelRequired: 1,
                maxQuantity: 15
            },
            fireball: {
                id: 'fireball',
                name: 'Fireball',
                emoji: 'üî•',
                description: 'Explosive projectile dealing 15-20 damage (Max: 10)',
                cost: 45,
                effect: 'attack',
                value: 20,
                minDamage: 15,
                maxDamage: 20,
                levelRequired: 1,
                maxQuantity: 10
            },
            spark: {
                id: 'spark',
                name: 'Spark',
                emoji: '‚ö°',
                description: 'Melee strike dealing 18-25 damage (Max: 10)',
                cost: 50,
                effect: 'attack',
                value: 25,
                minDamage: 18,
                maxDamage: 25,
                levelRequired: 1,
                maxQuantity: 10
            },
            freeze: {
                id: 'freeze',
                name: 'Freeze',
                emoji: '‚ùÑÔ∏è',
                description: 'Ice attack dealing 20 damage, freezes enemy for 2 turns (Max: 8)',
                cost: 65,
                effect: 'freeze',
                value: 20,
                freezeTurns: 2,
                levelRequired: 1,
                maxQuantity: 8
            },
            invisibility_cloak: {
                id: 'invisibility_cloak',
                name: 'Invisibility Cloak',
                emoji: 'ü•∑üèº',
                description: 'Allows your monster to evade the next enemy attack',
                cost: 40,
                effect: 'evade',
                levelRequired: 1
            },
            mirror_attack: {
                id: 'mirror_attack',
                name: 'Mirror Attack',
                emoji: 'ü™û',
                description: 'Reflects enemy\'s next attack back to them',
                cost: 80,
                effect: 'reflect',
                levelRequired: 1
            },
            blue_flame: {
                id: 'blue_flame',
                name: 'Blue Flame',
                image: 'assets/blue-flame.png',
                description: 'Fire-type attack dealing 20-35 damage (Max: 12)',
                cost: 50,
                effect: 'attack',
                value: 35,
                minDamage: 20,
                maxDamage: 35,
                levelRequired: 1,
                maxQuantity: 12
            },
            procrastination_ghost: {
                id: 'procrastination_ghost',
                name: 'Procrastination Ghost',
                emoji: 'üëª',
                description: '30-35 damage + enemy misses next attack (Max: 8)',
                cost: 70,
                effect: 'ghost_attack',
                value: 35,
                minDamage: 30,
                maxDamage: 35,
                causeMiss: true,
                levelRequired: 1,
                maxQuantity: 8
            },
            poison_leaf: {
                id: 'poison_leaf',
                name: 'Poison Leaf',
                emoji: 'üçÉ',
                description: 'Reduces enemy HP by 15 for 4 turns (Max: 10)',
                cost: 80,
                effect: 'poison',
                value: 15,
                poisonDamage: 15,
                duration: 4,
                levelRequired: 1,
                maxQuantity: 10
            },
            throwing_stars: {
                id: 'throwing_stars',
                name: 'Throwing Stars',
                image: 'assets/items/throwing_star_icon.png',
                projectileImage: 'assets/projectiles/ThrowingStarProjectile.gif',
                description: 'Rotating projectile dealing 15-25 damage (Max: 12)',
                cost: 150,
                effect: 'throwing_star_attack',
                value: 25,
                minDamage: 15,
                maxDamage: 25,
                levelRequired: 1,
                maxQuantity: 12
            },
            battle_glove: {
                id: 'battle_glove',
                name: 'Battle Glove',
                emoji: 'ü•ä',
                description: 'Adds +30 damage to all attacks for 5 turns',
                cost: 200,
                effect: 'damage_boost',
                value: 30,
                duration: 5,
                levelRequired: 1
            },
            jade_dagger: {
                id: 'jade_dagger',
                name: 'Jade Dagger',
                emoji: 'üó°Ô∏è',
                description: 'Rotating dagger projectile dealing 100 damage (Max: 8)',
                cost: 200,
                effect: 'attack',
                value: 100,
                levelRequired: 1,
                maxQuantity: 8
            },
            wizards_wand: {
                id: 'wizards_wand',
                name: "Wizard's Wand",
                emoji: 'ü™Ñ',
                description: 'Deals 120 damage to enemy and heals you for 100 HP (Max: 5)',
                cost: 200,
                effect: 'attack_and_heal',
                attackValue: 120,
                healValue: 100,
                levelRequired: 1,
                maxQuantity: 5
            }
        };

        // Update shop items display
        function updateShopDisplay() {
            const grid = document.getElementById('shopItemsGrid');
            if (!grid) return;
            
            // Update XP Coins display
            const xpCoinsDisplay = document.getElementById('xpCoinsShop');
            if (xpCoinsDisplay) {
                xpCoinsDisplay.textContent = gameState.jerryXP || 0;
            }
            
            // Update item count badge
            const shopItemCount = document.getElementById('shopItemCount');
            if (shopItemCount) {
                const totalItems = Object.keys(battleItems).length;
                shopItemCount.textContent = `${totalItems} items`;
            }
            
            grid.innerHTML = '';
            
            // Sort battle items by cost (lowest to highest)
            const sortedBattleItems = Object.values(battleItems).sort((a, b) => a.cost - b.cost);
            
            // Render each battle item as a shop card
            sortedBattleItems.forEach(item => {
                const currentQuantity = gameState.battleInventory[item.id] || 0;
                const isLocked = item.levelRequired && gameState.jerryLevel < item.levelRequired;
                const isMaxed = item.maxQuantity && currentQuantity >= item.maxQuantity;
                const canAfford = (gameState.jerryXP || 0) >= item.cost;
                
                const card = document.createElement('div');
                card.className = 'shop-item-card';
                
                // Add locked or maxed styling
                if (isLocked) {
                    card.style.opacity = '0.5';
                    card.style.cursor = 'not-allowed';
                } else if (isMaxed) {
                    card.style.opacity = '0.7';
                }
                
                let buttonText = 'Buy Now';
                let buttonDisabled = '';
                
                if (isLocked) {
                    buttonText = `üîí Level ${item.levelRequired}`;
                    buttonDisabled = 'disabled style="opacity: 0.5; cursor: not-allowed;"';
                } else if (isMaxed) {
                    buttonText = '‚úÖ Maxed Out';
                    buttonDisabled = 'disabled style="opacity: 0.5; cursor: not-allowed;"';
                } else if (!canAfford) {
                    buttonText = 'Not Enough XP';
                    buttonDisabled = 'disabled style="opacity: 0.7;"';
                }
                
                // Show quantity if item has max quantity
                const quantityDisplay = item.maxQuantity ? `<div style="font-size: 12px; color: #999; margin-top: 4px;">${currentQuantity}/${item.maxQuantity} owned</div>` : '';
                
                // Build lock section HTML if locked
                const lockSectionHTML = isLocked ? `
                    <div class="shop-item-lock-section">
                        <div class="shop-item-lock-icon">üîí</div>
                        <div class="shop-item-lock-text">Level ${item.levelRequired}</div>
                    </div>
                ` : '';
                
                // Build button HTML if not locked
                const buttonHTML = !isLocked ? `
                    <button class="buy-now-btn" data-item-id="${item.id}" ${buttonDisabled}>
                        ${buttonText}
                    </button>
                ` : '';
                
                const iconHTML = item.image 
                    ? `<div class="shop-item-emoji"><img src="${item.image}" style="width: 48px; height: 48px; object-fit: contain;"></div>` 
                    : `<div class="shop-item-emoji">${item.emoji}</div>`;
                
                card.innerHTML = `
                    ${iconHTML}
                    <div class="shop-item-name">${item.name}</div>
                    <div class="shop-item-description">${item.description}</div>
                    ${quantityDisplay}
                    <div class="shop-item-cost">${item.cost} XP Coins</div>
                    ${lockSectionHTML}
                    ${buttonHTML}
                `;
                
                // Add event listener to button
                const button = card.querySelector('.buy-now-btn');
                if (button && !button.disabled) {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        buyItem(item.id);
                    });
                }
                
                grid.appendChild(card);
            });
        }

        // Update owned items display (synced with battleInventory) - matches shop styling
        function updateOwnedItemsDisplay() {
            const grid = document.getElementById('ownedItemsGrid');
            const countBadge = document.getElementById('ownedItemCount');
            if (!grid) return;
            
            // Update XP Coins display
            const xpCoinsDisplay = document.getElementById('xpCoinsOwned');
            if (xpCoinsDisplay) {
                xpCoinsDisplay.textContent = gameState.jerryXP || 0;
            }
            
            grid.innerHTML = '';
            
            // Count total items
            let totalItems = 0;
            Object.keys(gameState.battleInventory).forEach(itemId => {
                totalItems += gameState.battleInventory[itemId] || 0;
            });
            
            if (countBadge) {
                countBadge.textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
            }
            
            // Render each owned battle item using same style as shop
            Object.keys(gameState.battleInventory).forEach(itemId => {
                const count = gameState.battleInventory[itemId];
                if (count > 0) {
                    const item = battleItems[itemId];
                    if (!item) return;
                    
                    const card = document.createElement('div');
                    card.className = 'shop-item-card'; // Use same class as shop items
                    
                    // Show quantity display
                    const quantityDisplay = item.maxQuantity ? `<div style="font-size: 12px; color: #999; margin-top: 4px;">${count}/${item.maxQuantity} owned</div>` : `<div style="font-size: 12px; color: #999; margin-top: 4px;">${count} owned</div>`;
                    
                    const iconHTML = item.image 
                        ? `<div class="shop-item-emoji"><img src="${item.image}" style="width: 48px; height: 48px; object-fit: contain;"></div>` 
                        : `<div class="shop-item-emoji">${item.emoji}</div>`;
                    
                    card.innerHTML = `
                        ${iconHTML}
                        <div class="shop-item-name">${item.name}</div>
                        <div class="shop-item-description">${item.description}</div>
                        ${quantityDisplay}
                        <button class="buy-now-btn" onclick="useItemFromShop('${itemId}')">
                            Use Now
                        </button>
                    `;
                    grid.appendChild(card);
                }
            });
            
            // Show empty state if no items
            if (totalItems === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                        <p style="font-size: 16px;">üéí No items yet!</p>
                        <p style="font-size: 14px; margin-top: 12px;">Buy items from the Shop tab to use in battles.</p>
                    </div>
                `;
            }
        }

        // Buy item from shop
        function buyItem(itemId) {
            const item = battleItems[itemId];
            if (!item) return;
            
            // Check level requirement
            if (item.levelRequired && gameState.jerryLevel < item.levelRequired) {
                alert(`üîí ${item.name} unlocks at Level ${item.levelRequired}! Current level: ${gameState.jerryLevel}`);
                return;
            }
            
            // Check max quantity
            const currentQuantity = gameState.battleInventory[itemId] || 0;
            if (item.maxQuantity && currentQuantity >= item.maxQuantity) {
                alert(`‚ö†Ô∏è You already have the maximum (${item.maxQuantity}) ${item.name}s!`);
                return;
            }
            
            // Check if player has enough XP
            if ((gameState.jerryXP || 0) < item.cost) {
                // Play error sound
                if (window.audioManager) {
                    window.audioManager.playSound('shopPurchase', 0.3);
                }
                alert(`Not enough XP! You need ${item.cost} XP to buy ${item.name}.`);
                return;
            }
            
            // Play purchase sound
            if (window.audioManager) {
                window.audioManager.playSound('shopPurchase', 0.7);
            }
            
            // Deduct XP (ensure it doesn't go negative)
            gameState.jerryXP = Math.max(0, (gameState.jerryXP || 0) - item.cost);
            
            // Add item to battle inventory
            if (!gameState.battleInventory[itemId]) {
                gameState.battleInventory[itemId] = 0;
            }
            gameState.battleInventory[itemId]++;
            
            // Track that this item has been unlocked (for battle button visibility)
            if (!gameState.unlockedBattleItems) {
                gameState.unlockedBattleItems = [];
            }
            if (!gameState.unlockedBattleItems.includes(itemId)) {
                gameState.unlockedBattleItems.push(itemId);
            }
            
            // Save and update displays
            saveGameState();
            updateUI(); // Update all UI elements including XP
            updateShopDisplay(); // Refresh shop to show updated quantities
            updateOwnedItemsDisplay();
            
            // Show success message
            const remaining = item.maxQuantity ? ` (${currentQuantity + 1}/${item.maxQuantity})` : '';
            alert(`‚úÖ ${item.name} purchased!${remaining} Check the Owned tab to use it.`);
        }

        // Use item from shop (opens battle or uses immediately)
        function useItemFromShop(itemId) {
            const item = battleItems[itemId];
            if (!item || !gameState.battleInventory[itemId] || gameState.battleInventory[itemId] <= 0) {
                alert('‚ö†Ô∏è Item not available!');
                return;
            }
            
            // Handle healing items (can be used outside of battle)
            if (item.effect === 'heal') {
                // Calculate maxHP based on level (same formula as battleInit.js and updateUI)
                const level = gameState.jerryLevel || 1;
                const baseHP = 100;
                const hpPerLevel = 10;
                const maxHP = baseHP + (level * hpPerLevel);
                
                // Use the SAME logic as updateUI display: gameState.health || 75
                // This ensures we read the same HP value that's shown to the user
                const currentHP = gameState.health || 75;
                
                console.log('Potion Debug - Before:', {
                    currentHP: currentHP,
                    healthType: typeof gameState.health,
                    healthValue: gameState.health
                });
                
                if (currentHP >= maxHP) {
                    alert('üíö Your monster is already at full health!');
                    return;
                }
                
                // Use healing item (ensure count doesn't go negative)
                gameState.battleInventory[itemId] = Math.max(0, gameState.battleInventory[itemId] - 1);
                
                // Play potion use sound
                if (window.audioManager) {
                    window.audioManager.playSound('potion_use', 0.7);
                }
                
                const healAmount = Number(item.value);
                const newHP = Math.min(maxHP, currentHP + healAmount);
                const actualHealed = newHP - currentHP;
                
                console.log('Potion Debug - Calculation:', {
                    healAmount: healAmount,
                    currentHP: currentHP,
                    newHP: newHP,
                    actualHealed: actualHealed
                });
                
                // Set new health as a number (ensure it's never 0 unless actually dead)
                gameState.health = Number(newHP);
                
                // If gameState.health was 0 before, make sure it's now properly set
                if (gameState.health === 0) {
                    gameState.health = newHP;
                }
                
                console.log('Potion Debug - After:', {
                    newHealth: gameState.health,
                    healthType: typeof gameState.health
                });
                
                // Save immediately to persist the heal
                saveGameState();
                
                // Prevent energy drain from running for 2 seconds after healing
                window.justUsedPotion = true;
                setTimeout(() => {
                    window.justUsedPotion = false;
                }, 2000);
                
                // Update all displays
                updateOwnedItemsDisplay();
                updateShopDisplay();
                updateUI();
                
                // Force update the health display (with scaled HP)
                const healthFill = document.querySelector('.health-fill');
                const healthText = document.querySelector('.health-text');
                if (healthFill) {
                    const healthPercentage = (gameState.health / maxHP) * 100;
                    healthFill.style.width = `${healthPercentage}%`;
                }
                if (healthText) {
                    healthText.textContent = `${Math.round(gameState.health)}/${maxHP}`;
                }
                
                alert(`${item.emoji} ${item.name} used! Healed ${actualHealed} HP.\n\nBefore: ${currentHP} HP\nAfter: ${gameState.health} HP`);
                return;
            }
            
            // Handle battle items (attack, defense, etc.)
            if (item.effect === 'attack' || item.effect === 'defense' || item.effect === 'attack_gauge') {
                alert(`üéÆ ${item.name} is ready!\n\nThis item will be automatically available in your next battle.\n\nComplete a task to trigger a battle and use it!`);
                return;
            }
            
            // Default message for other items
            alert(`üéÆ ${item.name} will be available in your next battle!`);
        }

        // Modal functions
        function openCreateTaskModal() {
            // Auto-expand Your Tasks card if collapsed
            const tasksList = document.getElementById('tasksList');
            const tasksToggle = document.getElementById('yourTasksToggleIcon');
            if (tasksList && tasksList.style.display === 'none') {
                tasksList.style.display = 'block';
                if (tasksToggle) tasksToggle.textContent = '‚ñ≤';
            }
            
            document.getElementById('createTaskModal').classList.add('active');
            // Only reset form if not editing (editingTaskIndex is null)
            if (editingTaskIndex === null) {
                resetForm();
            }
        }

        function closeModal() {
            document.getElementById('createTaskModal').classList.remove('active');
            resetForm();
        }
        
        // Update recurring tasks display visibility
        function updateRecurringTasksDisplay() {
            if (window.recurringTasksManager) {
                const card = document.getElementById('recurringTasksCard');
                if (card) {
                    card.style.display = window.recurringTasksManager.recurringTasks.length > 0 ? 'block' : 'none';
                }
                window.recurringTasksManager.updateDisplay();
            }
        }
        
        // Call this after page load
        window.addEventListener('load', () => {
            setTimeout(updateRecurringTasksDisplay, 1000);
        });

        function openQuickTaskModal() {
            // Auto-expand Quick Tasks card if collapsed
            const quickTasksList = document.getElementById('quickTasksList');
            const quickTasksToggle = document.getElementById('quickTasksToggleIcon');
            if (quickTasksList && quickTasksList.style.display === 'none') {
                quickTasksList.style.display = 'block';
                if (quickTasksToggle) quickTasksToggle.textContent = '‚ñ≤';
            }
            
            document.getElementById('quickTaskModal').classList.add('active');
            populateQuickTaskCategories();
        }

        function closeQuickTaskModal() {
            document.getElementById('quickTaskModal').classList.remove('active');
        }

        function openChangeNameModal() {
            const modal = document.getElementById('changeNameModal');
            const input = document.getElementById('newCreatureName');
            input.value = gameState.rockName;
            modal.classList.add('active');
            setTimeout(() => {
                input.focus();
                input.select();
            }, 100);
        }

        function closeChangeNameModal() {
            document.getElementById('changeNameModal').classList.remove('active');
        }

        function saveNewCreatureName() {
            const input = document.getElementById('newCreatureName');
            const newName = input.value.trim();
            
            // Validation
            if (!newName) {
                alert('Please enter a name for your Task Pal!');
                return;
            }
            if (newName.length > 20) {
                alert('Name must be 20 characters or less!');
                return;
            }
            
            // Update game state
            gameState.rockName = newName;
            saveGameState();
            updateUI();
            
            // Close modal and show success
            closeChangeNameModal();
            showSuccessMessage(`Task Pal renamed to ${newName}!`);
        }

        function populateQuickTaskCategories() {
            const container = document.getElementById('quickTaskCategories');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.keys(quickTasksDatabase).forEach(categoryKey => {
                const category = quickTasksDatabase[categoryKey];
                
                const categorySection = document.createElement('div');
                categorySection.style.marginBottom = '32px';
                categorySection.style.marginTop = categoryKey === Object.keys(quickTasksDatabase)[0] ? '24px' : '0px';
                categorySection.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 20px; padding: 12px; background: transparent; border: none; border-radius: 0;">
                        <div style="font-size: 20px;">${category.emoji}</div>
                        <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">${category.name}</div>
                    </div>
                    <div style="display: grid; gap: 8px;">
                        ${category.tasks.map(task => `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 12px; cursor: pointer; transition: all 0.2s ease;" onclick="addQuickTask('${task.id}', '${categoryKey}')" onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='var(--border-light)'">
                                <div style="font-size: 20px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--bg-tertiary); border-radius: 8px;">${task.emoji}</div>
                                <div style="flex: 1;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${task.title}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${category.name}</div>
                                </div>
                                <div style="font-size: 10px; font-weight: 600; color: white; background: #007AFF; padding: 3px 6px; border-radius: 6px;">+${task.points} pts</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(categorySection);
            });
        }

        // Task management functions
        function selectCategory(category) {
            document.querySelectorAll('[data-category]').forEach(el => el.classList.remove('selected'));
            const element = document.querySelector(`[data-category="${category}"]`);
            if (element) {
                element.classList.add('selected');
                selectedCategory = category;
            }
        }

        function selectDifficulty(difficulty) {
            document.querySelectorAll('[data-difficulty]').forEach(el => el.classList.remove('selected'));
            const element = document.querySelector(`[data-difficulty="${difficulty}"]`);
            if (element) {
                element.classList.add('selected');
                selectedDifficulty = difficulty;
            }
        }

        function selectPriority(priority) {
            document.querySelectorAll('[data-priority]').forEach(el => el.classList.remove('selected'));
            const element = document.querySelector(`[data-priority="${priority}"]`);
            if (element) {
                element.classList.add('selected');
                selectedPriority = priority;
            }
        }

        // Recurring task management
        let selectedRecurring = null;
        
        function toggleRecurringOptions() {
            const toggle = document.getElementById('recurringToggle');
            const options = document.getElementById('recurringOptions');
            const dueDateInput = document.getElementById('taskDueDate');
            
            if (toggle.checked) {
                // Check if due date is set
                if (!dueDateInput.value || dueDateInput.value.trim() === '') {
                    // Prevent toggle and show message
                    toggle.checked = false;
                    showSuccessMessage('‚ö†Ô∏è Please set a due date before enabling recurring tasks');
                    return;
                }
                options.style.display = 'block';
            } else {
                options.style.display = 'none';
                selectedRecurring = null;
                document.querySelectorAll('[data-recurring]').forEach(el => el.classList.remove('selected'));
            }
        }
        
        function selectRecurring(frequency) {
            document.querySelectorAll('[data-recurring]').forEach(el => el.classList.remove('selected'));
            
            // Always re-enable all buttons first (allows switching)
            document.querySelectorAll('[data-recurring]').forEach(el => {
                el.style.opacity = '1';
                el.style.pointerEvents = 'auto';
            });
            
            // Select the chosen frequency
            const element = document.querySelector(`[data-recurring="${frequency}"]`);
            if (element) {
                element.classList.add('selected');
                selectedRecurring = frequency;
            } else if (frequency === 'custom') {
                // Custom doesn't have a button, just set the value
                selectedRecurring = 'custom';
            }
            
            // Update preview when frequency changes
            if (typeof updateRecurringPreview === 'function') {
                updateRecurringPreview();
            }
        }
        
        function createNextRecurringTask(task) {
            if (!task.dueDate) {
                console.warn('Cannot create recurring task without due date');
                return null;
            }
            
            const currentDueDate = new Date(task.dueDate);
            let nextDueDate = new Date(currentDueDate);
            
            // Don't create next occurrence if paused
            if (task.recurringPaused) {
                console.log('‚è∏Ô∏è Recurring task is paused, not creating next occurrence');
                return null;
            }
            
            // Calculate next occurrence based on frequency
            if (task.recurringFrequency === 'custom' && task.customInterval && task.customUnit) {
                // Handle custom intervals
                const interval = task.customInterval;
                const unit = task.customUnit;
                
                if (unit === 'days') {
                    nextDueDate.setDate(nextDueDate.getDate() + interval);
                } else if (unit === 'weeks') {
                    nextDueDate.setDate(nextDueDate.getDate() + (interval * 7));
                } else if (unit === 'months') {
                    nextDueDate.setMonth(nextDueDate.getMonth() + interval);
                }
            } else {
                // Handle standard frequencies
                switch (task.recurringFrequency) {
                    case 'daily':
                        nextDueDate.setDate(nextDueDate.getDate() + 1);
                        break;
                    case 'weekly':
                        nextDueDate.setDate(nextDueDate.getDate() + 7);
                        break;
                    case 'monthly':
                        nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                        break;
                    default:
                        console.warn('Unknown recurring frequency:', task.recurringFrequency);
                        return null;
                }
            }
            
            // Create new task with same properties but new due date
            // Increment completion count for the recurring task streak
            const completionCount = (task.recurringCompletionCount || 0) + 1;
            
            const nextTask = {
                id: 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                title: task.title,
                description: task.description,
                category: task.category,
                difficulty: task.difficulty,
                priority: task.priority,
                points: task.points,
                dueDate: nextDueDate.toISOString(),
                createdAt: new Date().toISOString(),
                completed: false,
                recurring: true,
                recurringFrequency: task.recurringFrequency,
                customInterval: task.customInterval,
                customUnit: task.customUnit,
                recurringPaused: task.recurringPaused || false,
                recurringCompletionCount: completionCount, // Track how many times this recurring task has been completed
                subtasks: task.subtasks ? task.subtasks.map(st => ({
                    id: Date.now() + Math.random(),
                    title: st.title,
                    completed: false,
                    createdAt: new Date().toISOString()
                })) : []
            };
            
            return nextTask;
        }

        // Subtask management for create task modal
        let modalSubtasks = [];
        
        function addSubtask() {
            const input = document.getElementById('newSubtaskInput');
            const subtaskTitle = input.value.trim();
            
            if (!subtaskTitle) {
                return;
            }
            
            // Add to temporary array
            const subtask = {
                id: `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                title: subtaskTitle,
                completed: false
            };
            
            modalSubtasks.push(subtask);
            
            // Update display
            renderModalSubtasks();
            
            // Clear input
            input.value = '';
            input.focus();
        }
        
        function removeSubtaskFromModal(subtaskId) {
            modalSubtasks = modalSubtasks.filter(st => st.id !== subtaskId);
            renderModalSubtasks();
        }
        
        function renderModalSubtasks() {
            const container = document.getElementById('subtasksList');
            if (!container) return;
            
            if (modalSubtasks.length === 0) {
                container.innerHTML = '';
                // Hide bulk operations when no subtasks
                const bulkOps = document.getElementById('subtaskBulkOps');
                if (bulkOps) bulkOps.style.display = 'none';
                return;
            }
            
            // In Create Task modal, show simple list without checkboxes
            container.innerHTML = modalSubtasks.map(subtask => `
                <div class="subtask-item" data-subtask-id="${subtask.id}" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 6px;">
                    <span style="color: var(--text-secondary); font-size: 18px;">‚Ä¢</span>
                    <span class="subtask-item-text" ondblclick="makeSubtaskEditable('${subtask.id}')" style="flex: 1; cursor: text;" title="Double-click to edit">${subtask.title}</span>
                    <button type="button" class="subtask-item-remove" onclick="removeSubtaskFromModal('${subtask.id}')" title="Remove subtask" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 20px; padding: 0; width: 24px; height: 24px;">√ó</button>
                </div>
            `).join('');
            
            // Show/hide bulk operations
            const bulkOps = document.getElementById('subtaskBulkOps');
            if (bulkOps) {
                bulkOps.style.display = modalSubtasks.length > 0 ? 'block' : 'none';
            }
            
            // Reset Select All checkbox
            const selectAllCheckbox = document.getElementById('selectAllSubtasks');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
        }
        
        // Toggle Select All checkbox for modal subtasks
        function toggleSelectAllModalSubtasks() {
            const selectAllCheckbox = document.getElementById('selectAllSubtasks');
            const isChecked = selectAllCheckbox ? selectAllCheckbox.checked : false;
            
            const checkboxes = document.querySelectorAll('.subtask-select-checkbox');
            checkboxes.forEach(cb => cb.checked = isChecked);
        }
        
        // Bulk delete selected subtasks in modal
        function bulkDeleteModalSubtasks() {
            const checkboxes = document.querySelectorAll('.subtask-select-checkbox:checked');
            const idsToDelete = Array.from(checkboxes).map(cb => cb.dataset.subtaskId);
            
            if (idsToDelete.length === 0) {
                showSuccessMessage('‚ö†Ô∏è No subtasks selected', 'Select subtasks to delete');
                return;
            }
            
            modalSubtasks = modalSubtasks.filter(st => !idsToDelete.includes(st.id));
            renderModalSubtasks();
            showSuccessMessage(`üóëÔ∏è Deleted ${idsToDelete.length} subtask(s)`);
        }
        
        // Legacy function - no longer used but kept for compatibility
        function toggleSubtaskCompletion(subtaskId) {
            // Subtasks in Create Task modal cannot be completed - they're just being added
            // This function is kept for compatibility but does nothing in the modal
            console.log('toggleSubtaskCompletion called but disabled in Create Task modal');
        }
        
        function loadSubtasksToModal(subtasks) {
            if (!subtasks || subtasks.length === 0) {
                modalSubtasks = [];
                renderModalSubtasks();
                return;
            }
            
            modalSubtasks = subtasks.map(st => ({
                id: st.id || `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                title: st.title,
                completed: st.completed || false
            }));
            
            renderModalSubtasks();
        }

        function resetForm() {
            document.getElementById('taskForm').reset();
            document.querySelectorAll('.selection-item').forEach(el => el.classList.remove('selected'));
            selectedCategory = null;
            selectedDifficulty = null;
            selectedPriority = null;
            editingTaskIndex = null;
            editingRecurringTaskId = null;
            document.querySelector('.modal-title').textContent = 'Create Task';
            // Reset native datetime-local input
            document.getElementById('taskDueDate').value = '';
            // Reset recurring task settings
            const recurringToggle = document.getElementById('recurringToggle');
            const recurringOptions = document.getElementById('recurringOptions');
            if (recurringToggle) recurringToggle.checked = false;
            if (recurringOptions) recurringOptions.style.display = 'none';
            selectedRecurring = null;
            
            // Re-enable all recurring frequency buttons (fix for untappable buttons bug)
            document.querySelectorAll('[data-recurring]').forEach(el => {
                el.style.opacity = '1';
                el.style.pointerEvents = 'auto';
                el.classList.remove('selected');
            });
            
            // Clear subtasks
            modalSubtasks = [];
            renderModalSubtasks();
        }

        // Date picker now uses native HTML5 datetime-local input

        function createTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const dueDateInput = document.getElementById('taskDueDate').value;
            
            // Convert native datetime-local value to ISO format
            let dueDate = null;
            if (dueDateInput) {
                dueDate = new Date(dueDateInput).toISOString();
            }
            
            if (!title) {
                alert('Please enter a task title');
                return;
            }
            
            if (!selectedCategory) {
                alert('Please select a category');
                return;
            }
            
            if (!selectedDifficulty) {
                alert('Please select a difficulty');
                return;
            }
            
            if (!selectedPriority) {
                alert('Please select a priority');
                return;
            }
            
            const pointsMap = { easy: 2, medium: 5, hard: 10 };
            
            // Check if recurring task is enabled
            const recurringToggle = document.getElementById('recurringToggle');
            const isRecurring = recurringToggle.checked && selectedRecurring;
            
            // Get custom interval if selected
            let customInterval = null;
            let customUnit = null;
            if (isRecurring && selectedRecurring === 'custom') {
                customInterval = parseInt(document.getElementById('customIntervalNumber').value);
                customUnit = document.getElementById('customIntervalUnit').value;
            }
            
            // Get paused state
            const isPaused = document.getElementById('recurringPaused')?.checked || false;
            
            // Create regular task
            const task = {
                    id: 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    title,
                    description,
                    category: selectedCategory,
                    difficulty: selectedDifficulty,
                    priority: selectedPriority,
                    points: pointsMap[selectedDifficulty],
                    dueDate: dueDate || null,
                    createdAt: new Date().toISOString(),
                    completed: false,
                    recurring: isRecurring,
                    recurringFrequency: isRecurring ? selectedRecurring : null,
                    customInterval: customInterval,
                    customUnit: customUnit,
                    recurringPaused: isPaused,
                    subtasks: modalSubtasks.length > 0 ? modalSubtasks.map(st => ({
                        id: st.id,
                        title: st.title,
                        completed: false,
                        createdAt: new Date().toISOString()
                    })) : []
                };
                
                if (editingTaskIndex !== null) {
                    gameState.tasks[editingTaskIndex] = task;
                    console.log('üìù Task updated:', task);
                    showSuccessMessage('Task updated successfully!');
                } else {
                    gameState.tasks.push(task);
                    gameState.totalTasksCreated += 1;
                    console.log('üìù New task created:', task);
                    console.log('üìù Total tasks now:', gameState.tasks.length);
                    showSuccessMessage('Task created successfully!');
                }
                
            // Schedule notifications for the new/updated task
            if (window.notificationManager && task.dueDate) {
                const taskIndex = editingTaskIndex !== null ? editingTaskIndex : gameState.tasks.length - 1;
                window.notificationManager.scheduleTaskNotifications(task, taskIndex);
            }
            
            saveGameState();
            
            // Check energy after creating task
            checkAndUpdateEnergy();
            
            updateUI();
            updateTasksDisplay();
            closeModal();
        }

        function completeTask(index) {
            const task = gameState.tasks[index];
            if (!task) return;
            
            // Stop focus timer when any task is completed
            if (focusActive) {
                console.log('‚è±Ô∏è Focus Timer: Task completed - stopping timer');
                stopFocusTimer(false);
                showSuccessMessage('‚è±Ô∏è Focus Timer stopped', 'Task completed!');
            }
            
            // Clear notifications for this task
            if (window.notificationManager) {
                window.notificationManager.clearTaskNotifications(index);
            }
            
            // Store old level for level up detection
            const oldLevel = gameState.level;
            
            // Track today's completions
            const today = new Date().toDateString();
            if (gameState.lastDayTracked !== today) {
                gameState.completedTasksToday = 0;
                gameState.lastDayTracked = today;
            }
            gameState.completedTasksToday++;
            
            // Update streak (for tracking only, no multiplier)
            updateStreak();
            
            // Award 80 points for task completion
            let basePoints = 80;
            
            // Add points and health
            gameState.taskPoints += basePoints;
            const oldHealth = gameState.health;
            gameState.health = Math.min(100, gameState.health + 10);
            gameState.completedTasks++;
            
            // Check for egg re-hatching (when HP reaches 50)
            // CRITICAL: Only apply to reverted eggs (level 5+), NOT new eggs (level 1-4)
            if (gameState.isEgg && gameState.jerryLevel >= 5 && oldHealth < 50 && gameState.health >= 50) {
                gameState.isEgg = false;
                console.log('[Re-hatching] Egg hatched after reaching 50 HP!');
                
                // SKIN SYNC FIX: Check if skin is equipped before loading default sprite
                const equippedSkinId = gameState.equippedSkinId;
                
                if (!equippedSkinId) {
                    // No skin equipped, update sprite to show default monster
                    const savedMonster = localStorage.getItem('selectedMonster');
                    const spritePrefix = localStorage.getItem('heroSpritePrefix') || 'Pink_Monster';
                    
                    const mainHeroSprite = document.getElementById('mainHeroSprite');
                    if (mainHeroSprite) {
                        mainHeroSprite.src = `assets/heroes/${spritePrefix}_Idle_4.png`;
                        mainHeroSprite.classList.remove('egg-sprite');
                        // CRITICAL: Reset inline styles that were set for egg display
                        mainHeroSprite.style.animation = 'none';
                        mainHeroSprite.style.objectFit = 'none';
                        mainHeroSprite.style.objectPosition = '0 0';
                        mainHeroSprite.style.width = '32px';
                        mainHeroSprite.style.height = '32px';
                        mainHeroSprite.style.maxWidth = '';
                        mainHeroSprite.style.maxHeight = '';
                        mainHeroSprite.style.transform = 'scale(4)';
                        console.log('[Hatching] Applied sprite animation styles to mainHeroSprite');
                    }
                } else {
                    // Skin is equipped, let skinsManager handle it
                    console.log('[Hatching] Skin equipped:', equippedSkinId, '- triggering skinsManager update');
                    if (window.skinsManager) {
                        window.skinsManager.updateAllMonsterVisuals();
                    }
                }
                
                const heroSprite = document.getElementById('heroSprite');
                if (heroSprite) {
                    heroSprite.src = `assets/heroes/${spritePrefix}_Idle_4.png`;
                    heroSprite.classList.remove('egg-sprite');
                    // CRITICAL: Reset inline styles for heroSprite too
                    heroSprite.style.animation = 'none';
                    heroSprite.style.objectFit = 'none';
                    heroSprite.style.objectPosition = '0 0';
                    heroSprite.style.width = '32px';
                    heroSprite.style.height = '32px';
                    heroSprite.style.maxWidth = '';
                    heroSprite.style.maxHeight = '';
                    heroSprite.style.transform = 'scale(4)';
                }
                
                // Show re-hatching message
                setTimeout(() => {
                    showSuccessMessage('ü•ö Hatched Again!', `${gameState.rockName} is back!`);
                    if (window.fireConfetti) {
                        window.fireConfetti();
                    }
                }, 500);
            }
            
            // Refill battle gauges when completing tasks
            if (window.battleManager) {
                // Refill 20 points to attack gauge (max 100)
                window.battleManager.attackGauge = Math.min(100, window.battleManager.attackGauge + 20);
                // Refill 15 points to defense gauge (max 100)
                window.battleManager.defenseGauge = Math.min(100, window.battleManager.defenseGauge + 15);
                console.log(`‚öîÔ∏è Battle gauges refilled! Attack: ${window.battleManager.attackGauge}/100, Defense: ${window.battleManager.defenseGauge}/100`);
            }
            
            // Add XP (with boost if active)
            // Base conversion: 10 XP points = 8 XP Coins (0.8 ratio, rounded up)
            let xpToAdd = Math.ceil(basePoints * 0.8);
            if (gameState.xpBoostActive) {
                xpToAdd *= 2;
                gameState.xpBoostActive = false;  // Consume boost
                delete gameState.xpBoostExpiry;
                showSuccessMessage('‚≠ê XP Boost consumed! 2x XP earned!');
            }
            addJerryXP(xpToAdd);
            
            // Track achievement progress before removing task
            if (window.achievementTracker) {
                window.achievementTracker.trackTaskCompletion(task, false);
                window.achievementTracker.trackOnTimeTask(task);
            }
            
            // Track habit completion
            if (window.trackTaskCompletion) {
                window.trackTaskCompletion(task, false);
            }
            
            // Update habits display
            if (window.updateHabitsDisplay) {
                window.updateHabitsDisplay();
            }
            
            // Check if this is a quest task
            const isQuestTask = task.isQuest === true;
            
            let nextRecurringDate = null;
            
            // Remove task
            gameState.tasks.splice(index, 1);
            
            // Update daily challenge progress
            console.log('üéØ Calling updateChallengeProgress with task:', {
                title: task.title,
                category: task.category,
                difficulty: task.difficulty,
                priority: task.priority,
                isQuickTask: false
            });
            updateChallengeProgress(task, false);
            
            // Show completion message with random variation
            const randomMsg = getRandomCompletionMessage(false);
            if (nextRecurringDate) {
                // Format the next occurrence date
                const dateStr = nextRecurringDate.toLocaleDateString();
                const timeStr = nextRecurringDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                showSuccessMessage(`‚úÖ Task completed! Next occurrence created for ${dateStr} ${timeStr}`, `+${basePoints} points earned!`);
            } else {
                showSuccessMessage(`${randomMsg.emoji} ${randomMsg.message}`, `+${basePoints} points earned!`);
            }
            
            saveGameState();
            
            // Check energy after completing task (should increase since task is done)
            checkAndUpdateEnergy();
            
            // Refresh background to preserve custom theme
            console.log('[Theme Debug] Active theme before refresh:', gameState.activeTheme);
            if (typeof window.refreshBackground === 'function') {
                window.refreshBackground();
                console.log('[Theme Debug] refreshBackground called after task completion');
            }
            
            updateUI();
            updateTasksDisplay();
            updateQuickTasksDisplay();
            
            // Play task completion sound (different for quest tasks and recurring tasks)
            if (window.audioManager) {
                if (isQuestTask) {
                    // Play quest complete sound for quest giver tasks
                    window.audioManager.playSound('questComplete', 0.7);
                    console.log('üéØ Quest task completed, playing quest complete sound...');

                } else {
                    window.audioManager.playSound('taskComplete', 0.7);
                }
            }
            
            // Fire confetti
            console.log('üéØ Regular task completed, firing confetti...');
            if (window.fireConfetti) {
                window.fireConfetti();
            } else {
                console.warn('Confetti function not available');
            }
            
            // Trigger dialogue system (30% chance)
            if (typeof MoodDialogueSystem !== 'undefined' && MoodDialogueSystem.showDialogue) {
                if (Math.random() < 0.3) {
                    setTimeout(() => {
                        MoodDialogueSystem.showDialogue('task_complete');
                    }, 1000);
                }
            }
            
            // Trigger battle with 50% probability for regular tasks
            setTimeout(() => {
                let battleTriggered = false;
                if (typeof window.maybeTriggerBattle === 'function') {
                    battleTriggered = window.maybeTriggerBattle('regularTask', { taskId: task.id });
                } else {
                    console.warn('Battle trigger system not loaded yet');
                }
                
                // Only trigger quest giver if battle did NOT start
                if (!battleTriggered) {
                    setTimeout(() => {
                        if (typeof window.triggerMerlinQuestFromTaskCompletion === 'function') {
                            window.triggerMerlinQuestFromTaskCompletion();
                        } else {
                            console.warn('Quest giver trigger system not loaded yet');
                        }
                    }, 3000); // Wait 3 seconds after no battle
                }
            }, 2000); // Wait 2 seconds after confetti
            
            // Show dialogue after a brief delay using tooltip system
            setTimeout(() => {
                if (typeof onTaskCompleted === 'function') {
                    onTaskCompleted(task.category || 'default');
                }
                
                // Trigger mood dialogue system
                if (typeof MoodDialogueSystem !== 'undefined') {
                    MoodDialogueSystem.onTaskComplete();
                }
            }, 1000);
        }

        function editTask(index) {
            const task = gameState.tasks[index];
            if (!task) return;
            
            editingTaskIndex = index;
            
            // Populate form
            document.getElementById('taskTitle').value = task.title || '';
            document.getElementById('taskDescription').value = task.description || '';
            
            // Format dueDate for datetime-local input (requires YYYY-MM-DDTHH:MM format)
            if (task.dueDate) {
                const date = new Date(task.dueDate);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                document.getElementById('taskDueDate').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            } else {
                document.getElementById('taskDueDate').value = '';
            }
            
            // Select options
            if (task.category) selectCategory(task.category);
            if (task.difficulty) selectDifficulty(task.difficulty);
            if (task.priority) selectPriority(task.priority);
            
            // Handle recurring task settings
            const recurringToggle = document.getElementById('recurringToggle');
            const recurringOptions = document.getElementById('recurringOptions');
            if (task.recurring && task.recurringFrequency) {
                recurringToggle.checked = true;
                recurringOptions.style.display = 'block';
                selectRecurring(task.recurringFrequency);
            } else {
                recurringToggle.checked = false;
                recurringOptions.style.display = 'none';
                selectedRecurring = null;
            }
            
            // Load subtasks
            loadSubtasksToModal(task.subtasks || []);
            
            // Update modal title
            document.querySelector('.modal-title').textContent = 'Edit Task';
            
            // Show modal
            openCreateTaskModal();
        }

        function deleteTask(index) {
            if (confirm('Are you sure you want to delete this task?')) {
                // Clear notifications for this task
                if (window.notificationManager) {
                    window.notificationManager.clearTaskNotifications(index);
                }
                
                gameState.tasks.splice(index, 1);
                saveGameState();
                updateUI();
                updateTasksDisplay();
                showSuccessMessage('Task deleted!');
            }
        }
        
        // === MVP WORKFLOW IMPROVEMENTS ===
        
        // Wrapper functions for UI buttons
        function skipRecurringTask(index) {
            skipOccurrence(index);
        }
        
        function toggleRecurringPause(index) {
            togglePauseRecurring(index);
        }
        
        // Smart Defaults Handlers
        function applyQuickDueToday() {
            const checkbox = document.getElementById('quickDueToday');
            const dueDateInput = document.getElementById('taskDueDate');
            if (!dueDateInput) return;
            
            // If checked, uncheck other quick options (mutually exclusive)
            if (checkbox && checkbox.checked) {
                const repeatDaily = document.getElementById('quickRepeatDaily');
                const hasSubtasks = document.getElementById('quickHasSubtasks');
                if (repeatDaily) repeatDaily.checked = false;
                if (hasSubtasks) hasSubtasks.checked = false;
                
                // Apply due today logic
                const now = new Date();
                now.setHours(23, 59, 0, 0);
                dueDateInput.value = now.toISOString().slice(0, 16);
            } else {
                // If unchecked, clear due date
                dueDateInput.value = '';
            }
            updateRecurringPreview();
        }

        function applyQuickRepeatDaily() {
            const checkbox = document.getElementById('quickRepeatDaily');
            const recurringToggle = document.getElementById('recurringToggle');
            const frequencySelect = document.getElementById('recurringFrequency');
            if (!recurringToggle || !frequencySelect) return;
            
            // If checked, uncheck other quick options (mutually exclusive)
            if (checkbox && checkbox.checked) {
                const dueToday = document.getElementById('quickDueToday');
                const hasSubtasks = document.getElementById('quickHasSubtasks');
                if (dueToday) dueToday.checked = false;
                if (hasSubtasks) hasSubtasks.checked = false;
                
                // Apply repeat daily logic
                recurringToggle.checked = true;
                toggleRecurringOptions();
                frequencySelect.value = 'daily';
            } else {
                // If unchecked, disable recurring
                recurringToggle.checked = false;
                toggleRecurringOptions();
            }
            updateRecurringPreview();
        }

        function applyQuickHasSubtasks() {
            const checkbox = document.getElementById('quickHasSubtasks');
            const subtasksSection = document.getElementById('subtasksSection');
            if (!subtasksSection) return;
            
            // If checked, uncheck other quick options (mutually exclusive)
            if (checkbox && checkbox.checked) {
                const dueToday = document.getElementById('quickDueToday');
                const repeatDaily = document.getElementById('quickRepeatDaily');
                if (dueToday) dueToday.checked = false;
                if (repeatDaily) repeatDaily.checked = false;
                
                // Show subtasks section
                subtasksSection.style.display = 'block';
            } else {
                // Hide subtasks section if unchecked
                subtasksSection.style.display = 'none';
            }
        }

        // Subtask Template System
        function applySubtaskTemplate() {
            const templateSelect = document.getElementById('subtaskTemplate');
            if (!templateSelect) return;
            const template = templateSelect.value;
            if (!template) return;
            
            const subtaskTemplates = {
                'research': {
                    name: 'Research Project',
                    subtasks: [
                        'Define research question',
                        'Gather sources and materials',
                        'Review and analyze data',
                        'Draft initial findings',
                        'Revise and finalize report'
                    ]
                },
                'investment': {
                    name: 'Investment Analysis',
                    subtasks: [
                        'Research company fundamentals',
                        'Analyze financial statements',
                        'Review market trends',
                        'Calculate risk/reward ratio',
                        'Make investment decision'
                    ]
                },
                'planning': {
                    name: 'Event Planning',
                    subtasks: [
                        'Set event date and budget',
                        'Create guest list',
                        'Book venue and vendors',
                        'Send invitations',
                        'Finalize event details'
                    ]
                },
                'learning': {
                    name: 'Learning Path',
                    subtasks: [
                        'Identify learning goals',
                        'Find quality resources',
                        'Create study schedule',
                        'Practice and apply knowledge',
                        'Review and assess progress'
                    ]
                },
                'home': {
                    name: 'Home Improvement',
                    subtasks: [
                        'Plan project scope',
                        'Get materials and tools',
                        'Prepare work area',
                        'Execute improvement',
                        'Clean up and inspect'
                    ]
                },
                // Work Templates
                'meeting': {
                    name: 'Meeting Preparation',
                    subtasks: [
                        'Review meeting agenda',
                        'Prepare talking points',
                        'Gather relevant documents',
                        'Set up meeting space/link',
                        'Send reminder to attendees'
                    ]
                },
                'presentation': {
                    name: 'Presentation',
                    subtasks: [
                        'Define key message',
                        'Create outline',
                        'Design slides',
                        'Practice delivery',
                        'Prepare for Q&A'
                    ]
                },
                'project': {
                    name: 'Project Kickoff',
                    subtasks: [
                        'Define project goals',
                        'Identify stakeholders',
                        'Create timeline',
                        'Assign responsibilities',
                        'Schedule kickoff meeting'
                    ]
                },
                // Finance Templates
                'budget': {
                    name: 'Budget Planning',
                    subtasks: [
                        'Review current expenses',
                        'Set financial goals',
                        'Categorize spending',
                        'Allocate funds',
                        'Set up tracking system'
                    ]
                },
                'taxes': {
                    name: 'Tax Preparation',
                    subtasks: [
                        'Gather income documents',
                        'Collect expense receipts',
                        'Review deductions',
                        'Complete tax forms',
                        'File and save copies'
                    ]
                },
                // Event Templates
                'travel': {
                    name: 'Trip Planning',
                    subtasks: [
                        'Choose destination',
                        'Book transportation',
                        'Reserve accommodations',
                        'Plan activities',
                        'Pack essentials'
                    ]
                },
                'party': {
                    name: 'Party Planning',
                    subtasks: [
                        'Set theme and budget',
                        'Create guest list',
                        'Plan menu and drinks',
                        'Arrange decorations',
                        'Prepare entertainment'
                    ]
                },
                // Learning Templates
                'course': {
                    name: 'Online Course',
                    subtasks: [
                        'Review course syllabus',
                        'Set weekly study time',
                        'Complete module lessons',
                        'Take practice quizzes',
                        'Submit final project'
                    ]
                },
                'book': {
                    name: 'Book Reading',
                    subtasks: [
                        'Set reading schedule',
                        'Read assigned chapters',
                        'Take notes on key points',
                        'Reflect on themes',
                        'Write summary/review'
                    ]
                },
                // Home Templates
                'cleaning': {
                    name: 'Deep Cleaning',
                    subtasks: [
                        'Declutter surfaces',
                        'Dust all areas',
                        'Clean floors',
                        'Sanitize bathrooms',
                        'Organize storage'
                    ]
                },
                'moving': {
                    name: 'Moving Checklist',
                    subtasks: [
                        'Sort and declutter',
                        'Pack room by room',
                        'Label all boxes',
                        'Arrange movers/truck',
                        'Update address'
                    ]
                },
                // Fitness Templates
                'workout': {
                    name: 'Workout Routine',
                    subtasks: [
                        'Warm up 5 min',
                        'Main exercise 30 min',
                        'Cool down 5 min',
                        'Stretch muscles',
                        'Log workout'
                    ]
                },
                'marathon': {
                    name: 'Marathon Training',
                    subtasks: [
                        'Complete scheduled run',
                        'Cross-training activity',
                        'Hydration check',
                        'Nutrition planning',
                        'Rest and recovery'
                    ]
                },
                // Wellness Templates
                'meditation': {
                    name: 'Meditation Practice',
                    subtasks: [
                        'Find quiet space',
                        'Set timer',
                        'Focus on breathing',
                        'Practice mindfulness',
                        'Journal reflections'
                    ]
                },
                'morning': {
                    name: 'Morning Routine',
                    subtasks: [
                        'Wake up on time',
                        'Hydrate with water',
                        'Light exercise/stretch',
                        'Healthy breakfast',
                        'Review daily goals'
                    ]
                },
                'evening': {
                    name: 'Evening Routine',
                    subtasks: [
                        'Review day\'s accomplishments',
                        'Prepare for tomorrow',
                        'Relaxation activity',
                        'Personal hygiene',
                        'Wind down for sleep'
                    ]
                },
                // Creative Templates
                'creative': {
                    name: 'Creative Project',
                    subtasks: [
                        'Brainstorm ideas',
                        'Create initial sketch/draft',
                        'Develop concept',
                        'Refine and polish',
                        'Share and get feedback'
                    ]
                },
                'writing': {
                    name: 'Writing Project',
                    subtasks: [
                        'Outline structure',
                        'Write first draft',
                        'Edit for clarity',
                        'Proofread for errors',
                        'Finalize and publish'
                    ]
                }
            };
            
            const t = subtaskTemplates[template];
            if (!t) return;
            
            // Clear existing subtasks
            modalSubtasks = [];
            
            // Add template subtasks
            modalSubtasks = t.subtasks.map(title => ({
                id: `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                title: title,
                completed: false
            }));
            
            renderModalSubtasks();
            templateSelect.value = '';
            showSuccessMessage(`üìã Template "${t.name}" loaded!`);
        }

        // Template System
        function applyTaskTemplate() {
            const templateSelect = document.getElementById('templateSelector');
            if (!templateSelect) return;
            const template = templateSelect.value;
            if (!template) return;
            
            const templates = {
                // Work Templates
                'daily-standup': {
                    title: 'Daily Standup',
                    category: 'work',
                    difficulty: 'easy',
                    priority: 'high',
                    recurring: true,
                    frequency: 'daily',
                    subtasks: ['What I did yesterday', 'What I will do today', 'Any blockers']
                },
                'meeting-prep': {
                    title: 'Meeting Preparation',
                    category: 'work',
                    difficulty: 'medium',
                    priority: 'high',
                    recurring: false,
                    frequency: 'daily',
                    subtasks: ['Review agenda', 'Prepare talking points', 'Gather materials', 'Test tech setup']
                },
                'project-planning': {
                    title: 'Project Planning',
                    category: 'work',
                    difficulty: 'hard',
                    priority: 'high',
                    recurring: false,
                    frequency: 'daily',
                    subtasks: ['Define project scope', 'Set milestones', 'Assign resources', 'Create timeline', 'Identify risks']
                },
                // Fitness Templates
                'daily-workout': {
                    title: 'Daily Workout',
                    category: 'fitness',
                    difficulty: 'medium',
                    priority: 'high',
                    recurring: true,
                    frequency: 'daily',
                    subtasks: ['Warm up 5 min', 'Main exercise 30 min', 'Cool down 5 min']
                },
                'morning-run': {
                    title: 'Morning Run',
                    category: 'fitness',
                    difficulty: 'medium',
                    priority: 'medium',
                    recurring: true,
                    frequency: 'daily',
                    subtasks: ['Stretch 5 min', 'Run 20-30 min', 'Cool down walk 5 min', 'Hydrate']
                },
                'yoga-session': {
                    title: 'Yoga Session',
                    category: 'fitness',
                    difficulty: 'easy',
                    priority: 'medium',
                    recurring: true,
                    frequency: 'daily',
                    subtasks: ['Set up mat', 'Breathing exercises 5 min', 'Yoga poses 20 min', 'Savasana 5 min']
                },
                // Mindfulness Templates
                'meditation': {
                    title: 'Meditation Session',
                    category: 'mindfulness',
                    difficulty: 'easy',
                    priority: 'high',
                    recurring: true,
                    frequency: 'daily',
                    subtasks: ['Find quiet space', 'Set timer 10-20 min', 'Focus on breath', 'Journal insights']
                },
                'gratitude-journal': {
                    title: 'Gratitude Journal',
                    category: 'mindfulness',
                    difficulty: 'easy',
                    priority: 'medium',
                    recurring: true,
                    frequency: 'daily',
                    subtasks: ['Write 3 things grateful for', 'Reflect on positive moments', 'Set intention for tomorrow']
                },
                'breathing-exercise': {
                    title: 'Breathing Exercise',
                    category: 'mindfulness',
                    difficulty: 'easy',
                    priority: 'medium',
                    recurring: true,
                    frequency: 'daily',
                    subtasks: ['4-7-8 breathing (3 cycles)', 'Box breathing (3 cycles)', 'Deep belly breaths (5 min)']
                },
                // Learning Templates
                'book-outline': {
                    title: 'Book Outline',
                    category: 'learning',
                    difficulty: 'hard',
                    priority: 'medium',
                    recurring: false,
                    frequency: 'daily',
                    subtasks: ['Read chapter/section', 'Take key notes', 'Summarize main ideas', 'Write questions', 'Connect to existing knowledge']
                },
                'study-session': {
                    title: 'Study Session',
                    category: 'learning',
                    difficulty: 'medium',
                    priority: 'high',
                    recurring: true,
                    frequency: 'daily',
                    subtasks: ['Review previous material', 'Learn new content 25 min', 'Take 5 min break', 'Practice exercises', 'Review and summarize']
                },
                'weekly-review': {
                    title: 'Weekly Review',
                    category: 'goals',
                    difficulty: 'medium',
                    priority: 'medium',
                    recurring: true,
                    frequency: 'weekly',
                    subtasks: ['Review completed tasks', 'Assess progress on goals', 'Plan next week', 'Update priorities']
                },
                // Home Templates
                'cleaning-routine': {
                    title: 'Cleaning Routine',
                    category: 'home',
                    difficulty: 'medium',
                    priority: 'medium',
                    recurring: true,
                    frequency: 'weekly',
                    subtasks: ['Declutter surfaces', 'Vacuum/sweep floors', 'Clean bathroom', 'Wipe kitchen', 'Take out trash']
                },
                'meal-prep': {
                    title: 'Meal Prep',
                    category: 'home',
                    difficulty: 'medium',
                    priority: 'medium',
                    recurring: true,
                    frequency: 'weekly',
                    subtasks: ['Plan meals for week', 'Make grocery list', 'Prep vegetables', 'Cook proteins', 'Portion into containers']
                },
                'grocery-shopping': {
                    title: 'Grocery Shopping',
                    category: 'home',
                    difficulty: 'easy',
                    priority: 'medium',
                    recurring: true,
                    frequency: 'weekly',
                    subtasks: ['Check pantry/fridge', 'Make shopping list', 'Go to store', 'Put away groceries']
                },
                // Self-Help Templates
                'morning-routine': {
                    title: 'Morning Routine',
                    category: 'self-help',
                    difficulty: 'easy',
                    priority: 'high',
                    recurring: true,
                    frequency: 'daily',
                    subtasks: ['Wake up at set time', 'Hydrate', 'Light exercise/stretch', 'Healthy breakfast', 'Review daily goals']
                },
                'evening-routine': {
                    title: 'Evening Routine',
                    category: 'self-help',
                    difficulty: 'easy',
                    priority: 'medium',
                    recurring: true,
                    frequency: 'daily',
                    subtasks: ['Review day accomplishments', 'Prepare for tomorrow', 'Wind down activity', 'Skincare routine', 'Set bedtime alarm']
                },
                'goal-setting': {
                    title: 'Goal Setting',
                    category: 'self-help',
                    difficulty: 'medium',
                    priority: 'high',
                    recurring: false,
                    frequency: 'daily',
                    subtasks: ['Define SMART goal', 'Break into milestones', 'Identify obstacles', 'Create action plan', 'Set review date']
                },
                // Sleep Templates
                'bedtime-routine': {
                    title: 'Bedtime Routine',
                    category: 'sleep',
                    difficulty: 'easy',
                    priority: 'high',
                    recurring: true,
                    frequency: 'daily',
                    subtasks: ['No screens 30 min before bed', 'Dim lights', 'Light reading or meditation', 'Set alarm for morning', 'Lights out by target time']
                },
                'sleep-hygiene': {
                    title: 'Sleep Hygiene Check',
                    category: 'sleep',
                    difficulty: 'easy',
                    priority: 'medium',
                    recurring: true,
                    frequency: 'weekly',
                    subtasks: ['Review sleep schedule', 'Check bedroom temperature', 'Assess caffeine intake', 'Evaluate screen time', 'Plan improvements']
                },
                // Health Templates
                'health-checkup': {
                    title: 'Health Check-up',
                    category: 'health',
                    difficulty: 'medium',
                    priority: 'high',
                    recurring: false,
                    frequency: 'daily',
                    subtasks: ['Schedule appointment', 'Prepare health questions', 'Gather medical records', 'Attend appointment', 'Follow up on results']
                },
                'medication-tracker': {
                    title: 'Daily Medication',
                    category: 'health',
                    difficulty: 'easy',
                    priority: 'high',
                    recurring: true,
                    frequency: 'daily',
                    subtasks: ['Take morning medication', 'Take evening medication', 'Log any side effects', 'Check refill needs']
                },
                // Wellness Templates
                'self-care-day': {
                    title: 'Self-Care Day',
                    category: 'wellness',
                    difficulty: 'easy',
                    priority: 'medium',
                    recurring: true,
                    frequency: 'weekly',
                    subtasks: ['Relaxing bath/shower', 'Skincare routine', 'Enjoyable activity', 'Healthy meal', 'Early bedtime']
                },
                'mental-health-check': {
                    title: 'Mental Health Check-in',
                    category: 'wellness',
                    difficulty: 'easy',
                    priority: 'high',
                    recurring: true,
                    frequency: 'weekly',
                    subtasks: ['Rate mood 1-10', 'Journal feelings', 'Identify stressors', 'Practice coping strategy', 'Plan self-care']
                },
                // Creative Templates
                'creative-project': {
                    title: 'Creative Project',
                    category: 'creative',
                    difficulty: 'hard',
                    priority: 'medium',
                    recurring: false,
                    frequency: 'daily',
                    subtasks: ['Brainstorm ideas', 'Gather materials/resources', 'Create first draft', 'Refine and edit', 'Share or publish']
                },
                'daily-creativity': {
                    title: 'Daily Creative Practice',
                    category: 'creative',
                    difficulty: 'easy',
                    priority: 'medium',
                    recurring: true,
                    frequency: 'daily',
                    subtasks: ['Set up workspace', 'Create for 20 min', 'Reflect on work', 'Save progress']
                },
                // Finance Templates
                'budget-review': {
                    title: 'Budget Review',
                    category: 'finance',
                    difficulty: 'medium',
                    priority: 'high',
                    recurring: true,
                    frequency: 'weekly',
                    subtasks: ['Review transactions', 'Categorize expenses', 'Check against budget', 'Identify savings opportunities', 'Plan next week']
                },
                'bill-payment': {
                    title: 'Monthly Bills',
                    category: 'finance',
                    difficulty: 'easy',
                    priority: 'high',
                    recurring: true,
                    frequency: 'monthly',
                    subtasks: ['Review upcoming bills', 'Check account balances', 'Pay bills', 'Update budget tracker', 'File receipts']
                }
            };
            
            const t = templates[template];
            if (!t) return;
            
            document.getElementById('taskTitle').value = t.title;
            selectedCategory = t.category;
            selectedDifficulty = t.difficulty;
            selectedPriority = t.priority;
            
            // Update visual selection
            document.querySelectorAll('[data-category]').forEach(el => {
                el.classList.toggle('selected', el.dataset.category === t.category);
            });
            document.querySelectorAll('[data-difficulty]').forEach(el => {
                el.classList.toggle('selected', el.dataset.difficulty === t.difficulty);
            });
            document.querySelectorAll('[data-priority]').forEach(el => {
                el.classList.toggle('selected', el.dataset.priority === t.priority);
            });
            
            const recurringToggle = document.getElementById('recurringToggle');
            const frequencySelect = document.getElementById('recurringFrequency');
            if (recurringToggle && frequencySelect) {
                recurringToggle.checked = t.recurring;
                toggleRecurringOptions();
                frequencySelect.value = t.frequency;
            }
            
            // Add subtasks
            modalSubtasks = t.subtasks.map(title => ({
                id: `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                title: title,
                completed: false
            }));
            renderModalSubtasks();
            
            templateSelect.value = '';
            showSuccessMessage(`üìã Template "${t.title}" applied!`);
        }


        
        // New finishRecurringTask function - completes recurring task without confirmation
        function finishRecurringTask(index) {
            const task = gameState.tasks[index];
            if (!task) return;
            
            if (!task.recurring) {
                showSuccessMessage('‚ö†Ô∏è This is not a recurring task!');
                return;
            }
            
            // Stop focus timer when any task is completed
            if (focusActive) {
                console.log('‚è±Ô∏è Focus Timer: Recurring task completed - stopping timer');
                stopFocusTimer(false);
            }
            
            // Clear notifications for this task
            if (window.notificationManager) {
                window.notificationManager.clearTaskNotifications(index);
            }
            
            // Calculate points based on difficulty
            const pointsMap = { easy: 2, medium: 5, hard: 10 };
            const basePoints = task.points || pointsMap[task.difficulty] || 5;
            
            // Add XP
            addJerryXP(basePoints);
            
            // Track in habit tracker
            if (window.trackTaskCompletion) {
                window.trackTaskCompletion(task, false);
            }
            
            // Update habits display
            if (window.updateHabitsDisplay) {
                window.updateHabitsDisplay();
            }
            
            // UPDATE TASK IN PLACE instead of removing and recreating
            // This provides a smoother UX - the task card stays but updates
            
            // Calculate next due date
            const currentDueDate = new Date(task.dueDate);
            let nextDueDate = new Date(currentDueDate);
            
            if (task.recurringFrequency === 'custom' && task.customInterval && task.customUnit) {
                const interval = task.customInterval;
                const unit = task.customUnit;
                
                if (unit === 'days') {
                    nextDueDate.setDate(nextDueDate.getDate() + interval);
                } else if (unit === 'weeks') {
                    nextDueDate.setDate(nextDueDate.getDate() + (interval * 7));
                } else if (unit === 'months') {
                    nextDueDate.setMonth(nextDueDate.getMonth() + interval);
                }
            } else {
                switch (task.recurringFrequency) {
                    case 'daily':
                        nextDueDate.setDate(nextDueDate.getDate() + 1);
                        break;
                    case 'weekly':
                        nextDueDate.setDate(nextDueDate.getDate() + 7);
                        break;
                    case 'monthly':
                        nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                        break;
                }
            }
            
            // Update the task in place
            task.dueDate = nextDueDate.toISOString();
            task.recurringCompletionCount = (task.recurringCompletionCount || 0) + 1;
            
            // Reset all subtasks to incomplete for the next occurrence
            if (task.subtasks && task.subtasks.length > 0) {
                task.subtasks = task.subtasks.map((st, idx) => ({
                    id: 'subtask_' + Date.now() + '_' + idx + '_' + Math.random().toString(36).substr(2, 9),
                    title: st.title,
                    completed: false,
                    createdAt: new Date().toISOString()
                }));
                console.log('üîÑ Subtasks reset to incomplete for next occurrence');
            }
            
            console.log('üîÅ Recurring task updated in place. Next due:', nextDueDate.toLocaleDateString());
            console.log('üìä Completion count:', task.recurringCompletionCount);
            
            saveGameState();
            updateUI();
            updateTasksDisplay();
            
            // Force update subtasks display for the new occurrence
            if (window.subtasksManager && task.subtasks && task.subtasks.length > 0) {
                setTimeout(() => {
                    window.subtasksManager.updateCompletionButtons(task.id);
                }, 100);
            }
            
            // Play completion sound
            if (window.audioManager) {
                window.audioManager.playSound('questComplete', 0.7);
            }
            
            // Show success message with next due date
            const nextDateStr = nextDueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            showSuccessMessage('‚úÖ Task completed!', `+${basePoints} pts | Next: ${nextDateStr}`);
            
            // Fire confetti
            if (window.fireConfetti) {
                window.fireConfetti();
            }
        }
        
        // Function to permanently complete a recurring task (no next occurrence)
        function completeRecurringTaskPermanently(index) {
            const task = gameState.tasks[index];
            if (!task) return;
            
            if (!task.recurring) {
                showSuccessMessage('‚ö†Ô∏è This is not a recurring task!');
                return;
            }
            
            // Check if all subtasks are completed
            if (task.subtasks && task.subtasks.length > 0) {
                const allCompleted = task.subtasks.every(st => st.completed);
                if (!allCompleted) {
                    showSuccessMessage('‚ö†Ô∏è Please complete all subtasks first!');
                    return;
                }
            }
            
            // Confirm with user
            if (!confirm(`Are you sure you want to permanently finish this recurring task?\n\n"${task.title}"\n\nThis will complete it and stop all future occurrences.`)) {
                return;
            }
            
            // Stop focus timer when any task is completed
            if (focusActive) {
                console.log('‚è±Ô∏è Focus Timer: Recurring task permanently completed - stopping timer');
                stopFocusTimer(false);
                showSuccessMessage('‚è±Ô∏è Focus Timer stopped', 'Task completed!');
            }
            
            // Clear notifications for this task
            if (window.notificationManager) {
                window.notificationManager.clearTaskNotifications(index);
            }
            
            // Store old level for level up detection
            const oldLevel = gameState.level;
            
            // Track today's completions
            const today = new Date().toDateString();
            if (gameState.lastDayTracked !== today) {
                gameState.completedTasksToday = 0;
                gameState.lastDayTracked = today;
            }
            gameState.completedTasksToday++;
            
            // Update streak
            updateStreak();
            
            // Award 80 points for task completion
            let basePoints = 80;
            
            // Add points and health
            gameState.taskPoints += basePoints;
            const oldHealth = gameState.health;
            gameState.health = Math.min(100, gameState.health + 10);
            gameState.completedTasks++;
            
            // Refill battle gauges
            if (window.battleManager) {
                window.battleManager.attackGauge = Math.min(100, window.battleManager.attackGauge + 20);
                window.battleManager.defenseGauge = Math.min(100, window.battleManager.defenseGauge + 15);
                console.log(`‚öîÔ∏è Battle gauges refilled! Attack: ${window.battleManager.attackGauge}/100, Defense: ${window.battleManager.defenseGauge}/100`);
            }
            
            // Add XP
            let xpToAdd = Math.ceil(basePoints * 0.8);
            if (gameState.xpBoostActive) {
                xpToAdd *= 2;
                gameState.xpBoostActive = false;
                delete gameState.xpBoostExpiry;
                showSuccessMessage('‚≠ê XP Boost consumed! 2x XP earned!');
            }
            addJerryXP(xpToAdd);
            
            // Track achievement progress
            if (window.achievementTracker) {
                window.achievementTracker.trackTaskCompletion(task, false);
                window.achievementTracker.trackOnTimeTask(task);
            }
            
            // Track habit completion
            if (window.trackTaskCompletion) {
                window.trackTaskCompletion(task, false);
            }
            
            // Update habits display
            if (window.updateHabitsDisplay) {
                window.updateHabitsDisplay();
            }
            
            // Remove task permanently (no next occurrence)
            gameState.tasks.splice(index, 1);
            
            // Update daily challenge progress
            updateChallengeProgress(task, false);
            
            // Show completion message
            showSuccessMessage('üèÅ Recurring task finished!', `+${basePoints} points earned!`);
            
            saveGameState();
            checkAndUpdateEnergy();
            
            // Refresh background
            if (typeof window.refreshBackground === 'function') {
                window.refreshBackground();
            }
            
            updateUI();
            updateTasksDisplay();
            updateQuickTasksDisplay();
            
            // Play completion sound
            if (window.audioManager) {
                window.audioManager.playSound('taskComplete', 0.7);
            }
            
            // Fire confetti
            if (window.fireConfetti) {
                window.fireConfetti();
            }
        }

        function addQuickTask(taskId, categoryKey) {
            const category = quickTasksDatabase[categoryKey];
            const task = category.tasks.find(t => t.id === taskId);
            
            if (!task) return;
            
            // Check if task already exists
            const exists = gameState.selectedQuickTasks.some(t => t.id === taskId);
            if (exists) {
                showSuccessMessage('Task already added!');
                return;
            }
            
            // Add task with category info
            const quickTask = {
                ...task,
                categoryId: categoryKey,
                categoryName: category.name,
                categoryEmoji: category.emoji
            };
            
            gameState.selectedQuickTasks.push(quickTask);
            gameState.totalTasksCreated += 1;
            
            // Track start time for quick task achievement
            if (window.achievementTracker) {
                window.achievementTracker.trackQuickTaskStart(taskId);
            }
            
            saveGameState();
            updateUI();
            updateQuickTasksDisplay();
            closeQuickTaskModal();
            showSuccessMessage(`Added "${task.title}" to quick tasks!`);
        }

        function completeQuickTask(taskId) {
            const taskIndex = gameState.selectedQuickTasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            const task = gameState.selectedQuickTasks[taskIndex];
            
            // Stop focus timer when any task is completed
            if (focusActive) {
                console.log('‚è±Ô∏è Focus Timer: Quick task completed - stopping timer');
                stopFocusTimer(false);
            }
            
            // Track today's completions
            const today = new Date().toDateString();
            if (gameState.lastDayTracked !== today) {
                gameState.completedTasksToday = 0;
                gameState.lastDayTracked = today;
            }
            gameState.completedTasksToday++;
            
            // Update streak (for tracking only, no multiplier)
            updateStreak();
            
            // Calculate points (no multiplier)
            const basePoints = task.points || 3;
            
            // Add points and health
            gameState.taskPoints += basePoints;
            const oldHealth = gameState.health;
            gameState.health = Math.min(100, gameState.health + 10);
            gameState.completedTasks++;
            
            // Check for egg re-hatching (when HP reaches 50)
            // CRITICAL: Only apply to reverted eggs (level 5+), NOT new eggs (level 1-4)
            if (gameState.isEgg && gameState.jerryLevel >= 5 && oldHealth < 50 && gameState.health >= 50) {
                gameState.isEgg = false;
                console.log('[Re-hatching] Egg hatched after reaching 50 HP!');
                
                // SKIN SYNC FIX: Check if skin is equipped before loading default sprite
                const equippedSkinId = gameState.equippedSkinId;
                
                if (!equippedSkinId) {
                    // No skin equipped, update sprite to show default monster
                    const savedMonster = localStorage.getItem('selectedMonster');
                    const spritePrefix = localStorage.getItem('heroSpritePrefix') || 'Pink_Monster';
                    
                    const mainHeroSprite = document.getElementById('mainHeroSprite');
                    if (mainHeroSprite) {
                        mainHeroSprite.src = `assets/heroes/${spritePrefix}_Idle_4.png`;
                        mainHeroSprite.classList.remove('egg-sprite');
                        // CRITICAL: Reset inline styles that were set for egg display
                        mainHeroSprite.style.animation = 'none';
                        mainHeroSprite.style.objectFit = 'none';
                        mainHeroSprite.style.objectPosition = '0 0';
                        mainHeroSprite.style.width = '32px';
                        mainHeroSprite.style.height = '32px';
                        mainHeroSprite.style.maxWidth = '';
                        mainHeroSprite.style.maxHeight = '';
                        mainHeroSprite.style.transform = 'scale(4)';
                        console.log('[Hatching] Applied sprite animation styles to mainHeroSprite');
                    }
                } else {
                    // Skin is equipped, let skinsManager handle it
                    console.log('[Hatching] Skin equipped:', equippedSkinId, '- triggering skinsManager update');
                    if (window.skinsManager) {
                        window.skinsManager.updateAllMonsterVisuals();
                    }
                }
                
                const heroSprite = document.getElementById('heroSprite');
                if (heroSprite) {
                    heroSprite.src = `assets/heroes/${spritePrefix}_Idle_4.png`;
                    heroSprite.classList.remove('egg-sprite');
                    // CRITICAL: Reset inline styles for heroSprite too
                    heroSprite.style.animation = 'none';
                    heroSprite.style.objectFit = 'none';
                    heroSprite.style.objectPosition = '0 0';
                    heroSprite.style.width = '32px';
                    heroSprite.style.height = '32px';
                    heroSprite.style.maxWidth = '';
                    heroSprite.style.maxHeight = '';
                    heroSprite.style.transform = 'scale(4)';
                }
                
                // Show re-hatching message
                setTimeout(() => {
                    showSuccessMessage('ü•ö Hatched Again!', `${gameState.rockName} is back!`);
                    if (window.fireConfetti) {
                        window.fireConfetti();
                    }
                }, 500);
            }
            
            // Refill battle gauges when completing tasks
            if (window.battleManager) {
                // Refill 20 points to attack gauge (max 100)
                window.battleManager.attackGauge = Math.min(100, window.battleManager.attackGauge + 20);
                // Refill 15 points to defense gauge (max 100)
                window.battleManager.defenseGauge = Math.min(100, window.battleManager.defenseGauge + 15);
                console.log(`‚öîÔ∏è Battle gauges refilled! Attack: ${window.battleManager.attackGauge}/100, Defense: ${window.battleManager.defenseGauge}/100`);
            }
            
            // Add XP (with boost if active)
            // Base conversion: 10 XP points = 8 XP Coins (0.8 ratio, rounded up)
            let xpToAdd = Math.ceil(basePoints * 0.8);
            if (gameState.xpBoostActive) {
                xpToAdd *= 2;
                gameState.xpBoostActive = false;  // Consume boost
                delete gameState.xpBoostExpiry;
                showSuccessMessage('‚≠ê XP Boost consumed! 2x XP earned!');
            }
            addJerryXP(xpToAdd);
            
            // Show completion message with random variation
            const randomMsg = getRandomCompletionMessage(true);
            showSuccessMessage(`${randomMsg.emoji} ${randomMsg.message}`, `+${basePoints} points earned!`);
            
            // Track completed quick task
            if (!gameState.completedQuickTasks) {
                gameState.completedQuickTasks = [];
            }
            gameState.completedQuickTasks.push({
                ...task,
                completedAt: new Date().toISOString()
            });
            
            // Track achievement progress
            if (window.achievementTracker) {
                window.achievementTracker.trackQuickTaskComplete(taskId);
                window.achievementTracker.trackTaskCompletion(task, true);
            }
            
            // Track habit completion
            if (window.trackTaskCompletion) {
                window.trackTaskCompletion(task, true);
            }
            
            // Update habits display
            if (window.updateHabitsDisplay) {
                window.updateHabitsDisplay();
            }
            
            // Remove task from pending
            gameState.selectedQuickTasks.splice(taskIndex, 1);
            
            // Update daily challenge progress
            updateChallengeProgress(task, true);
            
            saveGameState();
            
            // Check energy after completing task (should increase since task is done)
            checkAndUpdateEnergy();
            
            // Refresh background to preserve custom theme
            console.log('[Theme Debug] Active theme before refresh:', gameState.activeTheme);
            if (typeof window.refreshBackground === 'function') {
                window.refreshBackground();
                console.log('[Theme Debug] refreshBackground called after task completion');
            }
            
            updateUI();
            updateTasksDisplay();
            updateQuickTasksDisplay();
            
            // Play task completion sound
            if (window.audioManager) {
                window.audioManager.playSound('taskComplete', 0.7);
            }
            
            // Fire confetti
            console.log('‚ö° Quick task completed, firing confetti...');
            if (window.fireConfetti) {
                window.fireConfetti();
            } else {
                console.warn('Confetti function not available');
            }
            
            // Trigger battle with 20% probability for quick tasks
            setTimeout(() => {
                let battleTriggered = false;
                if (typeof window.maybeTriggerBattle === 'function') {
                    battleTriggered = window.maybeTriggerBattle('quickTask', { taskId: taskId });
                } else {
                    console.warn('Battle trigger system not loaded yet');
                }
                
                // Only trigger quest giver if battle did NOT start
                if (!battleTriggered) {
                    setTimeout(() => {
                        if (typeof window.triggerMerlinQuestFromTaskCompletion === 'function') {
                            window.triggerMerlinQuestFromTaskCompletion();
                        } else {
                            console.warn('Quest giver trigger system not loaded yet');
                        }
                    }, 3000); // Wait 3 seconds after no battle
                }
            }, 2000); // Wait 2 seconds after confetti
        }

        function removeQuickTask(taskId) {
            const taskIndex = gameState.selectedQuickTasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                gameState.selectedQuickTasks.splice(taskIndex, 1);
                saveGameState();
                updateUI();
                updateQuickTasksDisplay();
                showSuccessMessage('Quick task removed!');
            }
        }

        // Streak system
        function updateStreak() {
            const today = new Date().toDateString();
            const lastCompletion = gameState.lastCompletionDate;
            
            if (!lastCompletion) {
                gameState.currentStreak = 1;
                gameState.lastCompletionDate = today;
            } else if (lastCompletion === today) {
                return;
            } else {
                const lastDate = new Date(lastCompletion);
                const todayDate = new Date(today);
                const daysDiff = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff === 1) {
                    gameState.currentStreak++;
                    gameState.lastCompletionDate = today;
                } else {
                    gameState.currentStreak = 1;
                    gameState.lastCompletionDate = today;
                }
            }
            
            if (gameState.currentStreak > gameState.bestStreak) {
                gameState.bestStreak = gameState.currentStreak;
            }
            
            updateStreakMultiplier();
        }

        function updateStreakMultiplier() {
            // Streak multiplier disabled - always 1x
            gameState.streakMultiplier = 1;
        }

        function addJerryXP(xp) {
            // Add to both XP Coins (persistent currency) and Current XP (level progress)
            gameState.jerryXP += xp;
            gameState.jerryCurrentXP = (gameState.jerryCurrentXP || 0) + xp;
            
            // Check for level ups
            let leveledUp = false;
            while (gameState.jerryCurrentXP >= gameState.jerryXPToNext) {
                levelUpJerry();
                leveledUp = true;
            }
            
            // Refresh shop display to update affordability
            if (typeof updateShopDisplay === 'function') {
                updateShopDisplay();
            }
            
            // Update UI to reflect new XP
            if (!leveledUp) {
                updateUI();
            }
            saveGameState();
        }

        function levelUpJerry() {
            // Deduct from Current XP (level progress), but keep XP Coins (jerryXP) intact
            gameState.jerryCurrentXP -= gameState.jerryXPToNext;
            gameState.jerryLevel++;
            
            // Calculate next level threshold with exponential curve
            gameState.jerryXPToNext = Math.floor(100 * Math.pow(1.2, gameState.jerryLevel - 1));
            
            console.log(`üéâ Level Up! Level ${gameState.jerryLevel}, Next threshold: ${gameState.jerryXPToNext}`);
            console.log(`XP Coins: ${gameState.jerryXP}, Current XP: ${gameState.jerryCurrentXP}`);
            
            // Full heal on level up (scaled to new maxHP based on level)
            const baseHP = 100;
            const hpPerLevel = 10;
            const newMaxHP = baseHP + (gameState.jerryLevel * hpPerLevel);
            gameState.health = newMaxHP;
            
            console.log(`üìä Level up! HP fully restored to ${newMaxHP} (Level ${gameState.jerryLevel})`);
            
            // Check if egg should hatch at Level 5
            if (gameState.jerryLevel === 5 && gameState.isEgg) {
                gameState.isEgg = false;
                console.log('[Hatching] Monster hatched at Level 5!');
                
                // CRITICAL: Enable battle mode when egg hatches
                window.battleModeEnabled = true;
                localStorage.setItem('battleModeEnabled', 'true');
                console.log('[Hatching] Battle Mode ENABLED!');
                
                // Play victory sound for hatching celebration
                if (window.audioManager && window.audioManager.playBattleWinMusic) {
                    window.audioManager.playBattleWinMusic();
                    console.log('[Hatching] Playing victory sound!');
                }
                
                // Fire confetti for celebration
                if (window.fireConfetti) {
                    window.fireConfetti();
                    // Fire confetti multiple times for extra celebration
                    setTimeout(() => window.fireConfetti && window.fireConfetti(), 500);
                    setTimeout(() => window.fireConfetti && window.fireConfetti(), 1000);
                }
                
                // Show celebratory hatching modal
                showHatchingCelebrationModal(gameState.rockName, gameState.jerryLevel);
                
                // SKIN SYNC FIX: Check if skin is equipped before loading default sprite
                const equippedSkinId = gameState.equippedSkinId;
                
                if (!equippedSkinId) {
                    // No skin equipped, update sprite to show default monster
                    const savedMonster = localStorage.getItem('selectedMonster');
                    const spritePrefix = localStorage.getItem('heroSpritePrefix') || 'Pink_Monster';
                    
                    const mainHeroSprite = document.getElementById('mainHeroSprite');
                    if (mainHeroSprite) {
                        mainHeroSprite.src = `assets/heroes/${spritePrefix}_Idle_4.png`;
                        mainHeroSprite.classList.remove('egg-sprite');
                        // CRITICAL: Reset inline styles that were set for egg display
                        mainHeroSprite.style.animation = 'none';
                        mainHeroSprite.style.objectFit = 'none';
                        mainHeroSprite.style.objectPosition = '0 0';
                        mainHeroSprite.style.width = '32px';
                        mainHeroSprite.style.height = '32px';
                        mainHeroSprite.style.maxWidth = '';
                        mainHeroSprite.style.maxHeight = '';
                        mainHeroSprite.style.transform = 'scale(4)';
                        console.log('[Hatching] Applied sprite animation styles to mainHeroSprite');
                    }
                } else {
                    // Skin is equipped, let skinsManager handle it
                    console.log('[Hatching] Skin equipped:', equippedSkinId, '- triggering skinsManager update');
                    if (window.skinsManager) {
                        window.skinsManager.updateAllMonsterVisuals();
                    }
                }
                
                const heroSprite = document.getElementById('heroSprite');
                if (heroSprite) {
                    heroSprite.src = `assets/heroes/${spritePrefix}_Idle_4.png`;
                    heroSprite.classList.remove('egg-sprite');
                    // CRITICAL: Reset inline styles for heroSprite too
                    heroSprite.style.animation = 'none';
                    heroSprite.style.objectFit = 'none';
                    heroSprite.style.objectPosition = '0 0';
                    heroSprite.style.width = '32px';
                    heroSprite.style.height = '32px';
                    heroSprite.style.maxWidth = '';
                    heroSprite.style.maxHeight = '';
                    heroSprite.style.transform = 'scale(4)';
                }
            } else {
                // Show rainbow gradient level-up banner for all level ups
                showRainbowLevelUpBanner(gameState.jerryLevel);
            }
            
            if (window.fireConfetti) {
                window.fireConfetti();
            }
            
            // Trigger level up dialogue
            if (typeof MoodDialogueSystem !== 'undefined' && MoodDialogueSystem.showDialogue) {
                setTimeout(() => {
                    MoodDialogueSystem.showDialogue('level_up');
                }, 2000);
            }
            
            updateUI();
            saveGameState();
        }

        // Duplicate buyItem function removed - consolidated into single function above



        // Smooth scroll to pet rock function
        function scrollToPetRock() {
            const petRockHeader = document.querySelector('.pet-rock-header');
            if (petRockHeader) {
                petRockHeader.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }
        }

        // Settings functions
        function toggleDarkMode() {
            gameState.darkMode = !gameState.darkMode;
            
            if (gameState.darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            
            saveGameState();
            updateSettingsDisplay();
        }

        async function toggleNotifications() {
            gameState.notifications = !gameState.notifications;
            
            if (gameState.notifications) {
                // Request permission when enabling
                if (window.notificationManager) {
                    const granted = await window.notificationManager.requestPermission();
                    if (!granted) {
                        gameState.notifications = false;
                        showSuccessMessage('Notification permission denied. Please enable in browser settings.');
                        saveGameState();
                        updateSettingsDisplay();
                        return;
                    }
                    // Reschedule all notifications
                    window.notificationManager.rescheduleAllNotifications();
                }
            } else {
                // Clear all notifications when disabling
                if (window.notificationManager) {
                    window.notificationManager.clearAllNotifications();
                }
            }
            
            saveGameState();
            updateSettingsDisplay();
            showSuccessMessage(`Notifications ${gameState.notifications ? 'enabled' : 'disabled'}!`);
        }

        function toggleBattleMode() {
            // Prevent enabling battle mode for eggs or players below Level 10
            if ((gameState.isEgg || gameState.jerryLevel < 10) && !window.battleModeEnabled) {
                showSuccessMessage('üîí Battle Mode Locked', 'Reach Level 10 to unlock battles!');
                return;
            }
            
            window.battleModeEnabled = !window.battleModeEnabled;
            localStorage.setItem('battleModeEnabled', window.battleModeEnabled);
            updateSettingsDisplay();
            showSuccessMessage(`Battle Mode ${window.battleModeEnabled ? 'enabled' : 'disabled'}!`);
        }

        async function shareEtsyStore() {
            const etsyUrl = 'https://www.etsy.com/shop/TaskRock';
            
            // Try Web Share API first (mobile-friendly)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Task Rock Etsy Store',
                        text: 'Check out Task Rock on Etsy!',
                        url: etsyUrl
                    });
                    console.log('‚úÖ Shared successfully');
                } catch (err) {
                    // User cancelled or error occurred
                    if (err.name !== 'AbortError') {
                        console.log('Share failed:', err);
                        fallbackCopyToClipboard(etsyUrl);
                    }
                }
            } else {
                // Fallback: Copy to clipboard
                fallbackCopyToClipboard(etsyUrl);
            }
        }

        function openProductivityOutlet() {
            const productivityOutletUrl = 'https://www.etsy.com/shop/ProductivityOutlet?ref=shop-header-name&listing_id=4429783505&from_page=listing&dd_referrer=';
            
            // Open store in new tab
            window.open(productivityOutletUrl, '_blank');
            console.log('‚úÖ Opening Productivity Outlet store');
        }
        
        function fallbackCopyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccessMessage('Etsy store link copied to clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
                showSuccessMessage('Visit: ' + text);
            });
        }

        function showResetOptions() {
            if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                // Clear all localStorage including onboarding
                localStorage.clear();
                location.reload();
            }
        }

        // Name editing is now handled via Settings modal

        // Tab navigation function
        function showTab(tabName) {
            // CRITICAL FIX: Stop all battle music when navigating away from battle
            if (window.audioManager && window.battleManager) {
                // If battle is not active, stop all battle-related music
                if (!window.battleManager.inBattle) {
                    window.audioManager.stopAllBattleMusic();
                    window.audioManager.stopBattleOutcomeMusic();
                    console.log('[Tab Navigation] Battle music stopped');
                }
            }
            
            // CRITICAL FIX: Auto-pause focus timer when navigating away from home tab
            if (tabName !== 'home' && typeof focusActive !== 'undefined' && focusActive && !focusPaused) {
                console.log('‚è±Ô∏è Focus Timer: Navigating away from home - auto-pausing timer');
                pauseFocusTimer();
                window.focusTimerAutoPausedByNav = true;
            }
            // Auto-resume if returning to home and was auto-paused by navigation
            if (tabName === 'home' && window.focusTimerAutoPausedByNav && focusPaused) {
                console.log('‚è±Ô∏è Focus Timer: Returning to home - auto-resuming timer');
                resumeFocusTimer();
                window.focusTimerAutoPausedByNav = false;
            }
            
            // Hide all sections
            const sections = ['home', 'achievements', 'rockshop', 'settings', 'habits'];
            sections.forEach(section => {
                const element = document.querySelector(`[data-tab="${section}"]`);
                if (element) {
                    element.style.display = 'none';
                }
            });
            
            // Show selected section
            const selectedSection = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedSection) {
                selectedSection.style.display = 'block';
            }
            
            // Update tab buttons
            document.querySelectorAll('.pill-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // Refresh shop display when opening shop tab to show current XP
            if (tabName === 'rockshop' && typeof updateShopDisplay === 'function') {
                updateShopDisplay();
            }
            
            // Initialize mood history filters when opening habits tab
            if (tabName === 'habits') {
                console.log('[Tabs] Opening habits tab - initializing mood filters');
                if (typeof window.initHabitMoodFilters === 'function') {
                    window.initHabitMoodFilters();
                } else {
                    console.warn('[Tabs] initHabitMoodFilters not found');
                }
            }
        }



        // Success message
        // Get random completion message
        function getRandomCompletionMessage(isQuickTask = false) {
            const quickTaskMessages = [
                { emoji: '‚ö°', message: 'Lightning fast!', subtitle: 'Quick task crushed!' },
                { emoji: 'üöÄ', message: 'Boom! Done!', subtitle: 'Quick task completed!' },
                { emoji: 'üí®', message: 'Speed demon!', subtitle: 'That was quick!' },
                { emoji: '‚ú®', message: 'Nailed it!', subtitle: 'Quick win secured!' },
                { emoji: 'üî•', message: 'On fire!', subtitle: 'Quick task done!' },
                { emoji: 'üí™', message: 'Crushing it!', subtitle: 'Quick task finished!' },
                { emoji: 'üéØ', message: 'Bullseye!', subtitle: 'Quick task complete!' },
                { emoji: '‚≠ê', message: 'Star performance!', subtitle: 'Quick task knocked out!' },
                { emoji: 'üåü', message: 'Brilliant!', subtitle: 'Quick task accomplished!' },
                { emoji: 'üí´', message: 'Stellar work!', subtitle: 'Quick task wrapped up!' },
                { emoji: 'üéä', message: 'Fantastic!', subtitle: 'Quick task conquered!' },
                { emoji: 'üèÜ', message: 'Champion move!', subtitle: 'Quick task demolished!' },
                { emoji: 'üí•', message: 'Pow!', subtitle: 'Quick task obliterated!' },
                { emoji: 'üé™', message: 'Show stopper!', subtitle: 'Quick task handled!' },
                { emoji: 'üåà', message: 'Amazing!', subtitle: 'Quick task mastered!' }
            ];
            
            const regularTaskMessages = [
                { emoji: 'üéâ', message: 'Task completed!', subtitle: 'Great work!' },
                { emoji: '‚úÖ', message: 'Mission accomplished!', subtitle: 'Task done!' },
                { emoji: 'üèÜ', message: 'Victory!', subtitle: 'Task conquered!' },
                { emoji: 'üí™', message: 'Crushed it!', subtitle: 'Task finished!' },
                { emoji: 'üåü', message: 'Outstanding!', subtitle: 'Task complete!' },
                { emoji: 'üéØ', message: 'Target hit!', subtitle: 'Task achieved!' },
                { emoji: 'üöÄ', message: 'Launched to success!', subtitle: 'Task accomplished!' },
                { emoji: '‚≠ê', message: 'Superb!', subtitle: 'Task wrapped up!' },
                { emoji: 'üí´', message: 'Excellent work!', subtitle: 'Task finished!' },
                { emoji: 'üî•', message: 'Blazing through!', subtitle: 'Task demolished!' },
                { emoji: '‚ú®', message: 'Magnificent!', subtitle: 'Task completed!' },
                { emoji: 'üéä', message: 'Celebration time!', subtitle: 'Task done!' },
                { emoji: 'üåà', message: 'Wonderful!', subtitle: 'Task nailed!' },
                { emoji: 'üí•', message: 'Boom!', subtitle: 'Task crushed!' },
                { emoji: 'üé™', message: 'Spectacular!', subtitle: 'Task mastered!' },
                { emoji: 'üèÖ', message: 'Medal worthy!', subtitle: 'Task completed!' },
                { emoji: 'üéñÔ∏è', message: 'Heroic effort!', subtitle: 'Task conquered!' },
                { emoji: 'üëè', message: 'Bravo!', subtitle: 'Task accomplished!' },
                { emoji: 'üôå', message: 'Hands up!', subtitle: 'Task finished!' },
                { emoji: 'üíØ', message: 'Perfect!', subtitle: 'Task done!' }
            ];
            
            const messages = isQuickTask ? quickTaskMessages : regularTaskMessages;
            return messages[Math.floor(Math.random() * messages.length)];
        }

        // Hatching Celebration Modal - Shows when egg hatches at Level 10
        function showHatchingCelebrationModal(monsterName, level) {
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'hatchingCelebrationModal';
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            
            // Get monster sprite for display
            const spritePrefix = localStorage.getItem('heroSpritePrefix') || 'Pink_Monster';
            const spriteSrc = `assets/heroes/${spritePrefix}_Idle_4.png`;
            
            modalOverlay.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
                    border-radius: 24px;
                    padding: 40px;
                    max-width: 400px;
                    width: 90%;
                    text-align: center;
                    box-shadow: 0 20px 60px rgba(124, 58, 237, 0.4), 0 0 100px rgba(124, 58, 237, 0.2);
                    border: 2px solid rgba(124, 58, 237, 0.5);
                    animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                ">
                    <div style="font-size: 64px; margin-bottom: 16px; animation: bounce 0.6s ease infinite;">üëæ</div>
                    
                    <h1 style="
                        font-size: 28px;
                        font-weight: 800;
                        color: #fff;
                        margin: 0 0 8px 0;
                        text-shadow: 0 2px 10px rgba(124, 58, 237, 0.5);
                    ">IT HATCHED!</h1>
                    
                    <p style="
                        font-size: 18px;
                        color: rgba(255, 255, 255, 0.9);
                        margin: 0 0 24px 0;
                    ">Your egg has finally hatched!</p>
                    
                    <div style="
                        width: 32px;
                        height: 32px;
                        margin: 0 auto 24px;
                        background-image: url('${spriteSrc}');
                        background-size: 128px 32px;
                        background-position: 0 0;
                        image-rendering: pixelated;
                        animation: spriteIdle 0.8s steps(4) infinite;
                        filter: drop-shadow(0 0 20px rgba(124, 58, 237, 0.8));
                        transform: scale(4);
                        transform-origin: center;
                    "></div>
                    
                    <h2 style="
                        font-size: 24px;
                        font-weight: 700;
                        color: #a78bfa;
                        margin: 60px 0 8px 0;
                    ">${monsterName}</h2>
                    
                    <p style="
                        font-size: 16px;
                        color: rgba(255, 255, 255, 0.7);
                        margin: 0 0 24px 0;
                    ">Level ${level} ‚Ä¢ Ready for Battle!</p>
                    
                    <div style="
                        background: rgba(124, 58, 237, 0.2);
                        border-radius: 12px;
                        padding: 16px;
                        margin-bottom: 24px;
                        border: 1px solid rgba(124, 58, 237, 0.3);
                    ">
                        <p style="
                            font-size: 14px;
                            color: rgba(255, 255, 255, 0.8);
                            margin: 0;
                            line-height: 1.5;
                        ">‚öîÔ∏è <strong>Battle Mode Unlocked!</strong><br>Complete tasks to trigger epic battles!</p>
                    </div>
                    
                    <button id="hatchingContinueBtn" style="
                        background: linear-gradient(135deg, #7C3AED 0%, #5B21B6 100%);
                        color: white;
                        border: none;
                        padding: 16px 48px;
                        font-size: 18px;
                        font-weight: 700;
                        border-radius: 12px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
                    ">Continue Adventure!</button>
                </div>
            `;
            
            // Add animation keyframes if not already present
            if (!document.getElementById('hatchingAnimations')) {
                const style = document.createElement('style');
                style.id = 'hatchingAnimations';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes scaleIn {
                        from { transform: scale(0.8); opacity: 0; }
                        to { transform: scale(1); opacity: 1; }
                    }
                    @keyframes bounce {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-10px); }
                    }
                    @keyframes spriteIdle {
                        from { background-position: 0 0; }
                        to { background-position: -128px 0; }
                    }
                    @keyframes glow {
                        0%, 100% { filter: drop-shadow(0 0 20px rgba(124, 58, 237, 0.8)); }
                        50% { filter: drop-shadow(0 0 40px rgba(124, 58, 237, 1)); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(modalOverlay);
            
            // Add button hover effect and click handler
            const continueBtn = document.getElementById('hatchingContinueBtn');
            continueBtn.addEventListener('mouseover', () => {
                continueBtn.style.transform = 'translateY(-2px)';
                continueBtn.style.boxShadow = '0 6px 20px rgba(124, 58, 237, 0.6)';
            });
            continueBtn.addEventListener('mouseout', () => {
                continueBtn.style.transform = 'translateY(0)';
                continueBtn.style.boxShadow = '0 4px 15px rgba(124, 58, 237, 0.4)';
            });
            continueBtn.addEventListener('click', () => {
                // Stop victory music when closing modal
                if (window.audioManager && window.audioManager.stopBattleOutcomeMusic) {
                    window.audioManager.stopBattleOutcomeMusic();
                }
                modalOverlay.style.animation = 'fadeIn 0.3s ease reverse';
                setTimeout(() => modalOverlay.remove(), 300);
            });
            
            console.log('[Hatching] Celebration modal displayed!');
        }

        function showSuccessMessage(message, subtitle = '') {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            
            // Extract emoji from message if present
            const emojiMatch = message.match(/^([\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}])\s*/u);
            let emoji = 'üéâ';
            let mainMessage = message;
            
            if (emojiMatch) {
                emoji = emojiMatch[1];
                mainMessage = message.replace(emojiMatch[0], '').trim();
            }
            
            successDiv.innerHTML = `
                <div class="success-message-emoji">${emoji}</div>
                <div class="success-message-content">
                    <div class="success-message-title">${mainMessage}</div>
                    ${subtitle ? `<div class="success-message-subtitle">${subtitle}</div>` : ''}
                </div>
            `;
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Confetti system
        function initializeConfetti() {
            const canvas = document.getElementById("confetti-canvas");
            const ctx = canvas.getContext("2d");
            let particles = [];
            let animationFrame;

            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            window.addEventListener("resize", resize);
            resize();

            function createParticle(x, y) {
                return {
                    x,
                    y,
                    dx: Math.random() * 6 - 3,
                    dy: Math.random() * -5 - 2,
                    size: Math.random() * 6 + 4,
                    color: `hsl(${Math.random() * 360}, 80%, 60%)`,
                    life: 100
                };
            }

            function render() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach((p, i) => {
                    p.x += p.dx;
                    p.y += p.dy;
                    p.dy += 0.1;
                    p.life--;

                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, p.size, p.size);

                    if (p.life <= 0) particles.splice(i, 1);
                });
                if (particles.length > 0) {
                    animationFrame = requestAnimationFrame(render);
                } else {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    if (animationFrame) {
                        cancelAnimationFrame(animationFrame);
                        animationFrame = null;
                    }
                }
            }

            window.fireConfetti = function() {
                console.log('üéâ Confetti fired! Particles before:', particles.length);
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                
                for (let i = 0; i < 50; i++) {
                    particles.push(createParticle(
                        centerX + (Math.random() - 0.5) * 100,
                        centerY + (Math.random() - 0.5) * 100
                    ));
                }
                
                console.log('üéâ Confetti particles after:', particles.length);
                
                // Always start animation, even if one is already running
                if (!animationFrame) {
                    console.log('üéâ Starting new confetti animation');
                    render();
                } else {
                    console.log('üéâ Animation already running, particles added');
                }
            };
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const createModal = document.getElementById('createTaskModal');
            const quickModal = document.getElementById('quickTaskModal');
            const changeNameModal = document.getElementById('changeNameModal');
            
            if (event.target === createModal) {
                closeModal();
            }
            if (event.target === quickModal) {
                closeQuickTaskModal();
            }
            if (event.target === changeNameModal) {
                closeChangeNameModal();
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // RESET LOGIC: Check if this is a fresh install
            // If no onboardingCompleted flag exists, clear all localStorage to ensure clean start
            const hasCompletedOnboarding = localStorage.getItem('onboardingCompleted');
            if (!hasCompletedOnboarding) {
                // Clear all app-related localStorage keys
                const keysToKeep = []; // No keys to keep on first load
                const allKeys = Object.keys(localStorage);
                allKeys.forEach(key => {
                    if (key.startsWith('task') || key.startsWith('jerry') || key.startsWith('monster') || 
                        key.startsWith('hero') || key.startsWith('selected') || key.startsWith('owned') || 
                        key.startsWith('active') || key.startsWith('battle') || key.startsWith('tutorial')) {
                        localStorage.removeItem(key);
                    }
                });
                console.log('[AppReset] Fresh install detected - localStorage cleared');
            }
            
            try {
                // Use the app initializer for proper sequencing
                if (window.appInitializer) {
                    window.appInitializer.initialize();
                } else {
                    console.error('[AppInit] App initializer not loaded - using fallback');
                    // Fallback to basic initialization
                    loadGameState();
                    document.documentElement.style.visibility = 'visible';
                    generateDailyChallenge();
                }
                
                // Initialize selectedQuickTasks if it doesn't exist
                if (!gameState.selectedQuickTasks) {
                    gameState.selectedQuickTasks = [];
                }
                
                // Apply dark mode if enabled
                if (gameState.darkMode) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
                
                // Initialize Battle Mode preference
                // Battle Mode is DISABLED until Level 5 (when egg hatches)
                const storedBattleMode = localStorage.getItem('battleModeEnabled');
                const playerLevel = gameState.jerryLevel || 1;
                const isEgg = gameState.isEgg === true;
                
                if (playerLevel < 5 || isEgg) {
                    // Force OFF for players below Level 5 or with eggs
                    window.battleModeEnabled = false;
                    localStorage.setItem('battleModeEnabled', 'false');
                    console.log('üîí Battle Mode disabled - player below Level 10 or has egg');
                } else if (storedBattleMode === null) {
                    // Default ON for Level 10+ players without stored preference
                    window.battleModeEnabled = true;
                    localStorage.setItem('battleModeEnabled', 'true');
                } else {
                    window.battleModeEnabled = storedBattleMode === 'true';
                }

                // Initialize audio manager
                if (window.audioManager) {
                    window.audioManager.loadAllSounds().then(() => {
                        console.log('üîä Audio system initialized');
                    }).catch(err => {
                        console.warn('Audio loading failed:', err);
                    });
                }
                
                // Initialize confetti system
                initializeConfetti();
                
                // Initialize shop display
                updateShopDisplay();
                
                // Update battle button counts after loading game state
                if (typeof updateBattleButtonsVisibility === 'function') {
                    updateBattleButtonsVisibility();
                }
                
                // Initialize the complete app with dialogue system
                initializeApp();
                
                // CRITICAL FIX: Instantiate subtasksManager
                if (typeof SubtasksManager !== 'undefined') {
                    window.subtasksManager = new SubtasksManager();
                    console.log('[Init] subtasksManager instantiated');
                } else {
                    console.error('[Init] SubtasksManager class not found!');
                }
                
                // Reschedule notifications for all tasks on app load
                if (window.notificationManager && gameState.notifications) {
                    setTimeout(() => {
                        window.notificationManager.rescheduleAllNotifications();
                    }, 1500);
                }
                
                // Ensure sprite is loaded after initialization
                setTimeout(() => {
                    // CRITICAL: Check if monster is in egg form first
                    const selectedMonster = localStorage.getItem('selectedMonster');
                    if (gameState.isEgg && selectedMonster) {
                        // Load egg GIF, don't overwrite with monster sprite
                        const mainHeroSprite = document.getElementById('mainHeroSprite');
                        if (mainHeroSprite) {
                            mainHeroSprite.src = `assets/eggs/${selectedMonster}_egg.gif`;
                            mainHeroSprite.classList.add('egg-sprite');
                            // CRITICAL: Clear inline styles that override CSS class
                            mainHeroSprite.style.animation = 'none';
                            mainHeroSprite.style.objectFit = 'contain';
                            mainHeroSprite.style.objectPosition = 'center';
                            mainHeroSprite.style.width = 'auto';
                            mainHeroSprite.style.height = 'auto';
                            mainHeroSprite.style.maxWidth = '100%';
                            mainHeroSprite.style.maxHeight = '100%';
                            mainHeroSprite.style.transform = 'scale(2)';
                            mainHeroSprite.style.opacity = '1';
                            console.log('[Init] Egg sprite loaded for:', selectedMonster);
                        }
                    } else {
                        // SKIN SYNC FIX: Check if skin is equipped before loading default sprite
                        const spritePrefix = localStorage.getItem('heroSpritePrefix');
                        const equippedSkinId = gameState.equippedSkinId;
                        
                        if (spritePrefix && !equippedSkinId) {
                            // No skin equipped, load default monster sprite
                            console.log('[Init] No skin equipped, loading default monster sprite');
                            const mainHeroSprite = document.getElementById('mainHeroSprite');
                            if (mainHeroSprite) {
                                // Use GIF for idle animation
                                mainHeroSprite.src = `assets/heroes/${spritePrefix}_idle.gif`;
                                mainHeroSprite.classList.remove('egg-sprite');
                                // CRITICAL: Reset ALL styles to ensure fluid GIF display
                                mainHeroSprite.style.width = '32px';
                                mainHeroSprite.style.height = '32px';
                                mainHeroSprite.style.objectFit = 'contain';
                                mainHeroSprite.style.objectPosition = 'center';
                                mainHeroSprite.style.transform = 'scale(4)';
                                mainHeroSprite.style.animation = 'none';
                                mainHeroSprite.style.imageRendering = 'pixelated';
                                mainHeroSprite.style.opacity = '1';
                                // Force reflow to ensure styles are applied immediately
                                void mainHeroSprite.offsetHeight;
                                console.log('[Init] Applied GIF animation styles to mainHeroSprite');
                            }
                        } else if (equippedSkinId) {
                            // SKIN SYNC FIX: Skin is equipped, skinsManager will handle it
                            console.log('[Init] Skin equipped:', equippedSkinId, '- skinsManager will apply it');
                            const mainHeroSprite = document.getElementById('mainHeroSprite');
                            if (mainHeroSprite) {
                                mainHeroSprite.style.opacity = '1';
                                // Force reflow to ensure skin loads properly
                                void mainHeroSprite.offsetHeight;
                            }
                        } else {
                            const mainHeroSprite = document.getElementById('mainHeroSprite');
                            if (mainHeroSprite) {
                                mainHeroSprite.style.opacity = '1';
                                void mainHeroSprite.offsetHeight;
                            }
                        }
                    }
                }, 100);
            } catch (error) {
                console.error('Initialization error:', error);
            }
            
            // Always hide loading screen regardless of errors
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                }
            }, 3000);
        });





        // --- Tooltip Function ---
        function showTooltip(message) {
          const tooltip = document.getElementById('taskPalTooltip');
          if (!tooltip) return;
          tooltip.textContent = message;
          tooltip.classList.add('visible');
          clearTimeout(window.tooltipTimer);
          window.tooltipTimer = setTimeout(() => {
            tooltip.classList.remove('visible');
          }, 50000); // 50 seconds
        }

        // Mood tracker code removed - will be rebuilt from scratch
</script>


    <!-- Task Monsters Game Modules -->
    <!-- <script type="module" src="js/main.js"></script> --> <!-- Removed: Not part of Task Monsters, causes loading errors -->
    
    <!-- Game Message Display -->
    <div id="gameMessage" class="hidden"></div>
    
    
    <!-- Dark Theme CSS -->
    <link rel="stylesheet" href="css/dark-theme.css?v=2">
    
    <!-- Battle System CSS -->
    <link rel="stylesheet" href="css/battle.css?v=2">
    
    <!-- Human Skins CSS -->
    <link rel="stylesheet" href="css/human-skins.css">
    
    <!-- Quest Giver CSS -->
    <link rel="stylesheet" href="css/questGiver.css?v=1">
    
    <!-- Quest Tasks CSS -->    <link rel="stylesheet" href="css/questTasks.css">
    
    <!-- Guardian of Task World CSS -->
    <link rel="stylesheet" href="css/guardian.css">
    
    <!-- Shop Reference Design CSS -->
    <link rel="stylesheet" href="css/shop-reference-design.css?v=6">    
    <!-- App Initializer - Manages onboarding and quest giver flows -->
    <script src="js/appInitializer.js"></script>
    
    <!-- Background Manager for time-based backgrounds -->
    <script src="js/backgroundManager.js"></script>
    <script src="js/themeManager.js?v=2"></script>
    
    <!-- Audio Manager -->
    <script src="js/audioManager.js"></script>
    
    <!-- Skins System -->
    <script src="js/skinsConfig.js?v=3"></script>
    <script src="js/skinsManager.js?v=3"></script>
    
    <!-- Battle System Modules -->
    <!-- New Battle System (v2) -->
    <script src="js/battleEffects.js?v=1768715883"></script>
    <script src="js/battleEngine.js?v=1768715883"></script>
    <script src="js/battleSystemInit.js?v=1768715883"></script>
    <script src="js/battleUI.js?v=1768715883"></script>
    <script src="js/enemy-animations.js?v=1768715883"></script>
    <script src="js/battleHPAnimations.js?v=1768715883"></script>
    <script src="js/specialAttacks.js?v=1768715883"></script>
    <script src="js/enemy.js?v=1768715883"></script>
    <script src="js/lootSystem.js"></script>
    <script src="js/battleManager.js?v=1768715883"></script>
    <script src="js/battleTutorial.js?v=1768715883"></script>
    <script src="js/boss-enemies.js?v=1768715883"></script>
    <script src="js/battleInit.js?v=1768715883"></script>
    <script src="js/guardianNarrator.js"></script>
    <script src="js/guardian.js"></script>
    
    <!-- Removed missing script: js/battleInit.js -->
    <script src="js/questTaskManager.js"></script>
    <script src="js/questGiver.js?v=7"></script>

    <script src="js/subtasksManager.js"></script>
    <script src="js/simpleOnboarding.js"></script>
    <script src="js/nameEmailModal.js"></script>
    <script src="js/questGiverOnboarding.js"></script>
    <script src="js/moodFilter.js"></script>
    <script src="js/merlinModal.js"></script>
    <script src="js/notificationManager.js"></script>
    <script src="js/achievementTracker.js"></script>
    <script src="js/habitTracker.js"></script>
    <script src="js/habitTrackerUI.js"></script>
    <script src="js/rainbowLevelUpBanner.js"></script>
    
    <!-- Guardian Narrative System -->
    <script src="js/guardianNarrative.js"></script>
    <script src="js/guardianOnboarding.js"></script>
    <script src="js/taskWorldMap.js"></script>
    
    <!-- Mood Dialogue System - Must load before moodTracker -->
    <script src="js/moodDialogueSystem.js"></script>
    
    <!-- Mood Tracker - Standalone System -->
    <script src="js/moodTracker.js?v=1768748859"></script>
    
    <!-- Hide loading screen after page loads -->
    <script>
        window.addEventListener('load', function() {
            setTimeout(function() {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                }
                // Onboarding check is handled by checkOnboardingStatus() function
            }, 3000);
        });

// ========================================
// ONBOARDING SYSTEM
// ========================================

(function() {
    let selectedMonster = null;
    let monsterName = '';
    
    const monsters = {
        luna: {
            name: 'Luna',
            title: 'The Wise Night Owl',
            description: 'Perfect for night owls and deep thinkers. Luna helps you tackle complex tasks with wisdom and patience.',
            tags: ['Calm', 'Intelligent'],
            sprite: 'assets/heroes/Luna_idle.gif',
            eggSprite: 'assets/eggs/luna_egg.gif',
            suggestions: ['Luna', 'Sage', 'Wisdom', 'Nova', 'Athena', 'Echo']
        },
        benny: {
            name: 'Benny',
            title: 'The Gentle Giant',
            description: 'Strong and dependable. Benny helps you power through big projects with steady determination.',
            tags: ['Energetic', 'Loyal'],
            sprite: 'assets/heroes/Benny_idle.gif',
            eggSprite: 'assets/eggs/benny_egg.gif',
            suggestions: ['Benny', 'Titan', 'Boulder', 'Atlas', 'Rocky', 'Tank']
        },
        nova: {
            name: 'Nova',
            title: 'The Fiery Achiever',
            description: 'Energetic and ambitious. Nova motivates you to crush goals and achieve greatness at lightning speed.',
            tags: ['Curious', 'Optimistic'],
            sprite: 'assets/heroes/Nova_idle.gif',
            eggSprite: 'assets/eggs/nova_egg.gif',
            suggestions: ['Nova', 'Blaze', 'Jet', 'Aster', 'Rayne', 'Ember']
        }
    };
    
    function checkOnboardingStatus() {
        const hasChosen = localStorage.getItem('hasChosenMonster');
        console.log('Checking onboarding status. hasChosenMonster:', hasChosen);
        
        const overlay = document.getElementById('onboardingOverlay');
        
        if (!overlay) {
            console.error('Onboarding overlay not found!');
            return;
        }
        
        if (!hasChosen || hasChosen !== 'true') {
            console.log('Onboarding needed. Waiting for page load...');
            
            // Function to show onboarding
            const showOnboarding = () => {
                console.log('Attempting to show onboarding...');
                setTimeout(() => {
                    overlay.classList.remove('hidden');
                    console.log('Onboarding overlay displayed!');
                    console.log('Overlay classes:', overlay.className);
                }, 3100); // Wait for loading screen to finish (3000ms + 100ms buffer)
            };
            
            // Try multiple approaches to ensure it works
            if (document.readyState === 'complete') {
                console.log('Document already loaded, showing onboarding immediately');
                showOnboarding();
            } else {
                console.log('Waiting for window load event...');
                window.addEventListener('load', showOnboarding);
            }
        } else {
            console.log('User has already chosen a monster. Skipping onboarding.');
        }
    }
    
    function selectMonster(monsterId) {
        selectedMonster = monsterId;
        
        // Remove selected class from all cards
        document.querySelectorAll('.monster-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Add selected class to chosen card
        const card = document.getElementById(monsterId + 'Card');
        if (card) {
            card.classList.add('selected');
        }
        
        // Enable continue button
        const continueBtn = document.getElementById('continueButton');
        if (continueBtn) {
            continueBtn.disabled = false;
            continueBtn.textContent = 'Continue';
        }
    }
    
    function goToStep2() {
        if (!selectedMonster) return;
        
        const monster = monsters[selectedMonster];
        
        // Hide step 1, show step 2
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step2').classList.add('active');
        
        // Update step 2 content - show egg sprite since monsters start as eggs
        document.getElementById('selectedAvatar').className = 'selected-monster-avatar ' + selectedMonster;
        const selectedSpriteEl = document.getElementById('selectedSprite');
        selectedSpriteEl.src = monster.eggSprite;
        selectedSpriteEl.classList.add('egg-sprite');
        selectedSpriteEl.style.animation = 'none';
        selectedSpriteEl.style.objectFit = 'contain';
        selectedSpriteEl.style.transform = 'scale(2)';
        document.getElementById('selectedName').textContent = monster.name;
        document.getElementById('selectedTitle').textContent = monster.title;
        document.getElementById('selectedDescription').textContent = monster.description;
        
        const tagsContainer = document.getElementById('selectedTags');
        tagsContainer.innerHTML = '';
        monster.tags.forEach(tag => {
            const tagSpan = document.createElement('span');
            tagSpan.className = 'monster-tag ' + selectedMonster;
            tagSpan.textContent = tag;
            tagsContainer.appendChild(tagSpan);
        });
        
        // Set default name
        monsterName = monster.name;
        document.getElementById('monsterNameInput').value = monsterName;
        
        // Update continue button
        const continueBtn = document.getElementById('continueButton');
        continueBtn.disabled = false;
        continueBtn.textContent = 'Continue';
    }
    
    function selectSuggestion(suggestion) {
        monsterName = suggestion;
        document.getElementById('monsterNameInput').value = suggestion;
        
        // Highlight selected chip
        document.querySelectorAll('.suggestion-chip').forEach(chip => {
            chip.classList.remove('selected');
            if (chip.textContent === suggestion) {
                chip.classList.add('selected');
            }
        });
    }
    
    function goToStep3() {
        monsterName = document.getElementById('monsterNameInput').value.trim();
        if (!monsterName) {
            monsterName = monsters[selectedMonster].name;
        }
        
        // Hide step 2, show step 3
        document.getElementById('step2').classList.remove('active');
        document.getElementById('step3').classList.add('active');
        
        // Update step 3 content
        const monster = monsters[selectedMonster];
        document.getElementById('confirmAvatar').className = 'selected-monster-avatar ' + selectedMonster;
        
        // Show egg GIF instead of monster sprite
        const confirmSprite = document.getElementById('confirmSprite');
        confirmSprite.src = `assets/eggs/${selectedMonster}_egg.gif`;
        confirmSprite.classList.add('egg-sprite');
        // CRITICAL: Clear inline styles that override CSS class
        confirmSprite.style.animation = 'none';
        confirmSprite.style.objectFit = 'contain';
        confirmSprite.style.objectPosition = 'center';
        confirmSprite.style.width = 'auto';
        confirmSprite.style.height = 'auto';
        confirmSprite.style.transform = 'scale(2)';
        
        document.getElementById('confirmName').textContent = monsterName;
        
        // Update continue button
        const continueBtn = document.getElementById('continueButton');
        continueBtn.textContent = "Let's Go!";
        continueBtn.disabled = false;
    }
    
    function completeOnboarding() {
        console.log('[Onboarding] Completing onboarding with selectedMonster:', selectedMonster);
        
        // Save to localStorage
        localStorage.setItem('onboardingCompleted', 'true');
        localStorage.setItem('onboardingComplete', 'true'); // For mood tracker timing
        localStorage.setItem('hasChosenMonster', 'true');
        localStorage.setItem('selectedMonster', selectedMonster);
        localStorage.setItem('monsterName', monsterName);
        localStorage.setItem('rockName', monsterName);
        
        console.log('[Onboarding] Saved to localStorage - selectedMonster:', selectedMonster);
        
        // Initialize new player at Level 1 with egg state
        // TEST VERSION: Comment out level reset to preserve level 10 start
        // if (!gameState.level) {
        //     gameState.level = 1;
        //     gameState.jerryLevel = 1;
        //     gameState.jerryCurrentXP = 0;
        //     gameState.jerryTotalXP = 0;
        // }
        
        // New players start with egg (hatches at level 5)
        // TEST VERSION: Keep egg hatched at level 10
        // gameState.isEgg = true;
        gameState.consecutiveLosses = 0;
        gameState.eggRevertedAt = null;
        
        console.log('[Onboarding] Initialized new player: Level 1, isEgg = true');
        
        // Update hero sprites based on selection
        updateHeroSprites();
        
        // Hide onboarding
        document.getElementById('onboardingOverlay').classList.add('hidden');
        
        // Update hero name in the UI
        updateHeroName();
        
        // Save game state with egg status
        saveGameState();
        
        // Reload to apply changes
        window.location.reload();
    }
    
    function updateHeroSprites() {
        const spriteMap = {
            luna: 'Owlet_Monster',
            benny: 'Dude_Monster',
            nova: 'Pink_Monster'
        };
        
        const prefix = spriteMap[selectedMonster];
        console.log('[Onboarding] updateHeroSprites - selectedMonster:', selectedMonster, '-> prefix:', prefix);
        localStorage.setItem('heroSpritePrefix', prefix);
        console.log('[Onboarding] Saved heroSpritePrefix to localStorage:', prefix);
    }
    
    function updateHeroName() {
        const levelLabel = document.getElementById('levelLabel');
        if (levelLabel) {
            const level = gameState.level || 1;
            levelLabel.textContent = `${monsterName} | Level ${level}`;
        }
    }
    
    function loadSavedMonster() {
        const savedMonster = localStorage.getItem('selectedMonster');
        const savedName = localStorage.getItem('monsterName');
        
        if (savedMonster && savedName) {
            // Check if a skin is equipped - if so, skinsManager will handle visuals
            const equippedSkinId = gameState.equippedSkinId;
            
            if (!equippedSkinId) {
                // Check if monster is in egg form
                if (gameState.isEgg) {
                    // Load egg GIF
                    const mainHeroSprite = document.getElementById('mainHeroSprite');
                    if (mainHeroSprite) {
                        mainHeroSprite.src = `assets/eggs/${savedMonster}_egg.gif`;
                        mainHeroSprite.classList.add('egg-sprite');
                        // CRITICAL: Use setProperty with 'important' to override HTML !important flags
                        mainHeroSprite.style.setProperty('animation', 'none', 'important');
                        mainHeroSprite.style.setProperty('object-fit', 'contain', 'important');
                        mainHeroSprite.style.setProperty('object-position', 'center', 'important');
                        mainHeroSprite.style.setProperty('width', 'auto', 'important');
                        mainHeroSprite.style.setProperty('height', 'auto', 'important');
                        mainHeroSprite.style.setProperty('max-width', '100%', 'important');
                        mainHeroSprite.style.setProperty('max-height', '100%', 'important');
                        mainHeroSprite.style.setProperty('transform', 'scale(2)', 'important');
                        mainHeroSprite.style.setProperty('opacity', '1', 'important');
                    }
                    
                    const heroSprite = document.getElementById('heroSprite');
                    if (heroSprite) {
                        heroSprite.src = `assets/eggs/${savedMonster}_egg.gif`;
                        heroSprite.classList.add('egg-sprite');
                        heroSprite.style.animation = 'none';
                        heroSprite.style.objectFit = 'contain';
                        heroSprite.style.objectPosition = 'center';
                    }
                } else {
                    // No skin equipped, use default monster sprites
                    const spritePrefix = localStorage.getItem('heroSpritePrefix') || 'Pink_Monster';
                    
                    const mainHeroSprite = document.getElementById('mainHeroSprite');
                    if (mainHeroSprite) {
                        mainHeroSprite.src = `assets/heroes/${spritePrefix}_Idle_4.png`;
                        mainHeroSprite.classList.remove('egg-sprite');
                        // CRITICAL: Use setProperty with 'important' to override HTML !important flags
                        mainHeroSprite.style.setProperty('width', '32px', 'important');
                        mainHeroSprite.style.setProperty('height', '32px', 'important');
                        mainHeroSprite.style.setProperty('object-fit', 'none', 'important');
                        mainHeroSprite.style.setProperty('object-position', '0 0', 'important');
                        mainHeroSprite.style.setProperty('transform', 'scale(4)', 'important');
                        mainHeroSprite.style.setProperty('animation', 'none', 'important');
                        mainHeroSprite.style.setProperty('max-width', '', 'important');
                        mainHeroSprite.style.setProperty('max-height', '', 'important');
                        mainHeroSprite.style.setProperty('opacity', '1', 'important');
                    }
                    
                    const heroSprite = document.getElementById('heroSprite');
                    if (heroSprite) {
                        heroSprite.src = `assets/heroes/${spritePrefix}_Idle_4.png`;
                        heroSprite.classList.remove('egg-sprite');
                    }
                }
            }
            // If skin is equipped, skinsManager.init() will apply it
            
            // Update name
            const levelLabel = document.getElementById('levelLabel');
            if (levelLabel) {
                const level = gameState.level || 1;
                levelLabel.textContent = `${savedName} | Level ${level}`;
            }
        }
    }
    
    // Initialize onboarding
    document.addEventListener('DOMContentLoaded', function() {
        // Check if onboarding should be shown
        // NOTE: Onboarding is now handled by appInitializer.js
        // checkOnboardingStatus();
        
        // Load saved monster if exists
        // NOTE: loadSavedMonster is now called in initializeApp() AFTER loadGameState()
        // This ensures gameState.isEgg is properly set before checking monster display
        // loadSavedMonster();
        
        // Monster card click handlers
        document.getElementById('lunaCard').addEventListener('click', () => selectMonster('luna'));
        document.getElementById('bennyCard').addEventListener('click', () => selectMonster('benny'));
        document.getElementById('novaCard').addEventListener('click', () => selectMonster('nova'));
        
        // Continue button handler
        const continueBtn = document.getElementById('continueButton');
        continueBtn.addEventListener('click', function() {
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            
            if (step1.classList.contains('active')) {
                goToStep2();
            } else if (step2.classList.contains('active')) {
                goToStep3();
            } else if (step3.classList.contains('active')) {
                completeOnboarding();
            }
        });
        
        // Back button handlers
        document.getElementById('backToStep1').addEventListener('click', function() {
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
            const continueBtn = document.getElementById('continueButton');
            continueBtn.textContent = 'Continue';
            continueBtn.disabled = !selectedMonster;
        });
        
        document.getElementById('backToStep2').addEventListener('click', function() {
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            const continueBtn = document.getElementById('continueButton');
            continueBtn.textContent = 'Continue';
            continueBtn.disabled = false;
        });
        
        // Name input handler
        document.getElementById('monsterNameInput').addEventListener('input', function(e) {
            monsterName = e.target.value.trim();
        });
    });
})();

    </script>

</body>
</html>
